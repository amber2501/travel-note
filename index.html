<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…éŠè¦åŠƒ âœˆï¸</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <!-- å¼•å…¥å¯æ„›çš„åœ“é«”å­—å‹ (Zen Maru Gothic) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #89CFF0;       /* æ°´è—è‰² */
            --primary-dark: #4FC3F7;
            --secondary: #FFCC80;     /* æš–æ©˜è‰² (è³¼ç‰©ç”¨) */
            --text: #546E7A;
            --bg-color: #FAFAFA;
            --nav-height: 70px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(#E1F5FE 2px, transparent 2px);
            background-size: 20px 20px;
            color: var(--text);
            padding-bottom: calc(var(--nav-height) + 30px);
            -webkit-overflow-scrolling: touch;
        }

        .hidden { display: none !important; }

        /* --- UI å…ƒä»¶ --- */
        .btn {
            border: 2px solid var(--primary); border-radius: 20px;
            padding: 10px 20px; font-size: 1rem; font-weight: bold;
            cursor: pointer; background: white; color: var(--primary);
            box-shadow: 2px 2px 0px #B3E5FC; transition: 0.1s;
            font-family: 'Zen Maru Gothic', sans-serif;
        }
        .btn:active { transform: translate(2px, 2px); box-shadow: none; }
        
        .btn-primary { background: var(--primary); color: white; box-shadow: 3px 3px 0px #4FC3F7; }
        
        .btn-icon {
            background: transparent; border: none; font-size: 1.2rem;
            color: #CFD8DC; padding: 5px; cursor: pointer;
        }

        input, select, textarea {
            width: 100%; padding: 12px;
            border: 2px solid #E0F7FA; border-radius: 15px;
            background: #FFF; font-size: 16px; outline: none;
            margin-bottom: 12px; font-family: 'Zen Maru Gothic', sans-serif;
            color: var(--text);
        }
        input:focus { border-color: var(--primary); background: #F0FBFF; }

        /* --- ä¸»ç•«é¢ (Home) --- */
        #view-home {
            padding: 20px;
            min-height: 100vh;
        }
        .home-header {
            text-align: center; margin-bottom: 30px; margin-top: 40px;
        }
        .trip-card {
            background: white; border: 2px solid #E1F5FE; border-radius: 20px;
            padding: 20px; margin-bottom: 20px;
            box-shadow: 4px 4px 0px rgba(137, 207, 240, 0.2);
            position: relative; transition: 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .trip-card:active { transform: scale(0.98); }
        .trip-info h3 { margin: 0 0 5px 0; font-size: 1.2rem; color: var(--text); }
        .trip-info p { margin: 0; font-size: 0.9rem; color: #90A4AE; }
        
        .delete-trip-btn {
            background: #FFEBEE; color: #EF5350; border: none;
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
        }

        /* --- å…§é  Header --- */
        .sticky-header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(250, 250, 250, 0.95);
            backdrop-filter: blur(5px);
            padding-top: env(safe-area-inset-top);
            border-bottom: 2px dashed #E1F5FE;
        }
        .header-top {
            padding: 10px 15px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .header-title { font-size: 1.3rem; color: var(--primary); font-weight: 800; margin: 0; }
        .back-btn {
            background: #E1F5FE; color: var(--primary); border: none;
            padding: 5px 12px; border-radius: 12px; font-weight: bold;
            display: flex; align-items: center; gap: 5px; font-size: 0.9rem;
        }

        /* --- æ—¥æœŸæ»‘å‹• --- */
        .day-scroller {
            display: flex; overflow-x: auto;
            padding: 10px 15px; gap: 10px; scrollbar-width: none;
        }
        .day-chip {
            flex: 0 0 auto; min-width: 60px; padding: 6px 10px;
            border: 2px solid #E1F5FE; border-radius: 15px;
            background: white; text-align: center; font-size: 0.9rem;
            transition: 0.2s; box-shadow: 2px 2px 0px #E1F5FE;
        }
        .day-chip.active {
            border-color: var(--primary); background: var(--primary); color: white;
            box-shadow: 2px 2px 0px #81D4FA; transform: translate(-1px, -1px);
        }
        .day-chip span { display: block; font-size: 0.7rem; margin-top: 2px; opacity: 0.9; }

        /* --- å¡ç‰‡èˆ‡åˆ—è¡¨ --- */
        .container { padding: 15px; padding-bottom: 90px; }
        .card {
            background: white; border: 2px solid #E1F5FE; border-radius: 20px;
            padding: 15px; margin-bottom: 15px; position: relative;
            box-shadow: 3px 3px 0px rgba(137, 207, 240, 0.2);
        }

        /* æ©Ÿç¥¨å¡ç‰‡ */
        .flight-card {
            background: #E3F2FD; border: 2px dashed var(--primary);
            margin-bottom: 20px; padding: 15px 10px; border-radius: 15px;
            position: relative;
        }
        .flight-row { display: flex; justify-content: space-between; align-items: flex-end; gap: 10px; }
        .airport-input {
            width: 70px; text-align: center; font-size: 1.5rem; font-weight: 800;
            color: var(--text); background: transparent; border: none;
            text-transform: uppercase; padding: 0;
        }
        .flight-center { flex: 1; text-align: center; position: relative; bottom: 5px; }
        .flight-code-input {
            border: none; background: rgba(255,255,255,0.6); border-radius: 8px;
            text-align: center; font-size: 0.85rem; color: var(--primary);
            width: 100%; font-weight: bold; margin-bottom: 4px;
        }
        .flight-line { border-bottom: 2px dashed var(--primary); position: relative; }
        .plane-icon { position: absolute; left: 50%; top: -9px; transform: translateX(-50%); background: #E3F2FD; color: var(--primary); padding: 0 4px; }

        /* åˆ—è¡¨é …ç›® */
        .item-row { display: flex; align-items: flex-start; cursor: pointer; }
        .item-time { font-weight: 800; color: var(--primary); width: 55px; flex-shrink: 0; font-size: 1rem; padding-top: 4px; }
        .item-main { flex: 1; padding-right: 5px; }
        .item-title { font-size: 1.05rem; font-weight: 700; margin: 0 0 4px 0; color: #37474F; }
        .item-note { font-size: 0.85rem; color: #78909C; background: #F5F5F5; padding: 4px 8px; border-radius: 8px; display: inline-block; margin-top: 4px; }
        .item-loc { font-size: 0.85rem; color: var(--primary); margin-top: 4px; display: flex; align-items: center; }

        /* åœ–ç¤º */
        .icon-badge {
            display: inline-flex; align-items: center; justify-content: center;
            width: 28px; height: 28px; border-radius: 50%;
            font-size: 1.1rem; margin-right: 8px; margin-bottom: 5px;
        }
        .bg-spot { background: #FFEBEE; } .bg-food { background: #FFF3E0; }
        .bg-shop { background: #FFF8E1; } .bg-transport { background: #F3E5F5; }
        .bg-hotel { background: #E8F5E9; } .bg-other { background: #ECEFF1; }

        /* è³¼ç‰©æ¸…å–®å°ˆç”¨ */
        .shopping-card {
            border-color: #FFE0B2; background: #FFF;
            box-shadow: 3px 3px 0px #FFE0B2;
        }
        .shopping-price {
            font-size: 0.9rem; color: #FF9800; font-weight: bold;
            background: #FFF3E0; padding: 2px 8px; border-radius: 10px;
        }

        /* FAB */
        .fab {
            position: fixed; bottom: calc(var(--nav-height) + 20px); right: 20px;
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--primary); color: white;
            font-size: 28px; display: flex; align-items: center; justify-content: center;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.1); z-index: 900;
            border: 2px solid white; cursor: pointer; transition: 0.2s;
        }
        .fab:active { transform: scale(0.95); }

        /* Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white; width: 85%; max-width: 380px; padding: 25px;
            border-radius: 25px; border: 2px solid var(--primary);
            box-shadow: 5px 5px 0px #E1F5FE;
            animation: bounceIn 0.3s;
        }
        @keyframes bounceIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* åº•éƒ¨å°èˆª (æ”¹ç‚º4å€‹) */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 400px; height: 65px; background: white;
            display: flex; justify-content: space-around; align-items: center;
            border-radius: 35px; box-shadow: 0 5px 20px rgba(137, 207, 240, 0.3);
            z-index: 1000; border: 2px solid #E1F5FE;
        }
        .nav-item {
            flex: 1; text-align: center; border: none; background: none;
            color: #B0BEC5; font-size: 0.7rem; font-weight: 700;
            font-family: 'Zen Maru Gothic', sans-serif;
        }
        .nav-item.active { color: var(--primary); }
        .nav-icon { display: block; font-size: 1.4rem; margin-bottom: 2px; }

        /* Checkbox */
        .check-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 2px dashed #F0F0F0; }
        .check-item input[type="checkbox"] { width: 22px; height: 22px; margin-right: 12px; accent-color: var(--primary); }
        .check-item.checked span { text-decoration: line-through; color: #CFD8DC; }
    </style>
</head>
<body>

    <!-- 1. ä¸»ç•«é¢ (è¡Œç¨‹åˆ—è¡¨) -->
    <div id="view-home">
        <div class="home-header">
            <div style="font-size: 3.5rem;">âœˆï¸</div>
            <h1 style="color: var(--primary); margin: 10px 0;">æ—…éŠè¦åŠƒ</h1>
            <p style="color: #90A4AE;">æˆ‘çš„æ‰€æœ‰æ—…ç¨‹</p>
        </div>
        
        <div id="trip-list-container">
            <!-- JS å‹•æ…‹ç”¢ç”Ÿè¡Œç¨‹å¡ç‰‡ -->
        </div>

        <button class="fab" onclick="openCreateTripModal()">ï¼‹</button>
    </div>

    <!-- 2. è©³ç´°è¡Œç¨‹é é¢ (åŒ…å«è¡Œç¨‹/è¨˜å¸³/è³¼ç‰©/æ¸…å–®) -->
    <div id="view-detail" class="hidden">
        
        <!-- å°èˆªåˆ— -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('itinerary')">
                <span class="nav-icon">ğŸ“…</span>è¡Œç¨‹
            </button>
            <button class="nav-item" onclick="switchTab('money')">
                <span class="nav-icon">ğŸ’°</span>è¨˜å¸³
            </button>
            <button class="nav-item" onclick="switchTab('shopping')">
                <span class="nav-icon">ğŸ›ï¸</span>è³¼ç‰©
            </button>
            <button class="nav-item" onclick="switchTab('packing')">
                <span class="nav-icon">ğŸ’</span>æ¸…å–®
            </button>
        </nav>

        <!-- A. è¡Œç¨‹ Tab -->
        <div id="tab-itinerary" class="tab-content">
            <div class="sticky-header">
                <div class="header-top">
                    <button class="back-btn" onclick="goHome()">
                        <span>ğŸ </span> å›åˆ—è¡¨
                    </button>
                    <div class="header-title" id="header-title-text">æ±äº¬è¡Œ</div>
                    <div style="width:60px;"></div> <!-- ä½”ä½ç”¨ -->
                </div>
                <div class="day-scroller" id="day-tabs-itinerary"></div>
            </div>
            <div class="container">
                <div id="flight-section"></div>
                <div id="list-itinerary"></div>
            </div>
            <button class="fab" onclick="openNewItinerary()">âœï¸</button>
        </div>

        <!-- B. è¨˜å¸³ Tab -->
        <div id="tab-money" class="tab-content hidden">
            <div class="sticky-header">
                <div class="header-top">
                    <button class="back-btn" onclick="goHome()">ğŸ </button>
                    <div class="header-title">è¨˜å¸³æœ¬</div>
                    <div style="font-size:0.8rem; background:#FFF3E0; color:#F57C00; padding:4px 8px; border-radius:8px;">
                        åˆè¨ˆ: <b id="day-total">0</b>
                    </div>
                </div>
                <div class="day-scroller" id="day-tabs-money"></div>
            </div>
            <div class="container" id="list-money"></div>
            <button class="fab" onclick="openModal('money')">âœï¸</button>
        </div>

        <!-- C. è³¼ç‰© Tab (New!) -->
        <div id="tab-shopping" class="tab-content hidden">
            <div class="sticky-header">
                <div class="header-top">
                    <button class="back-btn" onclick="goHome()">ğŸ </button>
                    <div class="header-title">è³¼ç‰©æ¸…å–® ğŸ›ï¸</div>
                    <div style="width:30px;"></div>
                </div>
            </div>
            <div class="container">
                <div style="background:#FFF8E1; padding:15px; border-radius:15px; margin-bottom:20px; border:2px solid #FFE0B2;">
                    <input type="text" id="shop-input" placeholder="æƒ³è²·ä»€éº¼..." style="border-color:#FFE0B2;">
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="shop-price" placeholder="é ç®—/å‚™è¨»" style="border-color:#FFE0B2; font-size:0.9rem;">
                        <button class="btn" style="background:#FFCC80; color:white; border:none; width:auto; box-shadow:none;" onclick="addShoppingItem()">ï¼‹</button>
                    </div>
                </div>
                <div id="list-shopping"></div>
            </div>
        </div>

        <!-- D. æ¸…å–® Tab -->
        <div id="tab-packing" class="tab-content hidden">
            <div class="sticky-header">
                <div class="header-top">
                    <button class="back-btn" onclick="goHome()">ğŸ </button>
                    <div class="header-title">è¡Œå‰æ¸…å–® ğŸ’</div>
                    <div style="width:30px;"></div>
                </div>
            </div>
            <div class="container">
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <input type="text" id="pack-input" placeholder="å¸¶äº†ä»€éº¼..." style="margin:0;">
                    <button class="btn btn-primary" style="width:auto;" onclick="addPackItem()">ï¼‹</button>
                </div>
                <div id="list-packing" class="card" style="min-height:150px;"></div>
            </div>
        </div>
    </div>

    <!-- Modal: å»ºç«‹æ–°æ—…ç¨‹ -->
    <div id="modal-create-trip" class="modal hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary);">âœ¨ é–‹å•Ÿæ–°æ—…ç¨‹</h3>
            <label>æ—…ç¨‹åç¨±</label>
            <input type="text" id="new-trip-name" placeholder="ä¾‹å¦‚: äº¬éƒ½è³æ¥“">
            <label>å‡ºç™¼æ—¥æœŸ</label>
            <input type="date" id="new-trip-date">
            <label>å¤©æ•¸</label>
            <input type="number" id="new-trip-days" value="5">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn" style="flex:1; border-color:#DDD; color:#999;" onclick="closeModal('create-trip')">å–æ¶ˆ</button>
                <button class="btn btn-primary" style="flex:1;" onclick="createNewTrip()">å»ºç«‹</button>
            </div>
        </div>
    </div>

    <!-- Modal: è¡Œç¨‹æ–°å¢/ç·¨è¼¯ -->
    <div id="modal-itinerary" class="modal hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary);" id="modal-title-itinerary">âœ¨ æ–°å¢è¡Œç¨‹</h3>
            <div style="display:flex; gap:10px;">
                <input type="time" id="i-time" style="width:40%">
                <select id="i-type" style="width:60%">
                    <option value="spot">ğŸ¡ æ™¯é»</option>
                    <option value="food">ğŸ™ ç¾é£Ÿ</option>
                    <option value="shop">ğŸ è³¼ç‰©</option>
                    <option value="transport">ğŸš‹ äº¤é€š</option>
                    <option value="hotel">ğŸ›Œ ä½å®¿</option>
                    <option value="other">âœ¨ å…¶ä»–</option>
                </select>
            </div>
            <input type="text" id="i-title" placeholder="åç¨± (ä¾‹: æ¸…æ°´å¯º)">
            <input type="text" id="i-loc" placeholder="ğŸ“ åœ°é» (å¯å®šä½)">
            <textarea id="i-note" rows="2" placeholder="å‚™è¨» (è¨‚ä½è™Ÿç¢¼...)"></textarea>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn" style="flex:1; border-color:#DDD; color:#999;" onclick="closeModal('itinerary')">å–æ¶ˆ</button>
                <button class="btn btn-primary" style="flex:1;" onclick="saveItinerary()">OK!</button>
            </div>
        </div>
    </div>

    <!-- Modal: è¨˜å¸³ -->
    <div id="modal-money" class="modal hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary);">âœ¨ è¨˜ä¸€ç­†</h3>
            <input type="text" id="m-title" placeholder="é …ç›® (ä¾‹: æ‹‰éºµ)">
            <div style="display:flex; gap:10px;">
                <select id="m-curr" style="flex:0 0 80px;">
                    <option value="TWD">TWD</option>
                    <option value="JPY">JPY</option>
                    <option value="KRW">KRW</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="CNY">CNY</option>
                </select>
                <input type="number" id="m-cost" placeholder="é‡‘é¡" inputmode="decimal">
            </div>
            <select id="m-cat">
                <option value="food">ğŸ™ é£²é£Ÿ</option>
                <option value="shop">ğŸ è³¼ç‰©</option>
                <option value="transport">ğŸš‹ äº¤é€š</option>
                <option value="fun">ğŸ¡ å¨›æ¨‚</option>
                <option value="hotel">ğŸ›Œ ä½å®¿</option>
                <option value="other">âœ¨ å…¶ä»–</option>
            </select>
            <input type="text" id="m-payer" placeholder="èª°å…ˆä»˜çš„ (ä¾‹: æˆ‘)">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn" style="flex:1; border-color:#DDD; color:#999;" onclick="closeModal('money')">å–æ¶ˆ</button>
                <button class="btn btn-primary" style="flex:1;" onclick="saveMoney()">OK!</button>
            </div>
        </div>
    </div>

<script>
    // --- è³‡æ–™çµæ§‹ (æ”¯æ´å¤šæ—…ç¨‹) ---
    const DB_KEY = 'trip_v6_multi'; // æ–°çš„ Keyï¼Œé¿å…èˆŠè³‡æ–™è¡çª
    
    let allTrips = []; // å­˜æ”¾æ‰€æœ‰æ—…ç¨‹ç‰©ä»¶
    let currentTripId = null; // ç›®å‰æ­£åœ¨ç€è¦½çš„æ—…ç¨‹ ID
    let currentTrip = null; // ç›®å‰æ­£åœ¨ç€è¦½çš„æ—…ç¨‹è³‡æ–™æ·å¾‘
    
    let appState = {
        dayIdx: 0,
        editId: null
    };

    // åˆå§‹åŒ–
    window.onload = function() {
        const saved = localStorage.getItem(DB_KEY);
        if (saved) {
            try { allTrips = JSON.parse(saved); } catch(e) { console.error(e); }
        }
        renderHome();
    };

    function saveData() {
        localStorage.setItem(DB_KEY, JSON.stringify(allTrips));
    }

    // --- ä¸»ç•«é¢ (Home) é‚è¼¯ ---
    function renderHome() {
        document.getElementById('view-home').classList.remove('hidden');
        document.getElementById('view-detail').classList.add('hidden');
        
        const container = document.getElementById('trip-list-container');
        container.innerHTML = '';
        
        if (allTrips.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#B0BEC5; margin-top:50px;">é‚„æ²’æœ‰ä»»ä½•è¨ˆç•«<br>æŒ‰ä¸‹æ–¹ ï¼‹ é–‹å§‹å§ï¼</div>';
            return;
        }

        allTrips.forEach(trip => {
            const div = document.createElement('div');
            div.className = 'trip-card';
            div.onclick = () => openTrip(trip.id);
            div.innerHTML = `
                <div class="trip-info">
                    <h3>${trip.name}</h3>
                    <p>ğŸ“… ${trip.startDate} (${trip.days}å¤©)</p>
                </div>
                <button class="delete-trip-btn" onclick="deleteTrip(event, ${trip.id})">Ã—</button>
            `;
            container.appendChild(div);
        });
    }

    function openCreateTripModal() {
        document.getElementById('new-trip-name').value = '';
        document.getElementById('new-trip-date').value = '';
        document.getElementById('modal-create-trip').classList.remove('hidden');
    }

    function createNewTrip() {
        const name = document.getElementById('new-trip-name').value;
        const date = document.getElementById('new-trip-date').value;
        const days = parseInt(document.getElementById('new-trip-days').value);
        
        if (!name || !date || !days) { alert('è«‹å®Œæ•´å¡«å¯«å–”ï¼'); return; }
        
        const newTrip = {
            id: Date.now(),
            name: name,
            startDate: date,
            days: days,
            itinerary: [],
            money: [],
            shopping: [], // è³¼ç‰©æ¸…å–®
            packing: [],
            flights: {}
        };
        
        allTrips.push(newTrip);
        saveData();
        closeModal('create-trip');
        openTrip(newTrip.id); // ç›´æ¥é€²å…¥
    }

    function deleteTrip(e, id) {
        e.stopPropagation();
        if(confirm("ç¢ºå®šè¦åˆªé™¤æ•´å€‹æ—…ç¨‹å—ï¼Ÿè³‡æ–™æœƒæ¶ˆå¤±å–”ï¼")) {
            allTrips = allTrips.filter(t => t.id !== id);
            saveData();
            renderHome();
        }
    }

    // --- è©³ç´°é é¢ (Detail) é‚è¼¯ ---
    function openTrip(id) {
        currentTripId = id;
        currentTrip = allTrips.find(t => t.id === id);
        if (!currentTrip) return;
        
        // ç¢ºä¿è³‡æ–™çµæ§‹å®Œæ•´ (ç›¸å®¹æ€§)
        if(!currentTrip.shopping) currentTrip.shopping = [];
        if(!currentTrip.flights) currentTrip.flights = {};

        // UI åˆ‡æ›
        document.getElementById('view-home').classList.add('hidden');
        document.getElementById('view-detail').classList.remove('hidden');
        document.getElementById('header-title-text').innerText = currentTrip.name;
        
        // é‡ç½®ç‹€æ…‹
        appState.dayIdx = 0;
        switchTab('itinerary'); // é è¨­ç¬¬ä¸€é 
        renderAllDetail();
    }

    function goHome() {
        currentTripId = null;
        currentTrip = null;
        renderHome();
    }

    function switchTab(tabName) {
        // éš±è—æ‰€æœ‰ Tab
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById('tab-' + tabName).classList.remove('hidden');
        
        // æ›´æ–°æŒ‰éˆ•
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        // æ ¹æ“š index é»äº®
        const map = { 'itinerary':0, 'money':1, 'shopping':2, 'packing':3 };
        document.querySelectorAll('.nav-item')[map[tabName]].classList.add('active');
        
        // é‡æ–°æ¸²æŸ“è©²é 
        if(tabName === 'itinerary') renderItinerary();
        if(tabName === 'money') renderMoney();
        if(tabName === 'shopping') renderShopping();
        if(tabName === 'packing') renderPacking();
    }

    function renderAllDetail() {
        renderDayTabs('day-tabs-itinerary');
        renderDayTabs('day-tabs-money');
        renderItinerary();
    }

    // --- æ—¥æœŸè™•ç† ---
    function getDisplayDate(idx) {
        const date = new Date(currentTrip.startDate);
        date.setDate(date.getDate() + idx);
        return (date.getMonth() + 1) + '/' + date.getDate();
    }

    function renderDayTabs(containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        for (let i = 0; i < currentTrip.days; i++) {
            const btn = document.createElement('div');
            btn.className = `day-chip ${i === appState.dayIdx ? 'active' : ''}`;
            btn.innerHTML = `Day ${i+1}<span>${getDisplayDate(i)}</span>`;
            btn.onclick = () => {
                appState.dayIdx = i;
                renderAllDetail();
            };
            container.appendChild(btn);
        }
    }

    // --- æ©Ÿç¥¨èˆ‡è¡Œç¨‹ ---
    function saveFlightInput(field, val) {
        const day = appState.dayIdx;
        if(!currentTrip.flights[day]) currentTrip.flights[day] = { dep:'', arr:'', code:'' };
        currentTrip.flights[day][field] = val;
        saveData();
    }

    function openNewItinerary() {
        appState.editId = null;
        document.getElementById('modal-title-itinerary').innerText = "âœ¨ æ–°å¢è¡Œç¨‹";
        document.getElementById('i-time').value = '';
        document.getElementById('i-title').value = '';
        document.getElementById('i-loc').value = '';
        document.getElementById('i-note').value = '';
        openModal('itinerary');
    }

    function editItinerary(id) {
        const item = currentTrip.itinerary.find(i => i.id === id);
        if(!item) return;
        appState.editId = id;
        document.getElementById('modal-title-itinerary').innerText = "âœï¸ ç·¨è¼¯è¡Œç¨‹";
        document.getElementById('i-time').value = item.time;
        document.getElementById('i-type').value = item.type;
        document.getElementById('i-title').value = item.title;
        document.getElementById('i-loc').value = item.loc;
        document.getElementById('i-note').value = item.note || '';
        openModal('itinerary');
    }

    function saveItinerary() {
        const time = document.getElementById('i-time').value;
        const type = document.getElementById('i-type').value;
        const title = document.getElementById('i-title').value;
        const loc = document.getElementById('i-loc').value;
        const note = document.getElementById('i-note').value;

        if(!time || !title) { alert('å¿…å¡«å–”ï¼'); return; }

        if(appState.editId) {
            const item = currentTrip.itinerary.find(i => i.id === appState.editId);
            if(item) {
                item.time = time; item.type = type; item.title = title; item.loc = loc; item.note = note;
            }
        } else {
            currentTrip.itinerary.push({
                id: Date.now(), dayIdx: appState.dayIdx,
                time, type, title, loc, note
            });
        }
        currentTrip.itinerary.sort((a,b) => a.time.localeCompare(b.time));
        saveData();
        closeModal('itinerary');
        renderItinerary();
    }

    function renderItinerary() {
        const list = document.getElementById('list-itinerary');
        const flightSec = document.getElementById('flight-section');
        list.innerHTML = '';
        flightSec.innerHTML = '';

        // æ©Ÿç¥¨
        if(appState.dayIdx === 0 || appState.dayIdx === currentTrip.days - 1) {
            const f = currentTrip.flights[appState.dayIdx] || { dep:'', arr:'', code:'' };
            flightSec.innerHTML = `
                <div class="flight-card">
                    <div class="flight-row">
                        <input class="airport-input" placeholder="TPE" value="${f.dep}" oninput="saveFlightInput('dep', this.value.toUpperCase())" maxlength="3">
                        <div class="flight-center">
                            <input class="flight-code-input" placeholder="èˆªç­ä»£è™Ÿ" value="${f.code}" oninput="saveFlightInput('code', this.value.toUpperCase())">
                            <div class="flight-line"><span class="plane-icon">âœˆ</span></div>
                        </div>
                        <input class="airport-input" placeholder="NRT" value="${f.arr}" oninput="saveFlightInput('arr', this.value.toUpperCase())" maxlength="3">
                    </div>
                </div>
            `;
        }

        // åˆ—è¡¨
        const items = currentTrip.itinerary.filter(i => i.dayIdx === appState.dayIdx);
        if(items.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#CFD8DC; padding:30px;">ğŸƒ ç©ºç©ºçš„</div>';
            return;
        }

        const iconMap = { spot:'ğŸ¡', food:'ğŸ™', shop:'ğŸ', transport:'ğŸš‹', hotel:'ğŸ›Œ', other:'âœ¨' };
        const bgMap = { spot:'bg-spot', food:'bg-food', shop:'bg-shop', transport:'bg-transport', hotel:'bg-hotel', other:'bg-other' };

        items.forEach(item => {
            const locLink = item.loc ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.loc)}" target="_blank" class="item-loc" onclick="event.stopPropagation()">ğŸ“ ${item.loc}</a>` : '';
            const noteBlock = item.note ? `<div class="item-note">ğŸ“ ${item.note}</div>` : '';
            
            list.innerHTML += `
                <div class="card item-row" onclick="editItinerary(${item.id})">
                    <div class="item-time">${item.time}</div>
                    <div class="item-main">
                        <div style="display:flex; align-items:center;">
                            <span class="icon-badge ${bgMap[item.type] || 'bg-other'}">${iconMap[item.type]}</span>
                            <div class="item-title">${item.title}</div>
                        </div>
                        ${locLink} ${noteBlock}
                    </div>
                    <button class="btn-icon" onclick="delItem(event, 'itinerary', ${item.id})">Ã—</button>
                </div>
            `;
        });
    }

    // --- è¨˜å¸³ ---
    function saveMoney() {
        const title = document.getElementById('m-title').value;
        const cost = document.getElementById('m-cost').value;
        const curr = document.getElementById('m-curr').value;
        const type = document.getElementById('m-cat').value;
        const payer = document.getElementById('m-payer').value;

        if(!title || !cost) return alert('å¿…å¡«å–”');

        currentTrip.money.push({
            id: Date.now(), dayIdx: appState.dayIdx,
            title, cost: parseFloat(cost), curr, type, payer
        });
        saveData();
        closeModal('money');
        renderMoney();
        
        document.getElementById('m-title').value = '';
        document.getElementById('m-cost').value = '';
    }

    function renderMoney() {
        const list = document.getElementById('list-money');
        list.innerHTML = '';
        const items = currentTrip.money.filter(i => i.dayIdx === appState.dayIdx);
        let total = 0;
        
        items.forEach(i => total += i.cost);
        [...items].reverse().forEach(item => {
            const iconMap = { food:'ğŸ™', shop:'ğŸ', transport:'ğŸš‹', fun:'ğŸ¡', hotel:'ğŸ›Œ', other:'âœ¨' };
            const payer = item.payer ? `<span style="font-size:0.8rem; color:#CFD8DC;">(${item.payer})</span>` : '';
            
            list.innerHTML += `
                <div class="card item-row" style="align-items:center;">
                    <div class="item-main" style="display:flex; align-items:center;">
                        <span class="icon-badge bg-other">${iconMap[item.type]||'âœ¨'}</span>
                        <div class="item-title" style="margin:0;">${item.title} ${payer}</div>
                    </div>
                    <div style="text-align:right; font-weight:bold; color:#546E7A;">
                        <span style="font-size:0.8rem; color:#90A4AE;">${item.curr}</span> ${item.cost}
                        <button class="btn-icon" onclick="delItem(event, 'money', ${item.id})">Ã—</button>
                    </div>
                </div>
            `;
        });
        document.getElementById('day-total').innerText = total.toLocaleString();
    }

    // --- è³¼ç‰©æ¸…å–® (New) ---
    function addShoppingItem() {
        const input = document.getElementById('shop-input');
        const price = document.getElementById('shop-price');
        if(!input.value.trim()) return;

        currentTrip.shopping.push({
            id: Date.now(), text: input.value, price: price.value, checked: false
        });
        saveData();
        input.value = ''; price.value = '';
        renderShopping();
    }

    function renderShopping() {
        const list = document.getElementById('list-shopping');
        list.innerHTML = '';
        if(currentTrip.shopping.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#CFD8DC; margin-top:30px;">é‚„æ²’æœ‰æƒ³è²·çš„æ±è¥¿</div>';
            return;
        }

        currentTrip.shopping.forEach(item => {
            const priceTag = item.price ? `<span class="shopping-price">${item.price}</span>` : '';
            list.innerHTML += `
                <div class="card item-row shopping-card">
                    <div class="check-item ${item.checked?'checked':''}" style="border:none; width:100%;">
                        <input type="checkbox" ${item.checked?'checked':''} onchange="toggleCheck('shopping', ${item.id})">
                        <div style="flex:1;">
                            <div style="font-weight:bold; color:#5D4037;">${item.text}</div>
                            ${priceTag}
                        </div>
                        <button class="btn-icon" onclick="delItem(event, 'shopping', ${item.id})">Ã—</button>
                    </div>
                </div>
            `;
        });
    }

    // --- æ‰“åŒ…æ¸…å–® ---
    function addPackItem() {
        const input = document.getElementById('pack-input');
        if(!input.value.trim()) return;
        currentTrip.packing.push({ id: Date.now(), text: input.value, checked: false });
        saveData();
        input.value = '';
        renderPacking();
    }

    function renderPacking() {
        const list = document.getElementById('list-packing');
        list.innerHTML = '';
        currentTrip.packing.forEach(item => {
            list.innerHTML += `
                <div class="check-item ${item.checked?'checked':''}">
                    <input type="checkbox" ${item.checked?'checked':''} onchange="toggleCheck('packing', ${item.id})">
                    <span style="flex:1;">${item.text}</span>
                    <button class="btn-icon" onclick="delItem(event, 'packing', ${item.id})">Ã—</button>
                </div>
            `;
        });
    }

    // --- é€šç”¨åŠŸèƒ½ ---
    function toggleCheck(type, id) {
        const item = currentTrip[type].find(i => i.id === id);
        if(item) {
            item.checked = !item.checked;
            saveData();
            if(type==='shopping') renderShopping(); else renderPacking();
        }
    }

    function delItem(e, type, id) {
        e.stopPropagation();
        if(!confirm('è¦åˆªé™¤å—ï¼Ÿ')) return;
        currentTrip[type] = currentTrip[type].filter(i => i.id !== id);
        saveData();
        if(type==='itinerary') renderItinerary();
        if(type==='money') renderMoney();
        if(type==='shopping') renderShopping();
        if(type==='packing') renderPacking();
    }

    function closeModal(type) { document.getElementById('modal-'+type).classList.add('hidden'); }
    function openModal(type) { document.getElementById('modal-'+type).classList.remove('hidden'); }

</script>
</body>
</html>
