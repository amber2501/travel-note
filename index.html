
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÊóÖÈÅäÊâãÂ∏≥ Ultimate 5.9 ‚òÅÔ∏è</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <!-- Â≠óÈ´î -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Ê†∏ÂøÉËâ≤Á≥ª */
            --primary: #7FA9BE;        
            --primary-light: #F0F7FA;  
            --primary-dark: #5A8296;   
            --accent: #E89E9B;         
            --accent-bg: #FFF5F5;      
            --text: #4A5568;           
            --text-light: #A0AEC0;     
            --text-done: #CBD5E0; 
            --bg-body: #F7F9FC;        
            --card-bg: #FFFFFF;        
            --nav-height: 75px;
            --radius-L: 24px;
            --radius-M: 16px;
            --radius-S: 12px;
            --shadow-card: 0 4px 20px rgba(148, 163, 184, 0.1);
            --shadow-float: 0 8px 30px rgba(127, 169, 190, 0.4);

            /* Ë°åÁ®ãÈ°ûÂà•È°èËâ≤ */
            --c-spot-bg: #EBF8FF; --c-spot-line: #4299E1; --c-spot-icon: #3182CE;
            --c-food-bg: #FFFAF0; --c-food-line: #ED8936; --c-food-icon: #DD6B20;
            --c-shop-bg: #FFF5F7; --c-shop-line: #ED64A6; --c-shop-icon: #D53F8C;
            --c-trans-bg:#F0FFF4; --c-trans-line:#48BB78; --c-trans-icon: #38A169;
            --c-other-bg:#F7FAFC; --c-other-line:#718096; --c-other-icon: #4A5568;
            --c-ticket-bg: #FFFFF0; --c-ticket-line: #ECC94B;
            --c-chart-bg:  #F3F0FF; --c-chart-line:  #9F7AEA;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--bg-body);
            color: var(--text);
            padding-bottom: calc(var(--nav-height) + 40px);
            -webkit-overflow-scrolling: touch;
        }

        .hidden { display: none !important; }

        /* --- SVG ÂúñÁ§∫Á≥ªÁµ± --- */
        .icon-svg { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; pointer-events: none; transition: 0.3s; }
        .icon-sm { width: 18px; height: 18px; stroke-width: 2; }
        .icon-xs { width: 14px; height: 14px; stroke-width: 2; }
        
        /* --- UI ÂÖÉ‰ª∂ --- */
        .btn {
            border: none; border-radius: var(--radius-M);
            padding: 10px 20px; font-size: 0.95rem; font-weight: 700;
            cursor: pointer; background: white; color: var(--primary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            font-family: inherit;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { 
            background: var(--primary); color: white; 
            box-shadow: 0 4px 15px rgba(127, 169, 190, 0.4); 
        }
        .btn-ghost { background: transparent; box-shadow: none; color: var(--text-light); padding: 5px; cursor: pointer; border: none;}
        .btn-del { color: var(--accent); background: var(--accent-bg); padding: 6px 14px; font-size: 0.85rem; border: none; border-radius: 12px; font-weight: bold; cursor: pointer;}
        .btn-edit { color: var(--primary); background: var(--primary-light); padding: 6px 14px; font-size: 0.85rem; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-right: 8px;}

        input, select, textarea {
            width: 100%; padding: 12px 16px;
            border: 1px solid transparent; border-radius: var(--radius-S);
            background: #EDF2F7; font-size: 15px; outline: none;
            margin-bottom: 12px; font-family: inherit; font-weight: 500;
            color: var(--text); transition: 0.2s;
            appearance: none; -webkit-appearance: none;
        }
        input[type="date"], input[type="time"] { min-height: 44px; display: block; }
        input:focus, textarea:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(127, 169, 190, 0.15); }
        
        .row { display: flex; gap: 12px; width: 100%; }
        .col { flex: 1; min-width: 0; }

        /* Header */
        .sticky-header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(247, 249, 252, 0.95);
            backdrop-filter: blur(12px);
            padding-top: env(safe-area-inset-top);
            border-bottom: 1px solid rgba(0,0,0,0.03);
        }
        .header-top { padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; }
        .header-title { font-size: 1.3rem; color: var(--text); font-weight: 900; letter-spacing: 0.5px; }
        .back-btn { background: transparent; color: var(--text-light); border: none; font-weight: bold; display: flex; align-items: center; gap: 5px; font-size: 0.9rem;}

        /* Capsule Tabs */
        .sub-nav { display: flex; padding: 0 20px 15px; gap: 10px; overflow-x: auto; scrollbar-width: none; }
        .sub-nav-btn {
            flex: 0 0 auto; padding: 8px 18px;
            border: 1px solid transparent; background: white; border-radius: 30px;
            font-size: 0.9rem; color: var(--text-light); font-weight: 700;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04); transition: 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .sub-nav-btn.active {
            background: var(--primary); color: white; 
            box-shadow: 0 4px 12px rgba(127, 169, 190, 0.3); transform: translateY(-1px);
        }

        /* Container & Cards */
        .container { padding: 20px; padding-bottom: 100px; max-width: 600px; margin: 0 auto; }
        .card {
            background: var(--card-bg); border-radius: var(--radius-L);
            padding: 20px; margin-bottom: 20px; 
            box-shadow: var(--shadow-card);
            position: relative; border: 1px solid rgba(255,255,255,0.6);
        }
        .card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 15px; color: var(--primary-dark); font-weight: 800; font-size: 1.1rem; }
        .card-label { font-size: 0.8rem; color: var(--text-light); font-weight: 700; margin-bottom: 6px; display: block; margin-left: 4px;}

        /* Info Cards */
        .info-card-item {
            background: #FFFFFF; border-radius: var(--radius-M);
            padding: 16px; margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            border: 1px solid #F0F0F0; display: flex; justify-content: space-between; align-items: center;
            gap: 15px; 
        }
        .info-card-content { flex: 1; min-width: 0; }
        .info-card-title { font-weight: bold; color: var(--text); font-size: 1rem; margin-bottom: 4px; }
        .info-card-sub { font-size: 0.85rem; color: var(--text-light); display: flex; gap: 8px; align-items: center; flex-wrap: wrap;}

        /* Boarding Pass */
        .bp-card {
            background: white; border-radius: var(--radius-M);
            margin-bottom: 25px; overflow: hidden; position: relative;
            box-shadow: var(--shadow-card);
            filter: drop-shadow(0 4px 10px rgba(0,0,0,0.05));
            mask-image: radial-gradient(circle at 0px 50%, transparent 8px, black 8.5px), radial-gradient(circle at 100% 50%, transparent 8px, black 8.5px);
            -webkit-mask-image: radial-gradient(circle at 0px 50%, transparent 8px, black 8.5px), radial-gradient(circle at 100% 50%, transparent 8px, black 8.5px);
        }
        .bp-header { background: var(--primary); color: white; padding: 10px; text-align: center; font-size: 0.9rem; font-weight: bold; letter-spacing: 2px;}
        .bp-body { padding: 20px 15px; display: flex; justify-content: space-between; align-items: center; }
        .bp-group { text-align: center; flex: 1; }
        .bp-code { font-size: 2rem; font-weight: 900; color: var(--text); display: block; line-height: 1; margin-bottom: 5px;}
        .bp-time { font-size: 0.9rem; color: var(--text); font-weight: bold; background: #F0F4F8; padding: 4px 8px; border-radius: 6px; display: inline-block;}
        .bp-center { display: flex; flex-direction: column; align-items: center; width: 90px; }
        .bp-line { width: 100%; height: 2px; background: #E0E0E0; position: relative; margin: 10px 0; }
        .bp-line::after { content:''; position:absolute; top:-10px; left:50%; transform:translateX(-50%); width:20px; height:20px; background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%237FA9BE'%3E%3Cpath d='M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z'/%3E%3C/svg%3E") no-repeat center; background-size:contain; background-color:white; padding:0 2px;} 
        .bp-duration { font-size: 0.75rem; color: var(--text-light); font-weight: bold; margin-top: 4px; }
        .tz-select { width: auto; padding: 6px; font-size: 0.8rem; background: #eef2f5; border: 1px solid #ddd; border-radius: 6px; margin-left: 5px; font-weight:bold; height: 44px;}

        /* Countdown Banner */
        .countdown-banner {
            background: linear-gradient(120deg, var(--primary-dark), var(--primary));
            color: white; border-radius: var(--radius-L);
            padding: 15px 20px; text-align: center; margin-bottom: 25px;
            box-shadow: 0 10px 25px rgba(127, 169, 190, 0.4);
            position: relative; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .countdown-banner::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 60%);
            animation: pulseSlow 4s infinite ease-in-out; pointer-events: none;
        }
        @keyframes pulseSlow { 0% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 0.5; } }
        .countdown-num { font-size: 2.5rem; font-weight: 900; line-height: 1; text-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; z-index: 2; margin-bottom: 2px;}
        .countdown-label { font-size: 0.8rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-top: 2px; opacity: 0.9; position: relative; z-index: 2;}

        /* Weather Card */
        .weather-card {
            border-radius: var(--radius-L); padding: 25px 20px; margin-bottom: 25px;
            background: white;
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(255,255,255,0.8);
            position: relative; overflow: hidden;
        }
        .weather-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #F0F8FF 0%, #FFFFFF 100%);
            z-index: 0;
        }
        .w-top-row { display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .w-loc-group { display: flex; flex-direction: column; }
        .w-city { font-weight: 800; font-size: 1.1rem; color: var(--text); }
        .w-desc { font-size: 0.9rem; color: var(--text-light); display: flex; align-items: center; gap: 6px; margin-top: 4px; font-weight: bold;}
        .w-main-temp { font-size: 3rem; font-weight: 900; color: var(--text); line-height: 1; }
        .w-main-temp span { font-size: 1.5rem; font-weight: 300; vertical-align: top; }
        
        .w-grid { position: relative; z-index: 1; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .w-stat { background: rgba(255,255,255,0.7); border-radius: 16px; padding: 10px 5px; text-align: center; border: 1px solid #F0F4F8; }
        .w-stat-label { font-size: 0.7rem; color: var(--text-light); margin-bottom: 4px; font-weight: bold; }
        .w-stat-val { font-size: 0.9rem; color: var(--text); font-weight: 800; }
        .w-stat-sub { font-size: 0.7rem; color: var(--text-light); }

        /* Checkbox Style */
        .check-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #FAFAFA; transition: 0.2s; }
        .check-box { width: 22px; height: 22px; border: 2px solid var(--primary); border-radius: 6px; margin-right: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; transition: 0.2s; background:white;}
        .checked .check-box { background: var(--primary); }
        .checked .check-box::after { content: '‚úì'; color: white; font-size: 14px; font-weight: bold; }
        .checked span, .checked .shop-text-content { text-decoration: line-through; color: var(--text-done); opacity: 0.7; }

        /* Timeline */
        .day-scroller { display: flex; overflow-x: auto; padding: 10px 20px; gap: 10px; scrollbar-width: none; }
        .day-chip { 
            flex: 0 0 auto; padding: 10px 18px; border-radius: 20px; min-width: 70px;
            background: white; border: 1px solid #EDF2F7; color: var(--text-light); 
            text-align: center; font-size: 0.85rem; font-weight: bold; transition: 0.2s; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
        }
        .day-chip span.day-idx { font-size: 0.75rem; color: var(--primary); letter-spacing: 1px; }
        .day-chip span.date { font-size: 0.9rem; color: var(--text); }
        .day-chip.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(127, 169, 190, 0.4); transform: scale(1.05); }
        .day-chip.active span.day-idx, .day-chip.active span.date { color: white; }

        .timeline-wrapper { position: relative; padding-left: 10px; margin-top: 20px; padding-bottom: 20px;}
        .timeline-line { position: absolute; left: 38px; top: 15px; bottom: 15px; width: 2px; background: #E2E8F0; z-index: 0; border-radius: 2px; }
        .timeline-item { display: flex; gap: 15px; margin-bottom: 24px; position: relative; z-index: 1; align-items: flex-start; }
        
        .time-bubble {
            flex-shrink: 0; width: 56px; text-align: center; background: white; color: var(--primary-dark);
            border-radius: 12px; padding: 8px 0; font-weight: 800; font-size: 0.9rem; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: flex; flex-direction: column; justify-content: center;
            border: 1px solid #EDF2F7; z-index: 2;
        }
        
        .trans-label { font-size: 0.65rem; color: var(--text-light); margin-bottom: 0px; font-weight: normal; }
        .trans-time { font-size: 0.85rem; font-weight: 900; color: var(--primary-dark); }
        .trans-divider { margin: 4px 0; border-top: 1px solid #EDF2F7; width: 70%; margin-left: auto; margin-right: auto; }

        .it-card {
            flex: 1; background: white; border-radius: 18px; padding: 18px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.02);
            display: flex; align-items: flex-start; gap: 14px; transition: 0.1s; position: relative;
            overflow: hidden;
        }
        .it-card:active { transform: scale(0.98); }
        
        /* È°ûÂà•È°èËâ≤ÁæéÂåñ */
        .type-spot { background-color: var(--c-spot-bg); border-left: 4px solid var(--c-spot-line); }
        .type-spot .it-icon { background: white; color: var(--c-spot-icon); }
        .type-food { background-color: var(--c-food-bg); border-left: 4px solid var(--c-food-line); }
        .type-food .it-icon { background: white; color: var(--c-food-icon); }
        .type-shop { background-color: var(--c-shop-bg); border-left: 4px solid var(--c-shop-line); }
        .type-shop .it-icon { background: white; color: var(--c-shop-icon); }
        .type-transport { background-color: var(--c-trans-bg); border-left: 4px solid var(--c-trans-line); }
        .type-transport .it-icon { background: white; color: var(--c-trans-icon); }
        .type-other { background-color: var(--c-other-bg); border-left: 4px solid var(--c-other-line); }
        .type-other .it-icon { background: white; color: var(--c-other-icon); }
        .type-ticket { background-color: var(--c-ticket-bg); border-left: 4px solid var(--c-ticket-line); }
        .type-charter { background-color: var(--c-chart-bg); border-left: 4px solid var(--c-chart-line); }

        .it-icon { 
            width: 36px; height: 36px; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; 
            flex-shrink: 0; margin-top: 0px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }

        .it-actions { display: flex; flex-direction: column; gap: 8px; margin-left: auto; justify-content: flex-start; align-items: center;}
        
        /* Map Pin Icon */
        .btn-map-icon { 
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; 
            border-radius: 50%; background: white; color: #4299E1; border: 1px solid #E2E8F0; padding: 0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .btn-map-icon:active { transform: scale(0.9); background: #4299E1; color: white;}

        .night-stay-box {
            margin-top: 30px; background: #2D3748; color: white;
            border-radius: var(--radius-M); padding: 15px;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 10px 20px rgba(45, 55, 72, 0.3);
        }

        /* Money List Compact Style */
        .money-item-compact {
            background: white; border-radius: 12px; padding: 12px 16px; margin-bottom: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04); border: 1px solid #F0F4F8;
            display: flex; align-items: center; justify-content: space-between;
        }
        .money-meta { font-size: 0.75rem; color: var(--text-light); display: flex; align-items: center; gap: 6px; margin-top: 3px; }

        /* Bottom Nav & FAB */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; height: 70px; background: rgba(255,255,255,0.95);
            backdrop-filter: blur(15px);
            display: flex; justify-content: space-around; align-items: center;
            border-radius: 35px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 1000; border: 1px solid rgba(255,255,255,0.5);
        }
        .nav-item { flex: 1; border: none; background: none; color: #C4C8D0; font-size: 0.75rem; font-weight: 700; display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 10px 0; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        
        .fab { 
            position: fixed; bottom: 100px; right: 20px; 
            width: 56px; height: 56px; border-radius: 50%; 
            background: var(--primary); color: white; border: none;
            display: flex; align-items: center; justify-content: center; 
            box-shadow: var(--shadow-float); z-index: 900; cursor: pointer;
            transition: 0.3s; 
        }
        .fab:hover { transform: scale(1.1) rotate(90deg); }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 88%; max-width: 380px; padding: 25px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: modalUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); max-height: 90vh; overflow-y: auto;}
        @keyframes modalUp { from { opacity: 0; transform: translateY(20px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }

        .chip-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        .chip-btn { padding: 8px 16px; border-radius: 20px; background: #F2F4F6; color: var(--text-light); border: none; font-weight: bold; font-size: 0.85rem; cursor: pointer;}
        .chip-btn.active { background: var(--primary); color: white; }

        /* Lists */
        .item-list-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #F5F5F5; }
        .item-list-row:last-child { border-bottom: none; }
        .item-icon-box { width: 44px; height: 44px; border-radius: 12px; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; margin-right: 0; flex-shrink: 0; }
    </style>
</head>
<body>

    <!-- SVG Icons -->
    <svg style="display:none;">
        <symbol id="icon-plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V6M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2"></path></symbol>
        <symbol id="icon-pin" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></symbol>
        <symbol id="icon-phone" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></symbol>
        <symbol id="icon-camera" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></symbol>
        <symbol id="icon-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></symbol>
        <symbol id="icon-map-pin" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></symbol>
        <symbol id="icon-clock" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></symbol>
        <symbol id="icon-user" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></symbol>
        <symbol id="icon-chart-bar" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></symbol>
        <symbol id="icon-note" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></symbol>
        
        <symbol id="icon-nav-cal" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></symbol>
        <symbol id="icon-nav-money" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></symbol>
        <symbol id="icon-nav-shop" viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></symbol>
        <symbol id="icon-nav-info" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></symbol>
        <symbol id="icon-plane-real" viewBox="0 0 24 24"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"></path></symbol>
        <symbol id="icon-house" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></symbol>
        <symbol id="icon-ticket" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2"></rect><circle cx="12" cy="12" r="2"></circle><path d="M6 12h.01M18 12h.01"></path></symbol>
        <symbol id="icon-pack" viewBox="0 0 24 24"><rect x="3" y="6" width="18" height="14" rx="2"></rect><path d="M16 2v4"></path><path d="M8 2v4"></path><path d="M3 10h18"></path></symbol>
        <symbol id="icon-car" viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"></path></symbol>
        <symbol id="icon-spot" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></symbol>
        <symbol id="icon-food" viewBox="0 0 24 24"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></symbol>
        <symbol id="icon-transport" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="8" y1="21" x2="8" y2="21.01"></line><line x1="16" y1="21" x2="16" y2="21.01"></line><line x1="3" y1="10" x2="21" y2="10"></line><path d="M8 15h.01"></path><path d="M16 15h.01"></path></symbol>
        <symbol id="icon-star" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></symbol>
        <symbol id="icon-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></symbol>
        <symbol id="icon-rain" viewBox="0 0 24 24"><line x1="16" y1="13" x2="16" y2="21"></line><line x1="8" y1="13" x2="8" y2="21"></line><line x1="12" y1="15" x2="12" y2="23"></line><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path></symbol>
        <symbol id="icon-cloud" viewBox="0 0 24 24"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></symbol>
        <symbol id="icon-list-simple" viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></symbol>
        <symbol id="icon-chart-pie" viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></symbol>
    </svg>

    <!-- 1. ‰∏ªÁï´Èù¢ -->
    <div id="view-home">
        <div style="text-align:center; padding-top:80px; padding-bottom:50px;">
            <div style="font-size:3rem; margin-bottom:10px;">‚òÅÔ∏è</div>
            <h1 style="color:var(--primary-dark); margin:0; font-size:2rem; letter-spacing:1px;">ÊóÖÈÅäÊâãÂ∏≥</h1>
            <p style="color:var(--text-light); font-size:0.9rem; margin-top:5px;">Travel Log 5.9</p>
        </div>
        <div id="trip-list-container" class="container"></div>
        <button class="fab" onclick="openCreateTripModal()">
            <svg class="icon-svg"><use href="#icon-plus"></use></svg>
        </button>
    </div>

    <!-- 2. ÂÖßÈ†Å -->
    <div id="view-detail" class="hidden">
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('info')">
                <svg class="icon-svg"><use href="#icon-nav-info"></use></svg> Ë°åÂâç
            </button>
            <button class="nav-item" onclick="switchTab('itinerary')">
                <svg class="icon-svg"><use href="#icon-nav-cal"></use></svg> Ë°åÁ®ã
            </button>
            <button class="nav-item" onclick="switchTab('money')">
                <svg class="icon-svg"><use href="#icon-nav-money"></use></svg> Ë®òÂ∏≥
            </button>
            <button class="nav-item" onclick="switchTab('shopping')">
                <svg class="icon-svg"><use href="#icon-nav-shop"></use></svg> Ê∏ÖÂñÆ
            </button>
        </nav>

        <!-- A. Ë°åÂâçÊ∫ñÂÇô -->
        <div id="tab-info" class="tab-content">
            <div class="sticky-header">
                <div class="header-top">
                    <button class="back-btn" onclick="goHome()">‚óÄ ÂàóË°®</button>
                    <div class="header-title">Ë°åÂâçË¶èÂäÉ</div>
                    <div style="width:50px;"></div>
                </div>
                <div class="sub-nav">
                    <button class="sub-nav-btn active" onclick="switchInfoSub('flight')"><svg class="icon-svg icon-sm"><use href="#icon-plane-real"></use></svg> Ê©üÁ•®</button>
                    <button class="sub-nav-btn" onclick="switchInfoSub('hotel')"><svg class="icon-svg icon-sm"><use href="#icon-house"></use></svg> ‰ΩèÂÆø</button>
                    <button class="sub-nav-btn" onclick="switchInfoSub('ticket')"><svg class="icon-svg icon-sm"><use href="#icon-ticket"></use></svg> ÈñÄÁ•®</button>
                    <button class="sub-nav-btn" onclick="switchInfoSub('charter')"><svg class="icon-svg icon-sm"><use href="#icon-car"></use></svg> ÂåÖËªä</button>
                    <button class="sub-nav-btn" onclick="switchInfoSub('packing')"><svg class="icon-svg icon-sm"><use href="#icon-pack"></use></svg> Ë°åÊùé</button>
                </div>
            </div>
            
            <div class="container">
                <!-- 1. Ê©üÁ•® -->
                <div id="info-flight" class="info-sub-tab">
                    <!-- ÂÄíÊï∏Ë®àÊôÇÂçÄ -->
                    <div id="countdown-area" class="countdown-banner hidden">
                        <div class="countdown-num" id="countdown-val">0</div>
                        <div class="countdown-label">ÂÄíÊï∏Â§©Êï∏</div>
                    </div>

                    <div class="card">
                        <div class="card-header"><svg class="icon-svg"><use href="#icon-plane-real"></use></svg> ÂéªÁ®ã Outbound</div>
                        <div class="flight-edit-block">
                            <span class="card-label">Ëà™Áè≠Ëôü / Ëà™Á©∫</span>
                            <div class="row">
                                <input class="col" placeholder="Ëà™Áè≠" oninput="saveFlight('out', 'code', this.value)" id="f-out-code">
                                <input class="col" placeholder="Ëà™Á©∫" oninput="saveFlight('out', 'airline', this.value)" id="f-out-airline">
                            </div>
                            <span class="card-label">Ëµ∑È£õ (Áï∂Âú∞ÊôÇÈñì + ÊôÇÂçÄ)</span>
                            <div class="row" style="align-items:center;">
                                <input type="time" class="col" oninput="saveFlight('out', 'depTime', this.value)" id="f-out-depTime">
                                <select class="tz-select" onchange="saveFlight('out', 'depTz', this.value)" id="f-out-depTz"><option value="8">UTC+8</option><option value="9">UTC+9</option><option value="1">UTC+1</option><option value="-7">UTC-7</option><option value="0">UTC+0</option></select>
                                <input class="col" placeholder="TPE" oninput="saveFlight('out', 'depAir', this.value)" id="f-out-depAir">
                            </div>
                            <span class="card-label">ÈôçËêΩ (Áï∂Âú∞ÊôÇÈñì + ÊôÇÂçÄ)</span>
                            <div class="row" style="align-items:center;">
                                <input type="time" class="col" oninput="saveFlight('out', 'arrTime', this.value)" id="f-out-arrTime">
                                <select class="tz-select" onchange="saveFlight('out', 'arrTz', this.value)" id="f-out-arrTz"><option value="8">UTC+8</option><option value="9" selected>UTC+9</option><option value="1">UTC+1</option><option value="-7">UTC-7</option><option value="0">UTC+0</option></select>
                                <input class="col" placeholder="NRT" oninput="saveFlight('out', 'arrAir', this.value)" id="f-out-arrAir">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><svg class="icon-svg" style="transform: rotate(180deg);"><use href="#icon-plane-real"></use></svg> ÂõûÁ®ã Inbound</div>
                        <div class="flight-edit-block">
                            <span class="card-label">Ëà™Áè≠Ëôü / Ëà™Á©∫</span>
                            <div class="row">
                                <input class="col" placeholder="Ëà™Áè≠" oninput="saveFlight('in', 'code', this.value)" id="f-in-code">
                                <input class="col" placeholder="Ëà™Á©∫" oninput="saveFlight('in', 'airline', this.value)" id="f-in-airline">
                            </div>
                            <span class="card-label">Ëµ∑È£õ (Áï∂Âú∞ÊôÇÈñì + ÊôÇÂçÄ)</span>
                            <div class="row" style="align-items:center;">
                                <input type="time" class="col" oninput="saveFlight('in', 'depTime', this.value)" id="f-in-depTime">
                                <select class="tz-select" onchange="saveFlight('in', 'depTz', this.value)" id="f-in-depTz"><option value="9" selected>UTC+9</option><option value="8">UTC+8</option><option value="1">UTC+1</option><option value="-7">UTC-7</option><option value="0">UTC+0</option></select>
                                <input class="col" placeholder="Ê©üÂ†¥‰ª£Á¢º" oninput="saveFlight('in', 'depAir', this.value)" id="f-in-depAir">
                            </div>
                            <span class="card-label">ÈôçËêΩ (Áï∂Âú∞ÊôÇÈñì + ÊôÇÂçÄ)</span>
                            <div class="row" style="align-items:center;">
                                <input type="time" class="col" oninput="saveFlight('in', 'arrTime', this.value)" id="f-in-arrTime">
                                <select class="tz-select" onchange="saveFlight('in', 'arrTz', this.value)" id="f-in-arrTz"><option value="8">UTC+8</option><option value="9">UTC+9</option><option value="1">UTC+1</option><option value="-7">UTC-7</option><option value="0">UTC+0</option></select>
                                <input class="col" placeholder="Ê©üÂ†¥‰ª£Á¢º" oninput="saveFlight('in', 'arrAir', this.value)" id="f-in-arrAir">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. ‰ΩèÂÆø -->
                <div id="info-hotel" class="info-sub-tab hidden">
                    <div id="hotel-list"></div>
                    <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="openHotelModal()">
                        <svg class="icon-svg icon-sm"><use href="#icon-plus"></use></svg> Êñ∞Â¢û‰ΩèÂÆø
                    </button>
                </div>

                <!-- 3. ÈñÄÁ•® -->
                <div id="info-ticket" class="info-sub-tab hidden">
                    <div id="ticket-list"></div>
                    <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="openTicketModal()">
                        <svg class="icon-svg icon-sm"><use href="#icon-plus"></use></svg> Êñ∞Â¢ûÁ•®Âà∏
                    </button>
                </div>

                <!-- 4. ÂåÖËªä -->
                <div id="info-charter" class="info-sub-tab hidden">
                    <div id="charter-list"></div>
                    <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="openCharterModal()">
                        <svg class="icon-svg icon-sm"><use href="#icon-plus"></use></svg> Êñ∞Â¢ûÂåÖËªä/Êé•ÈÄÅ
                    </button>
                </div>

                <!-- 5. Ê∏ÖÂñÆ -->
                <div id="info-packing" class="info-sub-tab hidden">
                    <div class="card">
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="pack-input" placeholder="Êñ∞Â¢ûÁâ©ÂìÅ (‰æãÂ¶Ç: Ë≠∑ÁÖß)" style="margin:0;">
                            <button class="btn btn-primary" onclick="addPackItem()" style="width:auto;">Ôºã</button>
                        </div>
                        <div id="list-packing" style="margin-top:20px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- B. Ë°åÁ®ã -->
        <div id="tab-itinerary" class="tab-content hidden">
            <div class="sticky-header">
                <div class="header-top">
                    <button class="back-btn" onclick="goHome()">‚óÄ</button>
                    <div class="header-title" id="header-trip-name"></div>
                    <div style="width:30px;"></div>
                </div>
                <div class="day-scroller" id="day-tabs-itinerary"></div>
            </div>
            
            <div class="container">
                <!-- Weather Card (Improved) -->
                <div class="weather-card">
                    <div class="w-top-row">
                        <div class="w-loc-group">
                             <div class="w-city" id="weather-loc">Loading...</div>
                             <div class="w-desc">
                                <span id="weather-icon-box" style="display:flex; align-items:center;"></span> 
                                <span id="weather-text">--</span>
                             </div>
                        </div>
                        <div class="w-main-temp">
                            <span id="weather-temp">--</span><span>¬∞C</span>
                        </div>
                    </div>
                    
                    <div class="w-grid">
                        <div class="w-stat">
                            <div class="w-stat-label">ÊúÄÈ´ò / ÊúÄ‰Ωé</div>
                            <div class="w-stat-val"><span id="w-max">--</span>¬∞ / <span id="w-min">--</span>¬∞</div>
                        </div>
                        <div class="w-stat">
                            <div class="w-stat-label">ÈôçÈõ®Ê©üÁéá</div>
                            <div class="w-stat-val" style="color:#4299E1;"><span id="w-rain">--</span>%</div>
                        </div>
                        <div class="w-stat">
                            <div class="w-stat-label">Êó•Âá∫ / Êó•ËêΩ</div>
                            <div class="w-stat-val" style="font-size:0.8rem; margin-top:2px;">
                                <span id="w-rise">--:--</span> <span style="color:var(--text-light)">|</span> <span id="w-set">--:--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ê©üÁ•®Âç°Áâá -->
                <div id="flight-card-container"></div>

                <!-- ÊôÇÈñìËª∏ -->
                <div class="timeline-wrapper">
                    <div class="timeline-line"></div>
                    <div id="list-itinerary"></div>
                </div>

                <!-- Áï∂Êôö‰ΩèÂÆø -->
                <div id="night-stay-container"></div>
            </div>
            
            <button class="fab" onclick="openNewItinerary()">
                <svg class="icon-svg"><use href="#icon-plus"></use></svg>
            </button>
        </div>

        <!-- C. Ë®òÂ∏≥ -->
        <div id="tab-money" class="tab-content hidden">
            <!-- ÂåØÁéáË®àÁÆóÊ©ü -->
            <div style="background:var(--primary); padding:20px 20px 30px 20px; border-radius:0 0 30px 30px; margin-top:-2px; color:white; box-shadow:0 10px 20px rgba(127,169,190,0.2);">
                <div style="text-align:center; font-size:0.9rem; opacity:0.8;">‰ªäÊó•ÂåØÁéáÊèõÁÆó (NTD)</div>
                <div style="font-size:2rem; font-weight:900; text-align:center; margin:5px 0;" id="rate-display">0.0</div>
                <div class="row" style="justify-content:center; align-items:center;">
                    <input type="number" id="rate-amount" placeholder="ÈáëÈ°ç" style="width:100px; text-align:center; background:white; color:black; border:none; margin:0;" oninput="updateRateCalc()">
                    <select id="rate-currency" style="background:rgba(255,255,255,0.2); border:none; color:white; font-weight:bold; border-radius:12px; padding:8px; width:auto;" onchange="fetchRate()">
                        <option value="JPY">JPY Êó•Âúì</option>
                        <option value="USD">USD ÁæéÈáë</option>
                        <option value="KRW">KRW ÈüìÂÖÉ</option>
                        <option value="EUR">EUR Ê≠êÂÖÉ</option>
                        <option value="THB">THB Ê≥∞Èäñ</option>
                        <option value="CNY">CNY ‰∫∫Ê∞ëÂπ£</option>
                    </select>
                </div>
            </div>

            <div class="sticky-header" style="top:0; border-bottom:none; background:transparent;">
                <div class="sub-nav" style="justify-content:center; padding-top:15px;">
                    <button class="sub-nav-btn active" id="btn-money-list" onclick="switchMoneySub('list')">
                        <svg class="icon-svg icon-sm"><use href="#icon-list-simple"></use></svg> ÂàóË°®
                    </button>
                    <button class="sub-nav-btn" id="btn-money-analysis" onclick="switchMoneySub('analysis')">
                        <svg class="icon-svg icon-sm"><use href="#icon-chart-pie"></use></svg> Áµ±Ë®à
                    </button>
                </div>
            </div>

            <div class="container">
                <div id="money-view-list">
                    <div class="day-scroller" id="day-tabs-money"></div>
                    <div style="text-align:right; margin-bottom:10px; font-weight:bold; color:var(--text-light); font-size:0.9rem;">
                        Áï∂Êó•Á∏ΩË®à: <span style="color:var(--primary); font-size:1.1rem; margin-left:5px;" id="day-total-display">$0</span>
                    </div>
                    <div id="list-money"></div>
                </div>
                <div id="money-view-analysis" class="hidden">
                    <div id="analysis-content"></div>
                </div>
            </div>
            <button class="fab" onclick="openMoneyModal()">
                <svg class="icon-svg"><use href="#icon-plus"></use></svg>
            </button>
        </div>

        <!-- D. Ê∏ÖÂñÆ (Lists) -->
        <div id="tab-shopping" class="tab-content hidden">
            <div class="sticky-header">
                <div class="header-top">
                    <button class="back-btn" onclick="goHome()">‚óÄ</button>
                    <div class="header-title">ÂøÖË≤∑ / ÂøÖÂêÉ</div>
                    <div style="width:30px;"></div>
                </div>
                <div class="sub-nav" style="justify-content:center;">
                    <button class="sub-nav-btn active" onclick="switchListSub('shop')">
                         <svg class="icon-svg icon-sm"><use href="#icon-nav-shop"></use></svg> Ë≥ºÁâ©Ê∏ÖÂñÆ
                    </button>
                    <button class="sub-nav-btn" onclick="switchListSub('food')">
                         <svg class="icon-svg icon-sm"><use href="#icon-food"></use></svg> ÁæéÈ£üÊ∏ÖÂñÆ
                    </button>
                </div>
            </div>
            <div class="container">
                <div class="card">
                    <input type="text" id="shop-input" placeholder="ÂêçÁ®±..." style="margin-bottom:12px;">
                    <div class="row">
                        <input type="text" class="col" id="shop-price" placeholder="È†êÁÆó/ÂÇôË®ª">
                        <input type="text" class="col" id="shop-loc" placeholder="Âú∞Èªû/Â∫óÂÆ∂">
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                         <label class="btn" style="background:#F0F4F8; color:var(--text-light); padding:10px 16px;">
                            <svg class="icon-svg icon-sm"><use href="#icon-camera"></use></svg>
                            <input type="file" id="shop-img" accept="image/*" style="display:none;">
                        </label>
                        <button class="btn btn-primary" onclick="addListItem()" style="padding-left:30px; padding-right:30px;">Êñ∞Â¢û</button>
                    </div>
                </div>
                <div id="list-items-container"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Âª∫Á´ãÊóÖÁ®ã -->
    <div id="modal-create-trip" class="modal hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary);">‚ú® Âª∫Á´ãÊñ∞ÊóÖÁ®ã</h3>
            <span class="card-label">ÊóÖÁ®ãÂêçÁ®±</span>
            <input type="text" id="new-trip-name" placeholder="‰æãÂ¶Ç: ‰∫¨ÈÉΩË≥ûÊ•ì">
            <span class="card-label">ÁõÆÁöÑÂú∞ÂüéÂ∏Ç (Áî®ÊñºÂ§©Ê∞£)</span>
            <input type="text" id="new-trip-city" placeholder="‰æãÂ¶Ç: Tokyo, Kyoto, Taipei">
            <span class="card-label">Âá∫ÁôºÊó•Êúü</span>
            <input type="date" id="new-trip-date">
            <span class="card-label">Â§©Êï∏</span>
            <input type="number" id="new-trip-days" value="5">
            <span class="card-label">ÊàêÂì° (ÈÄóËôüÈöîÈñã)</span>
            <input type="text" id="new-trip-members" placeholder="Êàë, ÊúãÂèãA, ÊúãÂèãB" value="Êàë">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn col" onclick="closeModal('create-trip')" style="background:#F2F4F6; color:#999;">ÂèñÊ∂à</button>
                <button class="btn btn-primary col" onclick="createNewTrip()">Âª∫Á´ã</button>
            </div>
        </div>
    </div>

    <!-- Ë°åÁ®ãÁ∑®ËºØ -->
    <div id="modal-itinerary" class="modal hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary);" id="modal-title-itinerary">Ë°åÁ®ãÁ¥∞È†Ö</h3>
            
            <div class="row" style="align-items: center;">
                <div class="col">
                    <span class="card-label" id="label-time-start">ÈñãÂßãÊôÇÈñì</span>
                    <input type="time" id="i-time">
                </div>
                <div class="col hidden" id="wrapper-end-time">
                    <span class="card-label">ÊäµÈÅîÊôÇÈñì</span>
                    <input type="time" id="i-end-time">
                </div>
            </div>
            
            <select id="i-type" style="width:100%; margin-bottom:12px;">
                <option value="spot">üìç ÊôØÈªû</option>
                <option value="food">üçΩÔ∏è ÁæéÈ£ü</option>
                <option value="shop">üõçÔ∏è Ë≥ºÁâ©</option>
                <option value="transport">üöã ‰∫§ÈÄö</option>
                <option value="other">‚ú® ÂÖ∂‰ªñ</option>
            </select>
            
            <div style="position:relative;">
                <input type="text" id="i-loc" placeholder="Âú∞ÈªûÂêçÁ®± (Google Maps)" style="padding-right:40px; font-weight:bold;">
                <div style="position:absolute; right:10px; top:10px; color:var(--primary);"><svg class="icon-svg icon-sm"><use href="#icon-pin"></use></svg></div>
            </div>
            
            <div style="position:relative;" id="wrapper-dest" class="hidden">
                 <input type="text" id="i-dest" placeholder="ÁõÆÁöÑÂú∞Èªû (Google Maps)" style="padding-right:40px;">
                 <div style="position:absolute; right:10px; top:10px; color:var(--primary);"><svg class="icon-svg icon-sm"><use href="#icon-pin"></use></svg></div>
            </div>

            <input type="text" id="i-title" placeholder="Ë£úÂÖÖÊ®ôÈ°å (ÈÅ∏Â°´ÔºåÂ¶Ç: Êê≠‰πòJR)" class="hidden">
            <input type="text" id="i-open" placeholder="ÁáüÊ•≠ÊôÇÈñì (Â¶Ç: 09:00 - 17:00)" class="hidden">

            <textarea id="i-note" placeholder="ÂÇôË®ª..." style="height:80px;"></textarea>
            
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn" onclick="deleteItineraryItemInModal()" style="background:#FFF0F0; color:var(--accent); min-width:50px; padding:0 12px;">
                    <svg class="icon-svg icon-sm"><use href="#icon-trash"></use></svg>
                </button>
                <button class="btn col" onclick="closeModal('itinerary')" style="background:#F2F4F6; color:#999;">ÂèñÊ∂à</button>
                <button class="btn btn-primary col" onclick="saveItinerary()">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>

    <!-- ‰ΩèÂÆø -->
    <div id="modal-hotel" class="modal hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary);">üè® ‰ΩèÂÆøË≥áË®ä</h3>
            <input type="text" id="h-name" placeholder="È£ØÂ∫óÂêçÁ®±">
            <input type="text" id="h-address" placeholder="Âú∞ÂùÄ">
            <input type="text" id="h-source" placeholder="Ë®ÇÊàø‰æÜÊ∫ê (Â¶Ç: Agoda)">
            <input type="text" id="h-order" placeholder="Ë®ÇÂñÆÁ∑®Ëôü">
            <div class="row">
                <input type="date" id="h-date" class="col">
                <input type="number" id="h-days" class="col" placeholder="ÂπæÊôö" value="1">
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn col" onclick="closeModal('hotel')" style="background:#F2F4F6; color:#999;">ÂèñÊ∂à</button>
                <button class="btn btn-primary col" onclick="saveHotel()">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>

    <!-- Á•®Âà∏ -->
    <div id="modal-ticket" class="modal hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary);">üéüÔ∏è Á•®Âà∏Ë≥áË®ä</h3>
            <input type="text" id="t-name" placeholder="Á•®Âà∏ÂêçÁ®±">
            <input type="date" id="t-date">
            <input type="text" id="t-order" placeholder="Ë®ÇÂñÆÁ∑®Ëôü/ÈÄ£Áµê">
            <textarea id="t-note" placeholder="ÂÇôË®ª..." style="height:60px;"></textarea>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn col" onclick="closeModal('ticket')" style="background:#F2F4F6; color:#999;">ÂèñÊ∂à</button>
                <button class="btn btn-primary col" onclick="saveTicket()">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>

    <!-- ÂåÖËªä/Êé•ÈÄÅ -->
    <div id="modal-charter" class="modal hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary);">üöó ÂåÖËªä / Êé•ÈÄÅ</h3>
            <div class="chip-group">
                <button class="chip-btn active" onclick="setCharterType(this, 'Êé•ÈÄÅ')">Ê©üÂ†¥Êé•ÈÄÅ</button>
                <button class="chip-btn" onclick="setCharterType(this, 'ÂåÖËªä')">ÂåÖËªä‰∏ÄÊó•ÈÅä</button>
            </div>
            <div class="row">
                <input type="date" id="c-date" class="col">
                <input type="time" id="c-time" class="col">
            </div>
            <input type="text" id="c-from" placeholder="Êé•ÈÄÅÂú∞Èªû">
            <input type="text" id="c-to" placeholder="ÁõÆÁöÑÂú∞ (Ëã•ÂåÖËªäÂèØÂ°´Â§ßÁï•ÁØÑÂúç)">
            <input type="text" id="c-contact" placeholder="Âè∏Ê©ü/ËªäË°åËÅØÁµ°ÊñπÂºè">
            <textarea id="c-note" placeholder="ÂÇôË®ª (ËªäËôü„ÄÅÈáëÈ°ç...)" style="height:60px;"></textarea>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn col" onclick="closeModal('charter')" style="background:#F2F4F6; color:#999;">ÂèñÊ∂à</button>
                <button class="btn btn-primary col" onclick="saveCharter()">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>

    <!-- Ë®òÂ∏≥ -->
    <div id="modal-money" class="modal hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary);">üí∞ Ë®ò‰∏ÄÁ≠Ü</h3>
            <input type="date" id="m-date">
            <input type="text" id="m-title" placeholder="È†ÖÁõÆ (Â¶Ç: ÊãâÈ∫µ)">
            <div class="row">
                <select id="m-curr" style="width:80px;">
                    <option value="NT$">NT$</option>
                    <option value="¬•">¬•</option>
                    <option value="‚Ç©">‚Ç©</option>
                    <option value="$">$</option>
                    <option value="‚Ç¨">‚Ç¨</option>
                    <option value="¬£">¬£</option>
                </select>
                <input type="number" id="m-cost" placeholder="ÈáëÈ°ç" inputmode="decimal">
            </div>
            <span class="card-label">Ë™∞ÂÖà‰ªòÁöÑ</span>
            <div id="m-payer-wrapper" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;"></div>
            <span class="card-label">ÊîØ‰ªòÊñπÂºè</span>
            <div class="chip-group">
                <button class="chip-btn method-btn" onclick="setMoneyMethod('cash', this)">ÁèæÈáë</button>
                <button class="chip-btn method-btn" onclick="setMoneyMethod('card', this)">‰ø°Áî®Âç°</button>
                <button class="chip-btn method-btn" onclick="setMoneyMethod('other', this)">ÂÖ∂‰ªñ</button>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn col" onclick="closeModal('money')" style="background:#F2F4F6; color:#999;">ÂèñÊ∂à</button>
                <button class="btn btn-primary col" onclick="saveMoney()">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>

<script>
    const DB_KEY = 'trip_v5_9_ult';
    let allTrips = [];
    let currentTrip = null;
    let appState = { dayIdx: 0, editId: null, editType: null, charterType: 'Êé•ÈÄÅ', listType: 'shop' };
    let moneyState = { payer: '', method: 'cash' };
    let currentRate = 0.22;

    window.onload = function() {
        const saved = localStorage.getItem(DB_KEY);
        if (saved) { try { allTrips = JSON.parse(saved); } catch(e) {} }
        
        // Transport Logic in Modal
        document.getElementById('i-type').addEventListener('change', function() {
            const val = this.value;
            const openInput = document.getElementById('i-open');
            const endTimeWrapper = document.getElementById('wrapper-end-time');
            const startTimeLabel = document.getElementById('label-time-start');
            const destWrapper = document.getElementById('wrapper-dest');
            const locInput = document.getElementById('i-loc');
            const destInput = document.getElementById('i-dest');

            openInput.classList.add('hidden');
            endTimeWrapper.classList.add('hidden');
            destWrapper.classList.add('hidden');
            startTimeLabel.innerText = "ÈñãÂßãÊôÇÈñì";

            if(val === 'food' || val === 'spot' || val === 'shop') {
                openInput.classList.remove('hidden');
                locInput.placeholder = "Âú∞ÈªûÂêçÁ®± (Google Maps)";
            } else if (val === 'transport') {
                startTimeLabel.innerText = "Âá∫ÁôºÊôÇÈñì";
                endTimeWrapper.classList.remove('hidden');
                destWrapper.classList.remove('hidden');
                locInput.placeholder = "Âá∫ÁôºÂú∞ (Starting Point)";
                destInput.placeholder = "ÊäµÈÅîÂú∞ (Destination)";
            } else {
                locInput.placeholder = "Âú∞ÈªûÂêçÁ®± (Google Maps)";
            }
        });
        renderHome();
    };
    function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(allTrips)); }

    // --- Helper for Date String ---
    function getTargetDateStr(startStr, dayOffset) {
        const parts = startStr.split('-');
        const d = new Date(parts[0], parts[1]-1, parts[2]);
        d.setDate(d.getDate() + dayOffset);
        
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    // --- ÂåØÁéá ---
    async function fetchRate() {
        const curr = document.getElementById('rate-currency').value;
        const display = document.getElementById('rate-display');
        display.innerText = "...";
        try {
            const res = await fetch(`https://api.exchangerate-api.com/v4/latest/TWD`);
            const data = await res.json();
            if (data.rates && data.rates[curr]) {
                currentRate = 1 / data.rates[curr];
                updateRateCalc();
            }
        } catch (e) { display.innerText = "Offline"; }
    }
    function updateRateCalc() {
        const amt = parseFloat(document.getElementById('rate-amount').value) || 0;
        const total = amt * currentRate;
        document.getElementById('rate-display').innerText = amt === 0 ? `1 : ${currentRate.toFixed(2)}` : `$${total.toFixed(0)}`;
    }

    // --- Weather (Max/Min + Sunrise/Sunset + Rain + No Decimals) ---
    async function fetchWeatherForDay() {
        if(!currentTrip.city) {
            document.getElementById('weather-text').innerText = "Êú™Ë®≠ÂÆöÂüéÂ∏Ç";
            document.getElementById('weather-loc').innerText = "Ë´ãÂª∫Á´ãÊñ∞ÊóÖÁ®ãÊôÇËº∏ÂÖ•";
            return;
        }
        
        const dateStr = getTargetDateStr(currentTrip.startDate, appState.dayIdx);
        let lat = currentTrip.lat, lon = currentTrip.lon;
        if (!lat || !lon) {
            try {
                const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${currentTrip.city}&count=1&language=zh&format=json`);
                const geoData = await geoRes.json();
                if(geoData.results && geoData.results.length > 0) {
                    lat = geoData.results[0].latitude;
                    lon = geoData.results[0].longitude;
                    currentTrip.lat = lat; currentTrip.lon = lon; saveData();
                }
            } catch(e) {}
        }

        if(!lat) { document.getElementById('weather-text').innerText = "Êâæ‰∏çÂà∞ÂüéÂ∏Ç"; return; }
        document.getElementById('weather-loc').innerText = currentTrip.city;

        try {
            const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_probability_max&timezone=auto&start_date=${dateStr}&end_date=${dateStr}`);
            const wData = await wRes.json();
            if(wData.daily && wData.daily.time.length > 0) {
                const code = wData.daily.weathercode[0];
                const max = Math.round(wData.daily.temperature_2m_max[0]);
                const min = Math.round(wData.daily.temperature_2m_min[0]);
                const rise = wData.daily.sunrise[0].split('T')[1];
                const set = wData.daily.sunset[0].split('T')[1];
                const rain = wData.daily.precipitation_probability_max[0];

                document.getElementById('weather-temp').innerText = max;
                document.getElementById('w-max').innerText = max;
                document.getElementById('w-min').innerText = min;
                document.getElementById('w-rise').innerText = rise;
                document.getElementById('w-set').innerText = set;
                document.getElementById('w-rain').innerText = rain;

                setWeatherIcon(code);
            } else {
                document.getElementById('weather-text').innerText = "ÁÑ°Ë≥áÊñô";
            }
        } catch(e) { document.getElementById('weather-text').innerText = "Èõ¢Á∑ö"; }
    }

    function setWeatherIcon(code) {
        let icon = '#icon-sun', text = 'Êô¥Êúó';
        if(code >= 1 && code <= 3) { icon='#icon-cloud'; text='Â§öÈõ≤'; }
        else if(code >= 45 && code <= 48) { icon='#icon-cloud'; text='Èúß'; }
        else if(code >= 51 && code <= 67) { icon='#icon-rain'; text='Èõ®Â§©'; }
        else if(code >= 71) { icon='#icon-rain'; text='‰∏ãÈõ™'; }
        else if(code >= 80) { icon='#icon-rain'; text='Èô£Èõ®'; }
        else if(code >= 95) { icon='#icon-rain'; text='Èõ∑Èõ®'; }
        document.getElementById('weather-icon-box').innerHTML = `<svg class="icon-svg"><use href="${icon}"></use></svg>`;
        document.getElementById('weather-text').innerText = text;
    }

    // --- Core Logic ---
    function renderHome() {
        document.getElementById('view-home').classList.remove('hidden');
        document.getElementById('view-detail').classList.add('hidden');
        const list = document.getElementById('trip-list-container');
        list.innerHTML = '';
        if (allTrips.length === 0) list.innerHTML = '<div style="text-align:center; color:#CCC; margin-top:50px;">ÈªûÊìäÂè≥‰∏ãËßí Ôºã ÈñãÂßã</div>';
        
        allTrips.forEach(t => {
            const div = document.createElement('div');
            div.className = 'card';
            div.onclick = () => openTrip(t.id);
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <h3 style="margin:0; color:var(--text); font-size:1.3rem;">${t.name}</h3>
                        <div style="font-size:0.9rem; color:var(--text-light); margin-top:8px;">üìÖ ${t.startDate} ¬∑ ${t.city||'Êú™ÂÆö'}</div>
                    </div>
                    <button class="btn-del" onclick="deleteTrip(event, ${t.id})"><svg class="icon-svg icon-sm"><use href="#icon-trash"></use></svg></button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function createNewTrip() {
        const name = document.getElementById('new-trip-name').value;
        const city = document.getElementById('new-trip-city').value;
        const date = document.getElementById('new-trip-date').value;
        const days = parseInt(document.getElementById('new-trip-days').value);
        const membersStr = document.getElementById('new-trip-members').value;
        if(!name || !date) return alert('Ë´ãËá≥Â∞ëÂ°´ÂØ´ÂêçÁ®±ËàáÊó•Êúü');
        
        let members = membersStr.split(/[,Ôºå\s]+/).filter(Boolean);
        if(members.length === 0) members = ['Êàë'];

        allTrips.push({
            id: Date.now(), name, city, startDate: date, days, members,
            itinerary: [], money: [], shopping: [], packing: [], foodList: [], // Added foodList here
            flights: { out:{depTz:8, arrTz:9}, in:{depTz:9, arrTz:8} }, hotels: [], tickets: [], charters: []
        });
        saveData(); closeModal('create-trip'); renderHome();
    }
    
    function deleteTrip(e, id) {
        e.stopPropagation();
        if(confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')) { allTrips = allTrips.filter(t => t.id !== id); saveData(); renderHome(); }
    }
    
    function openTrip(id) {
        currentTrip = allTrips.find(t => t.id === id);
        // Init Check
        if(!currentTrip.flights) currentTrip.flights = { out:{}, in:{} };
        if(!currentTrip.hotels) currentTrip.hotels = [];
        if(!currentTrip.tickets) currentTrip.tickets = [];
        if(!currentTrip.charters) currentTrip.charters = [];
        if(!currentTrip.foodList) currentTrip.foodList = []; 
        
        document.getElementById('view-home').classList.add('hidden');
        document.getElementById('view-detail').classList.remove('hidden');
        document.getElementById('header-trip-name').innerText = currentTrip.name;
        
        appState.dayIdx = 0;
        switchTab('info');
        fillFlightInputs();
        updateCountdown();
        fetchRate();
    }
    function goHome() { currentTrip = null; renderHome(); }
    function openCreateTripModal() { openModal('create-trip'); }

    // --- Tabs ---
    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById('tab-' + tab).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const idx = tab === 'info' ? 0 : tab === 'itinerary' ? 1 : tab === 'money' ? 2 : 3;
        document.querySelectorAll('.nav-item')[idx].classList.add('active');
        if(tab==='itinerary') renderAllDetail();
        if(tab==='shopping') { appState.listType='shop'; switchListSub('shop'); }
    }
    function switchInfoSub(sub) {
        document.querySelectorAll('.info-sub-tab').forEach(el => el.classList.add('hidden'));
        document.getElementById('info-' + sub).classList.remove('hidden');
        document.querySelectorAll('#tab-info .sub-nav-btn').forEach(el => el.classList.remove('active'));
        const btns = document.querySelectorAll('#tab-info .sub-nav-btn');
        const map = {flight:0, hotel:1, ticket:2, charter:3, packing:4};
        if(btns[map[sub]]) btns[map[sub]].classList.add('active');

        if(sub === 'flight') updateCountdown();
        if(sub === 'hotel') renderHotels();
        if(sub === 'ticket') renderTickets();
        if(sub === 'charter') renderCharters();
        if(sub === 'packing') renderPacking();
    }
    function switchMoneySub(sub) {
        const listView = document.getElementById('money-view-list');
        const analysisView = document.getElementById('money-view-analysis');
        const btnList = document.getElementById('btn-money-list');
        const btnAnalysis = document.getElementById('btn-money-analysis');

        if(sub === 'list') {
            listView.classList.remove('hidden'); analysisView.classList.add('hidden');
            btnList.classList.add('active'); btnAnalysis.classList.remove('active');
        } else {
            listView.classList.add('hidden'); analysisView.classList.remove('hidden');
            btnList.classList.remove('active'); btnAnalysis.classList.add('active');
            renderMoneyAnalysis();
        }
    }

    // --- Flight ---
    function updateCountdown() {
        const today = new Date(); today.setHours(0,0,0,0);
        const start = new Date(currentTrip.startDate);
        const diff = Math.ceil((start - today) / (1000 * 60 * 60 * 24));
        const banner = document.getElementById('countdown-area');
        
        if(diff >= 0) {
            banner.classList.remove('hidden');
            if(diff === 0) { 
                document.getElementById('countdown-val').innerText = "Âá∫ÁôºÂéªÁé©ÂõâÔºÅ";
                document.getElementById('countdown-val').style.fontSize = "2rem"; 
                document.querySelector('.countdown-label').classList.add('hidden');
            } else {
                document.getElementById('countdown-val').innerText = diff;
                document.getElementById('countdown-val').style.fontSize = "2.5rem";
                document.querySelector('.countdown-label').classList.remove('hidden');
            }
        } else {
            banner.classList.add('hidden');
        }
    }
    function fillFlightInputs() {
        const f = currentTrip.flights;
        ['code','airline','depTime','depTz','depAir','arrTime','arrTz','arrAir'].forEach(k => {
            const elOut = document.getElementById('f-out-'+k); if(elOut) elOut.value = f.out[k] || (k.includes('Tz')? (k==='arrTz'?9:8) : '');
            const elIn = document.getElementById('f-in-'+k); if(elIn) elIn.value = f.in[k] || (k.includes('Tz')? (k==='depTz'?9:8) : '');
        });
    }
    function saveFlight(dir, field, val) {
        currentTrip.flights[dir][field] = val; saveData();
    }
    function calcDuration(t1, tz1, t2, tz2) {
        if(!t1 || !t2) return '';
        const getUtcMin = (time, tz) => {
            const [h, m] = time.split(':').map(Number);
            return (h * 60 + m) - (parseInt(tz) * 60);
        };
        const m1 = getUtcMin(t1, tz1||8);
        const m2 = getUtcMin(t2, tz2||8);
        
        let diff = m2 - m1;
        if (diff < 0) diff += 24 * 60; 
        
        const h = Math.floor(diff/60);
        const m = diff % 60;
        return `${h}h ${m}m`;
    }

    // --- Hotel ---
    function openHotelModal(id=null) {
        appState.editId = id; appState.editType = 'hotel';
        if(id) {
            const h = currentTrip.hotels.find(x => x.id === id);
            document.getElementById('h-name').value = h.name;
            document.getElementById('h-address').value = h.address;
            document.getElementById('h-source').value = h.source || '';
            document.getElementById('h-order').value = h.order || '';
            document.getElementById('h-date').value = h.date;
            document.getElementById('h-days').value = h.days;
        } else {
            ['h-name','h-address','h-source','h-order','h-date'].forEach(k=>document.getElementById(k).value='');
            document.getElementById('h-days').value = 1;
        }
        openModal('hotel');
    }
    function saveHotel() {
        const name = document.getElementById('h-name').value;
        if(!name) return;
        const newData = {
            id: appState.editId || Date.now(), name,
            address: document.getElementById('h-address').value,
            source: document.getElementById('h-source').value,
            order: document.getElementById('h-order').value,
            date: document.getElementById('h-date').value,
            days: parseInt(document.getElementById('h-days').value)
        };
        if(appState.editId) {
            const idx = currentTrip.hotels.findIndex(x=>x.id===appState.editId);
            if(idx!==-1) currentTrip.hotels[idx] = newData;
        } else { currentTrip.hotels.push(newData); }
        saveData(); closeModal('hotel'); renderHotels();
    }
    function renderHotels() {
        const list = document.getElementById('hotel-list'); list.innerHTML = '';
        currentTrip.hotels.sort((a,b)=>a.date.localeCompare(b.date)).forEach(h => {
            list.innerHTML += `
                <div class="info-card-item">
                    <div class="item-icon-box"><svg class="icon-svg"><use href="#icon-house"></use></svg></div>
                    <div class="info-card-content">
                        <div class="info-card-title">${h.name}</div>
                        <div class="info-card-sub">${h.date} (${h.days}Êôö)</div>
                        ${h.source ? `<div class="info-card-sub">${h.source} #${h.order}</div>` : ''}
                    </div>
                    <div style="flex-shrink:0;">
                        <button class="btn-edit" onclick="openHotelModal(${h.id})">‚úé</button>
                        <button class="btn-del" onclick="delItem('hotels', ${h.id})">‚úï</button>
                    </div>
                </div>`;
        });
    }

    // --- Ticket ---
    function openTicketModal(id=null) {
        appState.editId = id; appState.editType = 'ticket';
        if(id) {
            const t = currentTrip.tickets.find(x => x.id === id);
            document.getElementById('t-name').value = t.name;
            document.getElementById('t-date').value = t.date;
            document.getElementById('t-order').value = t.order || '';
            document.getElementById('t-note').value = t.note || '';
        } else {
            ['t-name','t-date','t-order','t-note'].forEach(k=>document.getElementById(k).value='');
        }
        openModal('ticket');
    }
    function saveTicket() {
        const name = document.getElementById('t-name').value;
        if(!name) return;
        const newData = {
            id: appState.editId || Date.now(), name,
            date: document.getElementById('t-date').value,
            order: document.getElementById('t-order').value,
            note: document.getElementById('t-note').value
        };
        if(appState.editId) {
            const idx = currentTrip.tickets.findIndex(x=>x.id===appState.editId);
            if(idx!==-1) currentTrip.tickets[idx] = newData;
        } else { currentTrip.tickets.push(newData); }
        saveData(); closeModal('ticket'); renderTickets();
    }
    function renderTickets() {
        const list = document.getElementById('ticket-list'); list.innerHTML = '';
        currentTrip.tickets.sort((a,b)=>a.date.localeCompare(b.date)).forEach(t => {
            list.innerHTML += `
                <div class="info-card-item">
                    <div class="item-icon-box" style="background:#FFF8E1; color:#FBC02D;"><svg class="icon-svg"><use href="#icon-ticket"></use></svg></div>
                    <div class="info-card-content">
                        <div class="info-card-title">${t.name}</div>
                        <div class="info-card-sub">${t.date || 'Êú™ÂÆöÊó•Êúü'}</div>
                        ${t.order ? `<div class="info-card-sub">#${t.order}</div>` : ''}
                    </div>
                    <div style="flex-shrink:0;">
                        <button class="btn-edit" onclick="openTicketModal(${t.id})">‚úé</button>
                        <button class="btn-del" onclick="delItem('tickets', ${t.id})">‚úï</button>
                    </div>
                </div>`;
        });
    }

    // --- Charter ---
    function openCharterModal(id=null) {
        appState.editId = id; appState.editType = 'charter';
        if(id) {
            const c = currentTrip.charters.find(x => x.id === id);
            appState.charterType = c.type;
            updateCharterBtns();
            document.getElementById('c-date').value = c.date;
            document.getElementById('c-time').value = c.time;
            document.getElementById('c-from').value = c.from;
            document.getElementById('c-to').value = c.to;
            document.getElementById('c-contact').value = c.contact;
            document.getElementById('c-note').value = c.note;
        } else {
            appState.charterType = 'Êé•ÈÄÅ';
            updateCharterBtns();
            ['c-date','c-time','c-from','c-to','c-contact','c-note'].forEach(k=>document.getElementById(k).value='');
        }
        openModal('charter');
    }
    function setCharterType(el, type) {
        appState.charterType = type;
        updateCharterBtns();
    }
    function updateCharterBtns() {
        document.querySelectorAll('#modal-charter .chip-btn').forEach(b => {
            if(b.innerText.includes(appState.charterType)) b.classList.add('active');
            else b.classList.remove('active');
        });
    }
    function saveCharter() {
        const date = document.getElementById('c-date').value;
        const from = document.getElementById('c-from').value;
        if(!date || !from) return alert('Ë´ãÂ°´ÂØ´Êó•ÊúüËàáÊé•ÈÄÅÂú∞Èªû');
        const newData = {
            id: appState.editId || Date.now(),
            type: appState.charterType,
            date: date,
            time: document.getElementById('c-time').value,
            from: from,
            to: document.getElementById('c-to').value,
            contact: document.getElementById('c-contact').value,
            note: document.getElementById('c-note').value
        };
        if(appState.editId) {
            const idx = currentTrip.charters.findIndex(x=>x.id===appState.editId);
            if(idx!==-1) currentTrip.charters[idx] = newData;
        } else { currentTrip.charters.push(newData); }
        saveData(); closeModal('charter'); renderCharters();
    }
    function renderCharters() {
        const list = document.getElementById('charter-list'); list.innerHTML = '';
        currentTrip.charters.sort((a,b)=>a.date.localeCompare(b.date)).forEach(c => {
            let details = "";
            if(c.contact) details += `<div style="font-size:0.8rem; color:var(--text-light); margin-right:8px; display:flex; align-items:center; gap:4px;"><svg class="icon-svg" style="width:14px; height:14px;"><use href="#icon-phone"></use></svg> ${c.contact}</div>`;
            if(c.note) details += `<div style="font-size:0.8rem; color:var(--text-light); width:100%; display:flex; align-items:flex-start; gap:4px;"><svg class="icon-svg icon-xs" style="margin-top:2px;"><use href="#icon-note"></use></svg> <span>${c.note}</span></div>`;

            list.innerHTML += `
                 <div class="info-card-item">
                    <div class="item-icon-box" style="background:#E8EAF6; color:#5C6BC0;"><svg class="icon-svg"><use href="#icon-car"></use></svg></div>
                    <div class="info-card-content">
                        <div class="info-card-title">${c.type}</div>
                        <div class="info-card-sub"><svg class="icon-svg icon-xs"><use href="#icon-clock"></use></svg> ${c.date} ${c.time}</div>
                        <div class="info-card-sub" style="color:var(--text); font-weight:bold;">${c.from} ‚ûù ${c.to||'?'}</div>
                        <div class="info-card-sub" style="margin-top:2px;">
                             ${details}
                        </div>
                    </div>
                    <div style="flex-shrink:0;">
                        <button class="btn-edit" onclick="openCharterModal(${c.id})">‚úé</button>
                        <button class="btn-del" onclick="delItem('charters', ${c.id})">‚úï</button>
                    </div>
                </div>`;
        });
    }

    // --- Packing ---
    function addPackItem() {
        const val = document.getElementById('pack-input').value;
        if(!val) return;
        currentTrip.packing.push({id:Date.now(), text:val, checked:false});
        saveData(); document.getElementById('pack-input').value = ''; renderPacking();
    }
    function renderPacking() {
        const list = document.getElementById('list-packing'); list.innerHTML = '';
        currentTrip.packing.forEach(item => {
            list.innerHTML += `
                <div class="check-item ${item.checked?'checked':''}" onclick="toggleCheck('packing', ${item.id})">
                    <div class="check-box"></div>
                    <span style="flex:1; font-weight:bold; color:var(--text);">${item.text}</span>
                    <button class="btn-ghost" onclick="event.stopPropagation(); delItem('packing', ${item.id})"><svg class="icon-svg icon-sm"><use href="#icon-trash"></use></svg></button>
                </div>`;
        });
    }

    // --- Itinerary ---
    function renderAllDetail() {
        const dayContainer = document.getElementById('day-tabs-itinerary');
        const moneyContainer = document.getElementById('day-tabs-money');
        dayContainer.innerHTML = ''; moneyContainer.innerHTML = '';
        
        for(let i=0; i<currentTrip.days; i++) {
            const dateStr = getTargetDateStr(currentTrip.startDate, i);
            const d = new Date(dateStr);
            const m = d.getMonth() + 1;
            const date = d.getDate();
            const week = d.toLocaleDateString('zh-TW', { weekday: 'short' });
            
            const btn = document.createElement('div');
            btn.className = `day-chip ${i===appState.dayIdx?'active':''}`;
            btn.innerHTML = `<span class="day-idx">DAY ${i+1}</span><span class="date">${m}/${date} (${week})</span>`;
            btn.onclick = () => { appState.dayIdx = i; renderAllDetail(); };
            
            const btnMoney = btn.cloneNode(true);
            btnMoney.onclick = () => { appState.dayIdx = i; renderAllDetail(); };

            dayContainer.appendChild(btn);
            moneyContainer.appendChild(btnMoney);
        }

        renderItinerary();
        renderMoney();
        fetchWeatherForDay();
    }

    function renderItinerary() {
        const list = document.getElementById('list-itinerary'); 
        const flightContainer = document.getElementById('flight-card-container');
        const nightStayContainer = document.getElementById('night-stay-container');
        list.innerHTML = ''; flightContainer.innerHTML = ''; nightStayContainer.innerHTML = '';

        // 1. Ê©üÁ•®Âç°Áâá
        let fData = null, title = '';
        if (appState.dayIdx === 0 && currentTrip.flights.out.code) {
            fData = currentTrip.flights.out; title = 'ÂéªÁ®ã OUTBOUND';
        } else if (appState.dayIdx === (currentTrip.days - 1) && currentTrip.flights.in.code) {
            fData = currentTrip.flights.in; title = 'ÂõûÁ®ã INBOUND';
        }

        if (fData) {
            flightContainer.innerHTML = `
                <div class="bp-card">
                    <div class="bp-header">${title}</div>
                    <div class="bp-body">
                        <div class="bp-group">
                            <span class="bp-code">${fData.depAir || 'DEP'}</span>
                            <span class="bp-time">${fData.depTime || '--:--'}</span>
                        </div>
                        <div class="bp-center">
                             <div style="font-weight:900; color:var(--text-light); letter-spacing:1px; font-size:0.8rem;">${fData.airline || ''}</div>
                             <div class="bp-line"></div>
                             <div style="color:var(--primary); font-weight:bold; font-size:0.9rem;">${fData.code || ''}</div>
                             <div class="bp-duration">${calcDuration(fData.depTime, fData.depTz, fData.arrTime, fData.arrTz)}</div>
                        </div>
                        <div class="bp-group">
                            <span class="bp-code">${fData.arrAir || 'ARR'}</span>
                            <span class="bp-time">${fData.arrTime || '--:--'}</span>
                        </div>
                    </div>
                </div>`;
        }

        // 2. Êï¥ÂêàË°åÁ®ã (ÊéíÈô§Á•®Âà∏)
        const currentDateStr = getTargetDateStr(currentTrip.startDate, appState.dayIdx);
        let mixedList = [];

        // A. ‰∏ÄËà¨Ë°åÁ®ã
        currentTrip.itinerary.filter(i => i.dayIdx === appState.dayIdx).forEach(i => {
            mixedList.push({ ...i, source: 'itinerary' });
        });

        // B. ÂåÖËªä
        currentTrip.charters.filter(c => c.date === currentDateStr).forEach(c => {
            mixedList.push({
                id: c.id,
                time: c.time || '08:00',
                title: `${c.type}: ${c.from} ‚ûù ${c.to}`,
                loc: c.from,
                type: 'charter',
                note: c.note,
                source: 'charter',
                displayTime: c.time
            });
        });

        mixedList.sort((a,b) => a.time.localeCompare(b.time));

        const iconMap = { 
            spot:'icon-spot', food:'icon-food', shop:'icon-nav-shop', 
            transport:'icon-transport', hotel:'icon-house', other:'icon-star',
            charter:'icon-car' 
        };
        
        mixedList.forEach(item => {
            const typeClass = `type-${item.type}`;
            let displayTime = item.displayTime || item.time;
            
            // Transport Time Special Formatting
            if(item.type === 'transport') {
                displayTime = `<div class="trans-label">Âá∫Áôº</div><div class="trans-time">${item.time}</div>`;
                if(item.endTime) {
                    displayTime += `<div class="trans-divider"></div><div class="trans-label">ÊäµÈÅî</div><div class="trans-time">${item.endTime}</div>`;
                }
            }
            
            // ÂêçÁ®±ÈÇèËºØ
            let displayTitle = item.loc; 
            let displaySub = "";

            if (item.type === 'transport') {
                 if (item.dest) {
                    displaySub = `<div style="font-size:0.85rem; color:var(--text); margin-top:4px; display:flex; align-items:center; gap:5px;">
                                    <span>${item.loc}</span>
                                    <span style="color:var(--primary);">‚ûù</span>
                                    <span>${item.dest}</span>
                                  </div>`;
                    displayTitle = item.title || "ÁßªÂãï / ‰∫§ÈÄö"; 
                 } else {
                    displayTitle = item.loc || item.title;
                 }
            } else {
                if(item.title && item.title !== item.loc) {
                    displaySub = `<div style="font-size:0.85rem; color:var(--text-light); margin-top:2px;">${item.title}</div>`;
                }
            }
            
            const openTime = item.open ? `<div style="font-size:0.75rem; color:#E67C73; margin-top:2px; display:flex; align-items:center; gap:4px;"><svg class="icon-svg icon-xs"><use href="#icon-clock"></use></svg> ${item.open}</div>` : '';

            let clickAction = `editItinerary(${item.id})`;
            if(item.source === 'charter') clickAction = `openCharterModal(${item.id})`;

            const mapBtn = (item.loc || item.dest) ? 
                `<button class="btn-map-icon" onclick="event.stopPropagation(); openMap(event, '${item.type==='transport'?item.dest:item.loc}')">
                    <svg class="icon-svg icon-sm"><use href="#icon-map-pin"></use></svg>
                 </button>` : '';

            // ÁßªÈô§ÂàóË°®È†ÅÈù¢ÁöÑÂà™Èô§ÊåâÈàï
            
            list.innerHTML += `
                <div class="timeline-item" onclick="${clickAction}">
                    <div class="time-bubble">${displayTime}</div>
                    <div class="it-card ${typeClass}">
                        <div class="it-icon"><svg class="icon-svg icon-sm"><use href="#${iconMap[item.type]||'icon-star'}"></use></svg></div>
                        <div style="flex:1; min-width:0;">
                            <div style="font-weight:bold; color:var(--text); margin-bottom:2px; font-size:1.05rem; word-wrap:break-word;">${displayTitle}</div>
                            ${displaySub}
                            ${openTime}
                            <div style="font-size:0.85rem; color:var(--text); white-space:pre-wrap; margin-top:4px; opacity:0.8;">${item.note || ''}</div>
                        </div>
                        <div class="it-actions">
                            ${mapBtn}
                        </div>
                    </div>
                </div>`;
        });

        // 3. Áï∂Êôö‰ΩèÂÆø
        const stay = currentTrip.hotels.find(h => {
            const checkIn = new Date(h.date);
            const checkOut = new Date(h.date);
            checkOut.setDate(checkOut.getDate() + parseInt(h.days));
            const currentD = new Date(currentDateStr);
            return currentD >= checkIn && currentD < checkOut;
        });

        if(stay) {
            nightStayContainer.innerHTML = `
                <div class="night-stay-box">
                    <svg class="icon-svg"><use href="#icon-moon"></use></svg>
                    <div>
                        <div style="font-size:0.8rem; opacity:0.8;">Tonight's Stay</div>
                        <div style="font-weight:bold; font-size:1.1rem;">${stay.name}</div>
                        <div style="font-size:0.8rem;">${stay.address}</div>
                    </div>
                </div>`;
        }
    }

    function openNewItinerary() {
        appState.editId = null;
        document.getElementById('modal-title-itinerary').innerText = "‚ú® Êñ∞Â¢ûË°åÁ®ã";
        ['i-time','i-title','i-loc','i-note','i-open','i-end-time','i-dest'].forEach(id=>document.getElementById(id).value='');
        
        const typeSelect = document.getElementById('i-type');
        typeSelect.value = 'spot';
        
        const event = new Event('change');
        typeSelect.dispatchEvent(event);

        openModal('itinerary');
    }

    function editItinerary(id) {
        const item = currentTrip.itinerary.find(i => i.id === id);
        if(!item) return;
        appState.editId = id;
        document.getElementById('modal-title-itinerary').innerText = "‚úèÔ∏è Á∑®ËºØË°åÁ®ã";
        
        document.getElementById('i-time').value = item.time;
        const typeSelect = document.getElementById('i-type');
        typeSelect.value = item.type;
        
        const event = new Event('change');
        typeSelect.dispatchEvent(event);

        document.getElementById('i-title').value = item.title;
        document.getElementById('i-loc').value = item.loc;
        document.getElementById('i-note').value = item.note || '';
        document.getElementById('i-open').value = item.open || '';
        document.getElementById('i-end-time').value = item.endTime || '';
        document.getElementById('i-dest').value = item.dest || '';

        openModal('itinerary');
    }

    // Â∑≤ÁßªÈô§ list È†ÅÈù¢ÁöÑ deleteItineraryItem ÂáΩÂºèÔºåÂõ†ÁÇ∫ÊåâÈàïÂ∑≤Âà™Èô§

    function deleteItineraryItemInModal() {
        if(!appState.editId) return; 
        if(confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Ë°åÁ®ãÔºü')) {
            currentTrip.itinerary = currentTrip.itinerary.filter(i => i.id !== appState.editId);
            saveData();
            closeModal('itinerary');
            renderItinerary();
        }
    }

    function saveItinerary() {
        const time = document.getElementById('i-time').value;
        const loc = document.getElementById('i-loc').value;
        if(!time || !loc) return alert("Ë´ãÂ°´ÂØ´ÊôÇÈñìËàáÂú∞Èªû");
        
        const newData = {
            id: appState.editId || Date.now(), 
            dayIdx: appState.dayIdx, 
            time,
            type: document.getElementById('i-type').value, 
            title: document.getElementById('i-title').value,
            open: document.getElementById('i-open').value,
            loc: loc, 
            note: document.getElementById('i-note').value,
            endTime: document.getElementById('i-end-time').value,
            dest: document.getElementById('i-dest').value
        };

        if(appState.editId) {
            const idx = currentTrip.itinerary.findIndex(i => i.id === appState.editId);
            if(idx!==-1) currentTrip.itinerary[idx] = newData;
        } else { currentTrip.itinerary.push(newData); }
        
        currentTrip.itinerary.sort((a,b)=>a.time.localeCompare(b.time));
        saveData(); closeModal('itinerary'); renderItinerary();
    }

    // --- Lists (Shopping + Food) ---
    function switchListSub(type) {
        appState.listType = type;
        document.querySelectorAll('#tab-shopping .sub-nav-btn').forEach(b => b.classList.remove('active'));
        const idx = type === 'shop' ? 0 : 1;
        document.querySelectorAll('#tab-shopping .sub-nav-btn')[idx].classList.add('active');
        renderLists();
    }

    function addListItem() {
        const input = document.getElementById('shop-input');
        const price = document.getElementById('shop-price');
        const loc = document.getElementById('shop-loc');
        const fileInput = document.getElementById('shop-img');
        if(!input.value) return;

        const save = (img) => {
            const newItem = { 
                id:Date.now(), 
                text:input.value, 
                price:price.value, 
                location: loc.value, 
                checked:false, 
                image:img 
            };
            
            if(appState.listType === 'shop') currentTrip.shopping.push(newItem);
            else currentTrip.foodList.push(newItem);
            
            saveData(); 
            input.value = ''; price.value = ''; loc.value=''; fileInput.value = ''; 
            renderLists();
        };

        if(fileInput.files[0]) {
            const r = new FileReader();
            r.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                    const s = 300/img.width; c.width=300; c.height=img.height*s;
                    ctx.drawImage(img,0,0,c.width,c.height); save(c.toDataURL('image/jpeg',0.5));
                }; img.src = e.target.result;
            }; r.readAsDataURL(fileInput.files[0]);
        } else save(null);
    }

    function renderLists() {
        const list = document.getElementById('list-items-container'); list.innerHTML = '';
        const data = appState.listType === 'shop' ? currentTrip.shopping : currentTrip.foodList;
        const typeStr = appState.listType === 'shop' ? 'shopping' : 'foodList';

        data.forEach(item => {
            const imgHtml = item.image ? `<img src="${item.image}" style="width:50px; height:50px; border-radius:10px; object-fit:cover; margin-right:10px;" onclick="window.open('${item.image}')">` : '';
            const locHtml = item.location ? `<span style="font-size:0.8rem; color:var(--text-light); margin-left:8px;">üìç ${item.location}</span>` : '';
            
            list.innerHTML += `
                <div class="card check-item ${item.checked?'checked':''}" style="padding:15px; display:flex; align-items:center;" onclick="toggleCheck('${typeStr}', ${item.id})">
                    <div class="check-box"></div>
                    ${imgHtml}
                    <div style="flex:1;">
                        <div class="shop-text-content" style="font-weight:bold; color:var(--text);">${item.text}</div>
                        <div class="shop-text-content" style="font-size:0.85rem; color:var(--accent);">
                            ${item.price||''} ${locHtml}
                        </div>
                    </div>
                    <button class="btn-del" onclick="event.stopPropagation(); delItem('${typeStr}', ${item.id})">ÁßªÈô§</button>
                </div>`;
        });
    }
    
    // --- Money ---
    function openMoneyModal(id=null) {
        appState.editId = id; appState.editType = 'money';
        
        const d = new Date(currentTrip.startDate); d.setDate(d.getDate() + appState.dayIdx);
        let defaultDate = d.toISOString().split('T')[0];

        if(id) {
            const m = currentTrip.money.find(x => x.id === id);
            document.getElementById('m-title').value = m.title;
            document.getElementById('m-cost').value = m.cost;
            document.getElementById('m-curr').value = m.curr;
            document.getElementById('m-date').value = m.date;
            moneyState.payer = m.payer;
            moneyState.method = m.method;
        } else {
            document.getElementById('m-title').value = '';
            document.getElementById('m-cost').value = '';
            document.getElementById('m-date').value = defaultDate;
            moneyState.payer = currentTrip.members[0];
            moneyState.method = 'cash';
        }

        // Render Payer Buttons
        const payerContainer = document.getElementById('m-payer-wrapper');
        payerContainer.innerHTML = '';
        currentTrip.members.forEach(m => {
            const btn = document.createElement('button');
            btn.className = 'btn-ghost'; 
            btn.style.border = '1px solid #EEE';
            btn.style.borderRadius = '20px';
            btn.innerText = m;
            if(moneyState.payer === m) { btn.style.background= 'var(--primary)'; btn.style.color='white'; }
            btn.onclick = (e) => {
                Array.from(payerContainer.children).forEach(c=>{c.style.background='transparent'; c.style.color='var(--text-light)'});
                e.target.style.background='var(--primary)'; e.target.style.color='white';
                moneyState.payer = m;
            };
            payerContainer.appendChild(btn);
        });

        // Render Method Buttons (Chips)
        document.querySelectorAll('.method-btn').forEach(b => {
             b.classList.remove('active');
             const map = {'ÁèæÈáë':'cash', '‰ø°Áî®Âç°':'card', 'ÂÖ∂‰ªñ':'other'};
             if(map[b.innerText] === moneyState.method) b.classList.add('active');
        });

        openModal('money');
    }

    function setMoneyMethod(m, el) {
        moneyState.method = m;
        document.querySelectorAll('.method-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    function saveMoney() {
        const title = document.getElementById('m-title').value;
        const cost = document.getElementById('m-cost').value;
        if(!title || !cost) return;
        
        const newData = {
            id: appState.editId || Date.now(), 
            dayIdx: appState.dayIdx,
            date: document.getElementById('m-date').value,
            title, 
            cost: parseFloat(cost), 
            curr: document.getElementById('m-curr').value,
            payer: moneyState.payer, 
            method: moneyState.method || 'cash'
        };

        if(appState.editId) {
            const idx = currentTrip.money.findIndex(x=>x.id===appState.editId);
            if(idx!==-1) currentTrip.money[idx] = newData;
        } else {
            currentTrip.money.push(newData);
        }
        
        saveData(); closeModal('money'); renderMoney();
    }

    function renderMoney() {
        const list = document.getElementById('list-money'); list.innerHTML = '';
        const items = currentTrip.money.filter(i => i.dayIdx === appState.dayIdx);
        const methodMap = { 'cash': 'ÁèæÈáë', 'card': '‰ø°Áî®Âç°', 'other': 'ÂÖ∂‰ªñ' };
        
        // Logic for Daily Total
        let dailyTotals = {};
        items.forEach(i => {
            if(!dailyTotals[i.curr]) dailyTotals[i.curr] = 0;
            dailyTotals[i.curr] += parseFloat(i.cost);
        });
        
        let totalStr = "";
        if(Object.keys(dailyTotals).length === 0) totalStr = "$0";
        else {
             Object.keys(dailyTotals).forEach(curr => {
                 totalStr += `<span style="margin-left:8px;">${curr} ${dailyTotals[curr].toLocaleString()}</span>`;
             });
        }
        document.getElementById('day-total-display').innerHTML = totalStr;
        
        [...items].reverse().forEach(item => {
            list.innerHTML += `
                <div class="money-item-compact" onclick="openMoneyModal(${item.id})">
                    <div style="flex:1;">
                        <div style="font-weight:bold; color:var(--text); font-size:0.95rem;">${item.title}</div>
                        <div class="money-meta">
                             <svg class="icon-svg icon-xs"><use href="#icon-user"></use></svg> ${item.payer} ¬∑ ${methodMap[item.method] || item.method}
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:900; color:var(--primary-dark); font-size:1rem;">${item.curr} ${item.cost}</div>
                        <button class="btn-ghost" onclick="event.stopPropagation(); delItem('money', ${item.id})" style="padding:4px; margin-top:2px; color:#e57373;">
                           <svg class="icon-svg icon-xs"><use href="#icon-trash"></use></svg>
                        </button>
                    </div>
                </div>`;
        });
    }
    
    // --- Money Analysis ---
    function renderMoneyAnalysis() {
        const container = document.getElementById('analysis-content'); container.innerHTML = '';
        
        let stats = {}; 
        let grandTotals = {}; 
        
        currentTrip.members.forEach(m => { stats[m] = {}; });

        currentTrip.money.forEach(m => {
            const p = m.payer || currentTrip.members[0];
            const curr = m.curr || 'NT$';
            const cost = parseFloat(m.cost);
            
            if (!stats[p]) stats[p] = {};
            if (!stats[p][curr]) stats[p][curr] = 0;
            stats[p][curr] += cost;

            if (!grandTotals[curr]) grandTotals[curr] = 0;
            grandTotals[curr] += cost;
        });

        container.innerHTML += `<div style="font-weight:bold; margin-bottom:15px; color:var(--primary); display:flex; align-items:center; gap:8px;"><svg class="icon-svg icon-sm"><use href="#icon-chart-bar"></use></svg> ÊîØÂá∫Áµ±Ë®à</div>`;
        
        Object.keys(stats).forEach(member => {
            const currencyMap = stats[member];
            let currencyHtml = '';
            
            if (Object.keys(currencyMap).length === 0) {
                currencyHtml = '<div style="font-size:0.9rem; color:#CCC;">ÁÑ°ÊîØÂá∫Á¥ÄÈåÑ</div>';
            } else {
                Object.keys(currencyMap).forEach(c => {
                    currencyHtml += `
                        <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:0.95rem;">
                            <span style="color:var(--text-light); font-weight:bold;">${c}</span>
                            <span style="font-weight:900; color:var(--text);">${currencyMap[c].toLocaleString()}</span>
                        </div>
                    `;
                });
            }

            container.innerHTML += `
                <div class="card" style="padding:15px; margin-bottom:15px;">
                    <div style="margin-bottom:10px; border-bottom:1px solid #F0F0F0; padding-bottom:10px; display:flex; align-items:center; gap:8px;">
                         <svg class="icon-svg icon-sm" style="color:var(--primary-dark);"><use href="#icon-user"></use></svg>
                        <div style="font-weight:900; font-size:1.1rem; color:var(--primary-dark);">${member}</div>
                    </div>
                    <div>${currencyHtml}</div>
                </div>`;
        });
        
        let totalHtml = '';
        if (Object.keys(grandTotals).length === 0) {
             totalHtml = '<div style="font-size:1.5rem; color:#CCC;">$0</div>';
        } else {
             Object.keys(grandTotals).forEach(c => {
                 totalHtml += `<div style="margin-bottom:5px;">${c} <span style="font-size:1.6rem;">${grandTotals[c].toLocaleString()}</span></div>`;
             });
        }

        container.innerHTML += `
            <div style="text-align:center; margin-top:30px; padding-bottom:20px;">
                <div style="font-size:0.9rem; color:var(--text-light); margin-bottom:10px;">ÊóÖÁ®ãÁ∏ΩÊîØÂá∫</div>
                <div style="font-weight:900; color:var(--primary-dark); line-height:1.4;">${totalHtml}</div>
            </div>`;
    }

    // --- Utils ---
    function openMap(e, loc) { e.stopPropagation(); window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`, '_blank'); }
    function toggleCheck(type, id) { 
        let arr = type === 'foodList' ? currentTrip.foodList : currentTrip[type];
        const i = arr.find(x => x.id === id); 
        if(i) { i.checked = !i.checked; saveData(); type==='packing'?renderPacking():renderLists(); } 
    }
    function delItem(type, id) { 
        if(!confirm('Âà™Èô§Ôºü')) return; 
        if(type==='foodList') {
             currentTrip.foodList = currentTrip.foodList.filter(x => x.id !== id);
             saveData(); renderLists();
             return;
        }
        currentTrip[type] = currentTrip[type].filter(x => x.id !== id); 
        saveData(); 
        if(type==='hotels') renderHotels(); 
        else if(type==='tickets') renderTickets(); 
        else if(type==='charters') renderCharters(); 
        else if(type==='packing') renderPacking(); 
        else if(type==='money') { renderMoney(); renderMoneyAnalysis(); } 
        else if(type==='shopping') renderLists(); 
    }
    function closeModal(id) { document.getElementById('modal-'+id).classList.add('hidden'); }
    function openModal(id) { document.getElementById('modal-'+id).classList.remove('hidden'); }
</script>
</body>
</html>
