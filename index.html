<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…éŠæ‰‹å¸³ â˜ï¸</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <!-- å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #8FB7C8;       /* è«è˜­è¿ªè—ç° */
            --primary-dark: #6D92A3;
            --secondary: #F4CBA6;     /* æŸ”å’Œææ¡ƒ */
            --accent: #E5989B;        /* ä¹¾ç‡¥ç«ç‘° */
            --text: #6D6875;          /* æ·±æš–ç° */
            --bg-color: #FAF9F6;      /* ç±³ç™½ç´™å¼µ */
            --time-bg: #DDE5B6;       /* æŠ¹èŒ¶ç¶  */
            --nav-height: 70px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(#E5E5E5 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text);
            padding-bottom: calc(var(--nav-height) + 40px);
            -webkit-overflow-scrolling: touch;
        }

        .hidden { display: none !important; }

        /* --- SVG --- */
        .icon-svg { width: 22px; height: 22px; stroke: currentColor; stroke-width: 2.2; fill: none; stroke-linecap: round; stroke-linejoin: round; pointer-events: none; } /* ä¿®æ­£ï¼šåŠ å…¥ pointer-events é˜²æ­¢æ“‹ä½æŒ‰éˆ•é»æ“Š */
        .icon-sm { width: 16px; height: 16px; }
        .icon-xs { width: 14px; height: 14px; }

        /* --- UI å…ƒä»¶ --- */
        .btn {
            border: 2px solid var(--primary); border-radius: 16px;
            padding: 8px 16px; font-size: 0.95rem; font-weight: bold;
            cursor: pointer; background: white; color: var(--primary);
            box-shadow: 2px 2px 0px #CED4DA; transition: 0.1s;
            display: inline-flex; align-items: center; justify-content: center; gap: 5px;
            font-family: 'Zen Maru Gothic', sans-serif;
        }
        .btn:active { transform: translate(1px, 1px); box-shadow: 1px 1px 0px #CED4DA; }
        
        .btn-primary { 
            background: var(--primary); color: white; 
            box-shadow: 3px 3px 0px var(--primary-dark); border-color: var(--primary);
        }

        input, select, textarea {
            width: 100%; padding: 12px;
            border: 2px solid #EBEBEB; border-radius: 14px;
            background: #FFF; font-size: 15px; outline: none;
            margin-bottom: 12px; font-family: 'Zen Maru Gothic', sans-serif;
            color: var(--text); transition: 0.2s;
        }
        input:focus { border-color: var(--primary); background: #F7FBFC; }

        /* --- æŒ‰éˆ•é¸æ“‡ç¾¤çµ„ (Chip Group) --- */
        .chip-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
        .chip-btn {
            padding: 6px 12px; border-radius: 20px; border: 2px solid #E0E0E0;
            background: white; color: #AAA; font-size: 0.9rem; font-weight: bold;
            cursor: pointer; transition: 0.2s;
        }
        .chip-btn.active {
            border-color: var(--primary); background: var(--primary); color: white;
            box-shadow: 2px 2px 0px var(--primary-dark);
        }
        .chip-btn-method.active { /* æ”¯ä»˜æ–¹å¼çš„ç‰¹æ®Šé¡è‰² */
            border-color: var(--secondary); background: var(--secondary); color: white;
            box-shadow: 2px 2px 0px #E6B085;
        }

        /* --- ä¸»ç•«é¢ --- */
        #view-home { padding: 30px 20px; min-height: 100vh; }
        .trip-card {
            background: white; border: 2px solid #EBEBEB; border-radius: 20px;
            padding: 20px; margin-bottom: 20px;
            box-shadow: 4px 4px 0px #F2F2F2;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- å…§é  Header --- */
        .sticky-header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(250, 249, 246, 0.96);
            backdrop-filter: blur(5px);
            padding-top: env(safe-area-inset-top);
            border-bottom: 2px dashed #E0E0E0;
        }
        .header-top { padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; }
        .header-title { font-size: 1.2rem; color: var(--primary-dark); font-weight: 900; }
        .back-btn { background: #F0F4F8; color: var(--primary); border: none; padding: 6px 12px; border-radius: 12px; font-weight: bold; font-size: 0.85rem; }

        /* --- è¡Œå‰æº–å‚™é  --- */
        .info-section {
            background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px;
            border: 2px solid #F0F0F0; box-shadow: 3px 3px 0px #F5F5F5;
        }
        .info-title { font-weight: bold; color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .info-textarea { 
            width: 100%; border: none; background: #F9F9F9; resize: none; 
            padding: 10px; border-radius: 10px; font-size: 0.9rem; line-height: 1.5;
            min-height: 80px;
        }

        /* --- æ©Ÿç¥¨å¡ç‰‡ --- */
        .boarding-pass {
            background: white; border: 2px solid var(--primary);
            border-radius: 16px; margin-bottom: 25px;
            position: relative; overflow: hidden;
            box-shadow: 4px 4px 0px rgba(143, 183, 200, 0.2);
            display: flex; flex-direction: column;
        }
        .boarding-pass::before, .boarding-pass::after {
            content: ''; position: absolute; top: 60px; width: 24px; height: 24px;
            background: var(--bg-color); border-radius: 50%; border: 2px solid var(--primary);
        }
        .boarding-pass::before { left: -14px; }
        .boarding-pass::after { right: -14px; }
        .bp-header { background: var(--primary); color: white; padding: 8px 15px; font-size: 0.8rem; letter-spacing: 1px; text-align: center; border-bottom: 2px dashed white; }
        .bp-body { padding: 15px 20px 20px; }
        .bp-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .bp-time { font-size: 0.9rem; color: var(--primary); font-weight: bold; border:none; background:transparent; width: 60px; text-align: center;}
        .bp-code { font-size: 2rem; font-weight: 900; color: var(--text); border:none; background:transparent; width: 80px; text-align: center; text-transform: uppercase;}
        .bp-center { flex: 1; text-align: center; padding: 0 10px; position: relative; bottom: 5px; }
        .bp-flight-no { border: none; background: #F0F4F8; color: var(--primary); font-weight: bold; text-align: center; width: 100%; border-radius: 6px; font-size: 0.85rem; padding: 2px; }
        .bp-line { height: 2px; background-image: linear-gradient(to right, var(--primary) 50%, transparent 50%); background-size: 8px 1px; margin-top: 5px; position: relative; }
        .bp-icon { position: absolute; top: -8px; left: 50%; transform: translateX(-50%); background: white; color: var(--primary); padding: 0 5px; }

        /* --- è¡Œç¨‹åˆ—è¡¨ --- */
        .day-scroller { display: flex; overflow-x: auto; padding: 10px 15px; gap: 8px; scrollbar-width: none; }
        .day-chip { flex: 0 0 auto; padding: 6px 14px; border-radius: 16px; background: white; border: 2px solid #EBEBEB; color: #B0B0B0; text-align: center; font-size: 0.85rem; transition: 0.2s; }
        .day-chip.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 2px 2px 0px var(--primary-dark); }
        .container { padding: 15px; padding-bottom: 90px; }
        .timeline-item { display: flex; gap: 15px; margin-bottom: 20px; position: relative; }
        .time-bubble {
            flex-shrink: 0; width: 60px; text-align: center; background: var(--time-bg); color: #556B2F;
            border-radius: 14px; padding: 8px 0; font-weight: 800; font-size: 0.95rem; height: fit-content; border: 2px solid white; box-shadow: 3px 3px 0px rgba(0,0,0,0.05); z-index: 1;
        }
        .itinerary-card {
            flex: 1; background: white; border-radius: 18px; padding: 12px 15px;
            border: 2px solid #F0F0F0; box-shadow: 3px 3px 0px #F5F5F5; position: relative; transition: 0.1s;
        }
        .itinerary-card:active { transform: scale(0.98); }
        .it-header { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .it-icon { font-size: 1.2rem; }
        .it-title { font-size: 1.05rem; font-weight: bold; color: #555; }
        .it-map-btn { position: absolute; right: 12px; top: 12px; width: 32px; height: 32px; border-radius: 50%; background: #EBF5FB; color: var(--primary); display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }
        .item-note { font-size: 0.8rem; color: #999; background: #F9F9F9; padding: 3px 8px; border-radius: 8px; display: inline-block; margin-top: 5px; }

        /* --- è¨˜å¸³åˆ—è¡¨ --- */
        .money-card {
            background: white; border-radius: 18px; padding: 12px 15px; margin-bottom: 12px;
            border: 2px solid #F0F0F0; display: flex; justify-content: space-between; align-items: center;
        }
        .money-payer-badge {
            font-size: 0.75rem; background: #EBF5FB; color: var(--primary);
            padding: 2px 6px; border-radius: 6px; margin-left: 5px;
        }
        .money-method-badge {
            font-size: 0.75rem; color: #AAA; display: flex; align-items: center; gap: 4px;
        }

        /* --- è³¼ç‰©æ¸…å–® --- */
        .shop-item { background: white; border-radius: 16px; padding: 12px; margin-bottom: 12px; border: 2px solid #FBE9E7; box-shadow: 3px 3px 0px #FFCCBC; display: flex; gap: 10px; align-items: center; }
        .shop-thumb { width: 50px; height: 50px; border-radius: 10px; background: #F5F5F5; object-fit: cover; border: 1px solid #EEE; flex-shrink: 0; }
        .shop-placeholder { width: 50px; height: 50px; border-radius: 10px; background: #FDF2E9; display: flex; align-items: center; justify-content: center; color: var(--secondary); font-size: 0.8rem; flex-shrink: 0; }
        
        /* å°èˆªèˆ‡ FAB */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 400px; height: 70px; background: white;
            display: flex; justify-content: space-around; align-items: center;
            border-radius: 35px; box-shadow: 0 8px 25px rgba(100,100,100,0.1);
            z-index: 1000; border: 2px solid #F0F0F0;
        }
        .nav-item { flex: 1; text-align: center; border: none; background: none; color: #CCC; font-size: 0.7rem; font-weight: 700; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-item.active { color: var(--primary); }
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; box-shadow: 4px 4px 0px rgba(0,0,0,0.1); z-index: 900; border: 2px solid white; cursor: pointer; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.92); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 88%; max-width: 380px; padding: 25px; border-radius: 24px; border: 2px solid var(--primary); box-shadow: 6px 6px 0px #D6EAF8; }
        .check-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 2px dashed #F5F5F5; }
        .check-item.checked span { text-decoration: line-through; color: #DDD; }
        input[type="checkbox"] { width: 20px; height: 20px; margin-right: 10px; accent-color: var(--primary); }

        /* Label styling */
        .input-label { font-size: 0.85rem; color: #999; margin-bottom: 4px; display: block; font-weight: bold;}

    </style>
</head>
<body>

    <!-- SVG -->
    <svg style="display:none;">
        <symbol id="icon-info" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></symbol>
        <symbol id="icon-calendar" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></symbol>
        <symbol id="icon-money" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v12M15 9.5a2.5 2.5 0 0 0-5 0v3a2.5 2.5 0 0 0 5 0"></path></symbol>
        <symbol id="icon-shop" viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></symbol>
        <symbol id="icon-plus" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></symbol>
        <symbol id="icon-pin" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></symbol>
        <symbol id="icon-plane" viewBox="0 0 24 24"><path d="M2 12h20"></path><path d="M13 5l7 7-7 7"></path></symbol>
        <symbol id="icon-camera" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></symbol>
        <symbol id="icon-card" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></symbol>
        <symbol id="icon-cash" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2"></rect><circle cx="12" cy="12" r="2"></circle><path d="M6 12h.01M18 12h.01"></path></symbol>
    </svg>

    <!-- 1. ä¸»ç•«é¢ -->
    <div id="view-home">
        <div style="text-align:center; margin-top:40px; margin-bottom:40px;">
            <h1 style="color:var(--primary); margin:0;">æ—…éŠæ‰‹å¸³</h1>
            <p style="color:#AAA;">My Travel Journal</p>
        </div>
        <div id="trip-list-container"></div>
        <!-- ä¿®æ­£ï¼šé€™è£¡æ”¹æˆç›´æ¥å‘¼å« openModal -->
        <button class="fab" onclick="openModal('create-trip')">
            <svg class="icon-svg"><use href="#icon-plus"></use></svg>
        </button>
    </div>

    <!-- 2. å…§é  -->
    <div id="view-detail" class="hidden">
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('info')">
                <svg class="icon-svg"><use href="#icon-info"></use></svg> è¡Œå‰
            </button>
            <button class="nav-item" onclick="switchTab('itinerary')">
                <svg class="icon-svg"><use href="#icon-calendar"></use></svg> è¡Œç¨‹
            </button>
            <button class="nav-item" onclick="switchTab('money')">
                <svg class="icon-svg"><use href="#icon-money"></use></svg> è¨˜å¸³
            </button>
            <button class="nav-item" onclick="switchTab('shopping')">
                <svg class="icon-svg"><use href="#icon-shop"></use></svg> è³¼ç‰©
            </button>
        </nav>

        <!-- A. è¡Œå‰æº–å‚™ -->
        <div id="tab-info" class="tab-content">
            <div class="sticky-header">
                <div class="header-top">
                    <button class="back-btn" onclick="goHome()">â—€ å›åˆ—è¡¨</button>
                    <div class="header-title">è¡Œå‰æº–å‚™</div>
                    <div style="width:50px;"></div>
                </div>
            </div>
            <div class="container">
                <div class="info-section">
                    <div class="info-title">ğŸ¨ ä½å®¿è³‡æ–™</div>
                    <textarea class="info-textarea" id="note-hotel" placeholder="é£¯åº—åœ°å€ã€è¨‚æˆ¿ä»£è™Ÿ..." oninput="saveGlobalNote('hotel', this.value)"></textarea>
                </div>
                <div class="info-section">
                    <div class="info-title">âœˆï¸ èˆªç­è³‡æ–™</div>
                    <textarea class="info-textarea" id="note-flight" placeholder="é›»å­æ©Ÿç¥¨è™Ÿç¢¼..." oninput="saveGlobalNote('flight', this.value)"></textarea>
                </div>
                <div class="info-section">
                    <div class="info-title">ğŸ’ è¡Œææ¸…å–®</div>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="text" id="pack-input" placeholder="æ–°å¢ç‰©å“..." style="margin:0;">
                        <button class="btn btn-primary" onclick="addPackItem()" style="width:auto;">ï¼‹</button>
                    </div>
                    <div id="list-packing"></div>
                </div>
            </div>
        </div>

        <!-- B. è¡Œç¨‹ -->
        <div id="tab-itinerary" class="tab-content hidden">
            <div class="sticky-header">
                <div class="header-top">
                    <button class="back-btn" onclick="goHome()">â—€</button>
                    <div class="header-title" id="header-trip-name"></div>
                    <div style="width:30px;"></div>
                </div>
                <div class="day-scroller" id="day-tabs-itinerary"></div>
            </div>
            <div class="container">
                <div id="flight-section"></div>
                <div id="list-itinerary"></div>
            </div>
            <button class="fab" onclick="openNewItinerary()">
                <svg class="icon-svg"><use href="#icon-plus"></use></svg>
            </button>
        </div>

        <!-- C. è¨˜å¸³ -->
        <div id="tab-money" class="tab-content hidden">
            <div class="sticky-header">
                <div class="header-top">
                    <button class="back-btn" onclick="goHome()">â—€</button>
                    <div class="header-title">è¨˜å¸³æœ¬</div>
                    <div style="font-size:0.9rem; background:#FFF3E0; color:#F57C00; padding:4px 8px; border-radius:8px;">
                        åˆè¨ˆ $<b id="day-total">0</b>
                    </div>
                </div>
                <div class="day-scroller" id="day-tabs-money"></div>
            </div>
            <div class="container" id="list-money"></div>
            <button class="fab" onclick="openMoneyModal()">
                <svg class="icon-svg"><use href="#icon-plus"></use></svg>
            </button>
        </div>

        <!-- D. è³¼ç‰© -->
        <div id="tab-shopping" class="tab-content hidden">
            <div class="sticky-header">
                <div class="header-top">
                    <button class="back-btn" onclick="goHome()">â—€</button>
                    <div class="header-title">è³¼ç‰©æ¸…å–®</div>
                    <div style="width:30px;"></div>
                </div>
            </div>
            <div class="container">
                <div class="info-section" style="border-color:#F5E0C3;">
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="text" id="shop-input" placeholder="æƒ³è²·ä»€éº¼..." style="margin:0;">
                        <label class="btn" style="background:#FFF; border-color:#DDD; color:#888; padding:0 10px;">
                            <svg class="icon-svg icon-sm"><use href="#icon-camera"></use></svg>
                            <input type="file" id="shop-img" accept="image/*" style="display:none;">
                        </label>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="shop-price" placeholder="é ç®—/å‚™è¨»" style="margin:0; font-size:0.9rem;">
                        <button class="btn" style="background:var(--secondary); color:white; border:none;" onclick="addShoppingItem()">æ–°å¢</button>
                    </div>
                </div>
                <div id="list-shopping"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- 1. å»ºç«‹æ—…ç¨‹ (å«æˆå“¡) -->
    <div id="modal-create-trip" class="modal hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary);">âœ¨ é–‹å•Ÿæ–°æ—…ç¨‹</h3>
            <span class="input-label">æ—…ç¨‹åç¨±</span>
            <input type="text" id="new-trip-name" placeholder="ä¾‹å¦‚: äº¬éƒ½è³æ¥“">
            <span class="input-label">å‡ºç™¼æ—¥æœŸ</span>
            <input type="date" id="new-trip-date">
            <span class="input-label">å¤©æ•¸</span>
            <input type="number" id="new-trip-days" value="5">
            <span class="input-label">æˆå“¡ (ç”¨é€—è™Ÿéš”é–‹)</span>
            <input type="text" id="new-trip-members" placeholder="æˆ‘, åª½åª½, çˆ¸çˆ¸" value="æˆ‘">
            
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn" onclick="closeModal('create-trip')" style="flex:1; border-color:#EEE; color:#999;">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createNewTrip()" style="flex:1;">å»ºç«‹</button>
            </div>
        </div>
    </div>

    <!-- 2. è¡Œç¨‹ç·¨è¼¯ -->
    <div id="modal-itinerary" class="modal hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary);" id="modal-title-itinerary">âœ¨ è¡Œç¨‹</h3>
            <div style="display:flex; gap:10px;">
                <input type="time" id="i-time" style="width:40%">
                <select id="i-type" style="width:60%">
                    <option value="spot">æ™¯é»</option>
                    <option value="food">ç¾é£Ÿ</option>
                    <option value="shop">è³¼ç‰©</option>
                    <option value="transport">äº¤é€š</option>
                    <option value="hotel">ä½å®¿</option>
                    <option value="other">å…¶ä»–</option>
                </select>
            </div>
            <input type="text" id="i-title" placeholder="åç¨±">
            <div style="position:relative;">
                <input type="text" id="i-loc" placeholder="åœ°é» (Google Maps)" style="padding-right:35px;">
                <div style="position:absolute; right:10px; top:12px; color:var(--primary);"><svg class="icon-svg icon-sm"><use href="#icon-pin"></use></svg></div>
            </div>
            <textarea id="i-note" placeholder="å‚™è¨»..." style="height:60px;"></textarea>
            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="closeModal('itinerary')" style="flex:1; border-color:#EEE; color:#999;">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveItinerary()" style="flex:1;">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- 3. è¨˜å¸³ (å«æˆå“¡æŒ‰éµã€æ”¯ä»˜æ–¹å¼) -->
    <div id="modal-money" class="modal hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary);">âœ¨ è¨˜ä¸€ç­†</h3>
            <span class="input-label">æ—¥æœŸ</span>
            <input type="date" id="m-date">
            <span class="input-label">é …ç›®</span>
            <input type="text" id="m-title" placeholder="ä¾‹å¦‚: æ‹‰éºµ">
            
            <div style="display:flex; gap:10px;">
                <select id="m-curr" style="width:80px;">
                    <option value="TWD">TWD</option>
                    <option value="JPY">JPY</option>
                    <option value="KRW">KRW</option>
                    <option value="USD">USD</option>
                </select>
                <input type="number" id="m-cost" placeholder="é‡‘é¡" inputmode="decimal">
            </div>
            
            <span class="input-label">åˆ†é¡</span>
            <select id="m-cat">
                <option value="food">é£²é£Ÿ</option>
                <option value="shop">è³¼ç‰©</option>
                <option value="transport">äº¤é€š</option>
                <option value="fun">å¨›æ¨‚</option>
                <option value="other">å…¶ä»–</option>
            </select>
            
            <span class="input-label">èª°å…ˆä»˜çš„</span>
            <div id="m-payer-wrapper" class="chip-group"></div>
            
            <span class="input-label">æ”¯ä»˜æ–¹å¼</span>
            <div class="chip-group">
                <button class="chip-btn chip-btn-method" onclick="selectMethod(this, 'cash')">ç¾é‡‘</button>
                <button class="chip-btn chip-btn-method" onclick="selectMethod(this, 'card')">ä¿¡ç”¨å¡</button>
                <button class="chip-btn chip-btn-method" onclick="selectMethod(this, 'other')">å…¶ä»–</button>
            </div>
            <input type="text" id="m-method-other" placeholder="è¼¸å…¥æ–¹å¼ (ä¾‹: è¥¿ç“œå¡)" class="hidden">

            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn" onclick="closeModal('money')" style="flex:1; border-color:#EEE; color:#999;">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveMoney()" style="flex:1;">å„²å­˜</button>
            </div>
        </div>
    </div>

<script>
    const DB_KEY = 'trip_v9_members';
    let allTrips = [];
    let currentTrip = null;
    let appState = { dayIdx: 0, editId: null };
    
    // è¨˜å¸³æš«å­˜ç‹€æ…‹
    let moneyState = { payer: '', method: 'cash' };

    window.onload = function() {
        const saved = localStorage.getItem(DB_KEY);
        if (saved) { try { allTrips = JSON.parse(saved); } catch(e) {} }
        renderHome();
    };
    function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(allTrips)); }

    // --- Home ---
    function renderHome() {
        document.getElementById('view-home').classList.remove('hidden');
        document.getElementById('view-detail').classList.add('hidden');
        const list = document.getElementById('trip-list-container');
        list.innerHTML = '';
        if (allTrips.length === 0) list.innerHTML = '<div style="text-align:center; color:#CCC; margin-top:50px;">é»æ“Šä¸‹æ–¹ ï¼‹ æ–°å¢æ—…ç¨‹</div>';
        
        allTrips.forEach(t => {
            const div = document.createElement('div');
            div.className = 'trip-card';
            div.onclick = () => openTrip(t.id);
            div.innerHTML = `
                <div><h3 style="margin:0; color:#555;">${t.name}</h3><div style="font-size:0.85rem; color:#999; margin-top:5px;">ğŸ“… ${t.startDate} (${t.days}å¤©)</div></div>
                <button class="btn-icon" onclick="deleteTrip(event, ${t.id})" style="color:var(--accent); background:transparent; border:none;"><svg class="icon-svg"><use href="#icon-trash"></use></svg></button>
            `;
            list.appendChild(div);
        });
    }

    function createNewTrip() {
        const name = document.getElementById('new-trip-name').value;
        const date = document.getElementById('new-trip-date').value;
        const days = parseInt(document.getElementById('new-trip-days').value);
        const membersStr = document.getElementById('new-trip-members').value;
        
        if(!name || !date || !days) return alert('è«‹å¡«å¯«å®Œæ•´');
        
        // è™•ç†æˆå“¡åå–®
        let members = membersStr.split(/[,ï¼Œ\s]+/).filter(Boolean);
        if(members.length === 0) members = ['æˆ‘'];

        allTrips.push({
            id: Date.now(), name, startDate: date, days, members,
            itinerary: [], money: [], shopping: [], packing: [], flights: {},
            notes: { hotel: '', flight: '' }
        });
        saveData(); closeModal('create-trip'); renderHome();
    }

    function deleteTrip(e, id) {
        e.stopPropagation();
        if(confirm('ç¢ºå®šåˆªé™¤å—ï¼Ÿ')) {
            allTrips = allTrips.filter(t => t.id !== id);
            saveData(); renderHome();
        }
    }

    // --- Detail ---
    function openTrip(id) {
        currentTrip = allTrips.find(t => t.id === id);
        if(!currentTrip.members) currentTrip.members = ['æˆ‘']; // èˆŠè³‡æ–™ç›¸å®¹
        
        document.getElementById('view-home').classList.add('hidden');
        document.getElementById('view-detail').classList.remove('hidden');
        document.getElementById('header-trip-name').innerText = currentTrip.name;
        
        document.getElementById('note-hotel').value = currentTrip.notes.hotel || '';
        document.getElementById('note-flight').value = currentTrip.notes.flight || '';

        appState.dayIdx = 0;
        switchTab('info');
        renderPacking();
        renderAllDetail();
    }

    function goHome() { currentTrip = null; renderHome(); }

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById('tab-' + tab).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const idx = tab === 'info' ? 0 : tab === 'itinerary' ? 1 : tab === 'money' ? 2 : 3;
        document.querySelectorAll('.nav-item')[idx].classList.add('active');
    }

    function renderAllDetail() {
        renderDayTabs('day-tabs-itinerary');
        renderDayTabs('day-tabs-money');
        renderItinerary();
    }

    function saveGlobalNote(type, val) {
        currentTrip.notes[type] = val; saveData();
    }

    function getTripDate(idx) {
        const d = new Date(currentTrip.startDate); d.setDate(d.getDate() + idx);
        return d.toISOString().split('T')[0];
    }
    function getDisplayDate(idx) {
        const d = new Date(currentTrip.startDate); d.setDate(d.getDate() + idx);
        return (d.getMonth()+1) + '/' + d.getDate();
    }
    function renderDayTabs(containerId) {
        const el = document.getElementById(containerId); el.innerHTML = '';
        for(let i=0; i<currentTrip.days; i++) {
            const btn = document.createElement('div');
            btn.className = `day-chip ${i===appState.dayIdx?'active':''}`;
            btn.innerText = `D${i+1} ${getDisplayDate(i)}`;
            btn.onclick = () => { appState.dayIdx = i; renderAllDetail(); };
            el.appendChild(btn);
        }
    }

    // --- Itinerary & Flight ---
    function saveFlightInput(field, val) {
        if(!currentTrip.flights[appState.dayIdx]) currentTrip.flights[appState.dayIdx] = {};
        currentTrip.flights[appState.dayIdx][field] = val; saveData();
    }
    function renderItinerary() {
        const list = document.getElementById('list-itinerary');
        const flightDiv = document.getElementById('flight-section');
        list.innerHTML = ''; flightDiv.innerHTML = '';

        if(appState.dayIdx === 0 || appState.dayIdx === currentTrip.days - 1) {
            const f = currentTrip.flights[appState.dayIdx] || {};
            flightDiv.innerHTML = `
                <div class="boarding-pass">
                    <div class="bp-header">BOARDING PASS</div>
                    <div class="bp-body">
                        <div class="bp-row">
                            <div style="text-align:center;">
                                <input type="time" class="bp-time" value="${f.depTime||''}" oninput="saveFlightInput('depTime', this.value)">
                                <input class="bp-code" placeholder="TPE" value="${f.dep||''}" maxlength="3" oninput="saveFlightInput('dep', this.value.toUpperCase())">
                            </div>
                            <div class="bp-center">
                                <input class="bp-flight-no" placeholder="èˆªç­ä»£è™Ÿ" value="${f.code||''}" oninput="saveFlightInput('code', this.value.toUpperCase())">
                                <div class="bp-line"><span class="bp-icon">âœˆ</span></div>
                            </div>
                            <div style="text-align:center;">
                                <input type="time" class="bp-time" value="${f.arrTime||''}" oninput="saveFlightInput('arrTime', this.value)">
                                <input class="bp-code" placeholder="NRT" value="${f.arr||''}" maxlength="3" oninput="saveFlightInput('arr', this.value.toUpperCase())">
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        const items = currentTrip.itinerary.filter(i => i.dayIdx === appState.dayIdx);
        if(items.length === 0) list.innerHTML = '<div style="text-align:center; color:#DDD; padding:20px;">å°šç„¡è¡Œç¨‹</div>';
        items.forEach(item => {
            const iconMap = { spot:'ğŸ¡', food:'ğŸ™', shop:'ğŸ›ï¸', transport:'ğŸš‹', hotel:'ğŸ¨', other:'âœ¨' };
            const mapBtn = item.loc ? `<button class="it-map-btn" onclick="openMap(event, '${item.loc}')"><svg class="icon-svg icon-sm"><use href="#icon-pin"></use></svg></button>` : '';
            const note = item.note ? `<div class="item-note">${item.note}</div>` : '';
            list.innerHTML += `
                <div class="timeline-item" onclick="editItinerary(${item.id})">
                    <div class="time-bubble">${item.time}</div>
                    <div class="itinerary-card">
                        <div class="it-header"><span class="it-icon">${iconMap[item.type]||'âœ¨'}</span><span class="it-title">${item.title}</span></div>
                        ${note} ${mapBtn}
                    </div>
                </div>`;
        });
    }
    function openMap(e, loc) { e.stopPropagation(); window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`, '_blank'); }

    // --- Itinerary Edit ---
    function openNewItinerary() {
        appState.editId = null;
        document.getElementById('modal-title-itinerary').innerText = "âœ¨ æ–°å¢è¡Œç¨‹";
        document.getElementById('i-time').value = ''; document.getElementById('i-title').value = '';
        document.getElementById('i-loc').value = ''; document.getElementById('i-note').value = '';
        openModal('itinerary');
    }
    function editItinerary(id) {
        const item = currentTrip.itinerary.find(i => i.id === id);
        if(!item) return;
        appState.editId = id;
        document.getElementById('modal-title-itinerary').innerText = "âœï¸ ç·¨è¼¯è¡Œç¨‹";
        document.getElementById('i-time').value = item.time; document.getElementById('i-type').value = item.type;
        document.getElementById('i-title').value = item.title; document.getElementById('i-loc').value = item.loc;
        document.getElementById('i-note').value = item.note || '';
        openModal('itinerary');
    }
    function saveItinerary() {
        const time = document.getElementById('i-time').value;
        const title = document.getElementById('i-title').value;
        if(!time || !title) return alert('å¿…å¡«');
        const newData = {
            id: appState.editId || Date.now(), dayIdx: appState.dayIdx,
            time, type: document.getElementById('i-type').value,
            title, loc: document.getElementById('i-loc').value,
            note: document.getElementById('i-note').value
        };
        if(appState.editId) {
            const idx = currentTrip.itinerary.findIndex(i => i.id === appState.editId);
            if(idx!==-1) currentTrip.itinerary[idx] = newData;
        } else { currentTrip.itinerary.push(newData); }
        currentTrip.itinerary.sort((a,b)=>a.time.localeCompare(b.time));
        saveData(); closeModal('itinerary'); renderItinerary();
    }

    // --- Money Logic (Updated with Members & Method) ---
    function openMoneyModal() {
        document.getElementById('m-title').value = ''; 
        document.getElementById('m-cost').value = '';
        document.getElementById('m-date').value = getTripDate(appState.dayIdx);
        
        // æ¸²æŸ“æˆå“¡æŒ‰éˆ•
        const payerContainer = document.getElementById('m-payer-wrapper');
        payerContainer.innerHTML = '';
        currentTrip.members.forEach((m, idx) => {
            const btn = document.createElement('button');
            btn.className = `chip-btn ${idx===0 ? 'active' : ''}`; // é è¨­é¸ç¬¬ä¸€å€‹
            btn.innerText = m;
            btn.onclick = () => {
                document.querySelectorAll('#m-payer-wrapper .chip-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                moneyState.payer = m;
            };
            payerContainer.appendChild(btn);
        });
        // é è¨­ payer
        moneyState.payer = currentTrip.members[0];

        // é‡ç½®æ”¯ä»˜æ–¹å¼
        selectMethod(document.querySelector('.chip-btn-method'), 'cash');
        
        openModal('money');
    }

    function selectMethod(el, method) {
        document.querySelectorAll('.chip-btn-method').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        moneyState.method = method;
        
        const otherInput = document.getElementById('m-method-other');
        if (method === 'other') otherInput.classList.remove('hidden');
        else otherInput.classList.add('hidden');
    }

    function saveMoney() {
        const title = document.getElementById('m-title').value;
        const cost = document.getElementById('m-cost').value;
        
        let methodStr = moneyState.method;
        if (moneyState.method === 'cash') methodStr = 'ç¾é‡‘';
        else if (moneyState.method === 'card') methodStr = 'ä¿¡ç”¨å¡';
        else methodStr = document.getElementById('m-method-other').value || 'å…¶ä»–';

        if(!title || !cost) return;
        
        currentTrip.money.push({
            id: Date.now(), dayIdx: appState.dayIdx,
            date: document.getElementById('m-date').value,
            title, cost: parseFloat(cost),
            curr: document.getElementById('m-curr').value,
            type: document.getElementById('m-cat').value,
            payer: moneyState.payer,
            method: methodStr
        });
        saveData(); closeModal('money'); renderMoney();
    }

    function renderMoney() {
        const list = document.getElementById('list-money'); list.innerHTML = '';
        const items = currentTrip.money.filter(i => i.dayIdx === appState.dayIdx);
        let total = 0; items.forEach(i=>total+=i.cost);
        [...items].reverse().forEach(item => {
            // åœ–ç¤ºåˆ¤æ–·
            let methodIcon = '';
            if(item.method === 'ç¾é‡‘') methodIcon = '<svg class="icon-svg icon-xs"><use href="#icon-cash"></use></svg>';
            else if(item.method === 'ä¿¡ç”¨å¡') methodIcon = '<svg class="icon-svg icon-xs"><use href="#icon-card"></use></svg>';
            else methodIcon = 'âœ¨';

            list.innerHTML += `
                <div class="money-card">
                    <div>
                        <div style="font-size:0.8rem; color:#AAA;">${item.date}</div>
                        <div style="font-weight:bold; color:#555;">
                            ${item.title} 
                            <span class="money-payer-badge">${item.payer}</span>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:bold; color:var(--text);">${item.curr} ${item.cost}</div>
                        <div class="money-method-badge">${methodIcon} ${item.method}</div>
                    </div>
                    <button class="btn-icon" onclick="delItem(event, 'money', ${item.id})" style="position:absolute; right:5px; top:5px; padding:5px;"><svg class="icon-svg icon-sm"><use href="#icon-trash"></use></svg></button>
                </div>`;
        });
        document.getElementById('day-total').innerText = total.toLocaleString();
    }

    // --- Shopping & Packing ---
    function addShoppingItem() {
        const input = document.getElementById('shop-input');
        const price = document.getElementById('shop-price');
        const fileInput = document.getElementById('shop-img');
        if(!input.value) return;
        const save = (img) => {
            currentTrip.shopping.push({ id:Date.now(), text:input.value, price:price.value, checked:false, image:img });
            saveData(); input.value = ''; price.value = ''; fileInput.value = ''; renderShopping();
        };
        if(fileInput.files[0]) {
            const r = new FileReader();
            r.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                    const s = 300/img.width; c.width=300; c.height=img.height*s;
                    ctx.drawImage(img,0,0,c.width,c.height); save(c.toDataURL('image/jpeg',0.5));
                }; img.src = e.target.result;
            }; r.readAsDataURL(fileInput.files[0]);
        } else save(null);
    }
    function renderShopping() {
        const list = document.getElementById('list-shopping'); list.innerHTML = '';
        currentTrip.shopping.forEach(item => {
            const imgHtml = item.image ? `<img src="${item.image}" class="shop-thumb" onclick="window.open('${item.image}')">` : `<div class="shop-placeholder">ç„¡åœ–</div>`;
            list.innerHTML += `
                <div class="shop-item">
                    ${imgHtml}
                    <div style="flex:1;">
                        <div style="font-weight:bold; color:#555;">${item.text}</div>
                        <div style="font-size:0.85rem; color:#F4CBA6;">${item.price||''}</div>
                    </div>
                    <button class="btn-icon" onclick="delItem(event, 'shopping', ${item.id})"><svg class="icon-svg icon-sm"><use href="#icon-trash"></use></svg></button>
                </div>`;
        });
    }
    function addPackItem() {
        const val = document.getElementById('pack-input').value;
        if(!val) return;
        currentTrip.packing.push({id:Date.now(), text:val, checked:false});
        saveData(); document.getElementById('pack-input').value = ''; renderPacking();
    }
    function renderPacking() {
        const list = document.getElementById('list-packing'); list.innerHTML = '';
        currentTrip.packing.forEach(item => {
            list.innerHTML += `
                <div class="check-item ${item.checked?'checked':''}">
                    <input type="checkbox" ${item.checked?'checked':''} onchange="toggleCheck('packing', ${item.id})">
                    <span style="flex:1;">${item.text}</span>
                    <button class="btn-icon" onclick="delItem(event, 'packing', ${item.id})" style="background:none; border:none; color:#DDD;"><svg class="icon-svg icon-sm"><use href="#icon-trash"></use></svg></button>
                </div>`;
        });
    }

    // --- Common ---
    function toggleCheck(type, id) {
        const i = currentTrip[type].find(x => x.id === id);
        if(i) { i.checked = !i.checked; saveData(); type==='packing' ? renderPacking() : renderShopping(); }
    }
    function delItem(e, type, id) {
        e.stopPropagation(); if(!confirm('åˆªé™¤ï¼Ÿ')) return;
        currentTrip[type] = currentTrip[type].filter(x => x.id !== id);
        saveData();
        if(type==='shopping') renderShopping(); else if(type==='packing') renderPacking(); else if(type==='money') renderMoney();
    }
    function closeModal(id) { document.getElementById('modal-'+id).classList.add('hidden'); }
    function openModal(id) { document.getElementById('modal-'+id).classList.remove('hidden'); }
</script>
</body>
</html>
