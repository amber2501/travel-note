<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>旅遊規劃手帳</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <!-- 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- 拖曳排序套件 SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            /* 核心色系 */
            --primary: #7FA9BE; 
            --primary-light: #EDF6F9; 
            --primary-dark: #5A8296;
            --accent: #E89E9B; 
            --accent-bg: #FFF5F5;
            --text: #2D3748; 
            --text-light: #718096; 
            --text-white: #FFFFFF;
            --text-done: #CBD5E0;
            --bg-body: #F7F9FC; 
            --card-bg: #FFFFFF;
            --input-bg: #F1F5F9;
            
            /* 尺寸變數 */
            --nav-height: 70px; 
            --radius-L: 24px; 
            --radius-M: 16px; 
            --radius-S: 12px;
            --shadow-card: 0 4px 15px rgba(148, 163, 184, 0.1);
            --shadow-float: 0 8px 25px rgba(127, 169, 190, 0.3);

            /* 馬卡龍色系 */
            --c-spot-bg: #F2F9FD; --c-spot-line: #4299E1; --c-spot-icon: #3182CE;
            --c-food-bg: #FFFEF9; --c-food-line: #ED8936; --c-food-icon: #DD6B20;
            --c-shop-bg: #FFF9FB; --c-shop-line: #ED64A6; --c-shop-icon: #D53F8C;
            --c-trans-bg:#F8FFF9; --c-trans-line:#48BB78; --c-trans-icon: #38A169;
            --c-other-bg:#FAFCFE; --c-other-line:#718096; --c-other-icon: #4A5568;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Zen Maru Gothic', sans-serif; background-color: var(--bg-body); color: var(--text); padding-bottom: calc(var(--nav-height) + 40px); -webkit-overflow-scrolling: touch; }
        .hidden { display: none !important; }

        /* Icons */
        .icon-svg { width: 22px; height: 22px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; pointer-events: none; }
        .icon-sm { width: 16px; height: 16px; stroke-width: 2; }
        
        /* UI Components */
        .btn { border: none; border-radius: var(--radius-M); padding: 12px 20px; font-size: 0.95rem; font-weight: 700; cursor: pointer; background: white; color: var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.02); display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-family: inherit; transition: all 0.2s; width: 100%;}
        .btn:active { transform: scale(0.96); filter: brightness(0.95); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(127, 169, 190, 0.4); }
        .btn-ghost { background: transparent; box-shadow: none; color: var(--text-light); padding: 8px; cursor: pointer; border: none; transition: 0.2s; width: auto; position: relative; z-index: 10;}
        .btn-ghost:active { transform: scale(0.9); color: var(--primary); }
        
        .btn-del { color: var(--accent); background: var(--accent-bg); padding: 6px 12px; font-size: 0.8rem; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s;}
        .btn-edit { color: var(--primary); background: var(--primary-light); padding: 6px 12px; font-size: 0.8rem; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-right: 6px; transition: 0.2s;}
        .btn-del:active, .btn-edit:active { transform: scale(0.9); }

        /* Inputs */
        input, select, textarea { width: 100%; padding: 0 16px; height: 48px; min-height: 48px; border: 1px solid transparent; border-radius: var(--radius-S); background: var(--input-bg); font-size: 16px; outline: none; margin-bottom: 0; font-family: inherit; font-weight: 500; color: var(--text); transition: 0.2s; appearance: none; -webkit-appearance: none; display: flex; align-items: center;}
        textarea { padding: 14px 16px; height: auto; min-height: auto; resize: none; line-height: 1.5; }
        input:focus, textarea:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(127, 169, 190, 0.15); }
        input[disabled] { background-color: #E2E8F0; color: #A0AEC0; cursor: not-allowed; }

        /* Layout */
        .row { display: flex; gap: 12px; width: 100%; margin-bottom: 15px; align-items: flex-start;}
        .col { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 6px;}
        .input-group { margin-bottom: 15px; width: 100%; }
        .card-label { font-size: 0.9rem; color: var(--text-light); font-weight: 700; margin-left: 4px; display: block; margin-bottom: 6px; }

        /* Header */
        .sticky-header { position: sticky; top: 0; z-index: 100; background: rgba(247, 249, 252, 0.95); backdrop-filter: blur(12px); padding-top: env(safe-area-inset-top); border-bottom: 1px solid rgba(0,0,0,0.03); }
        .header-top { position: relative; height: 60px; display: flex; align-items: center; padding: 0 15px; }
        .header-title { position: absolute; left: 50%; transform: translateX(-50%); font-size: 1.3rem; color: var(--text); font-weight: 900; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60%; text-align: center; pointer-events: none;}
        .back-btn, .btn-ghost { position: relative; z-index: 10; }
        
        .container { padding: 20px; padding-bottom: 100px; max-width: 600px; margin: 0 auto; }
        
        .card { background: var(--card-bg); border-radius: var(--radius-L); padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow-card); position: relative; border: 1px solid rgba(255,255,255,0.8); }
        .card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 15px; color: var(--primary-dark); font-weight: 800; font-size: 1.1rem; }

        /* Nav & FAB */
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 420px; height: var(--nav-height); background: rgba(255,255,255,0.98); backdrop-filter: blur(20px); display: flex; justify-content: space-around; align-items: center; border-radius: 40px; box-shadow: var(--shadow-float); z-index: 1000; border: 1px solid rgba(255,255,255,0.5); padding: 0 10px;}
        .nav-item { flex: 1; border: none; background: none; color: #C4C8D0; font-size: 0.7rem; font-weight: 700; display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 10px 0; transition: 0.3s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active svg { stroke-width: 2.5; filter: drop-shadow(0 2px 4px rgba(127,169,190,0.3));}
        
        .fab { position: fixed; bottom: 105px; right: 25px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; border: none; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-float); z-index: 900; cursor: pointer; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .fab:active { transform: scale(0.9) rotate(90deg); background: var(--primary-dark); }
        
        /* Tabs */
        .sub-nav { display: flex; padding: 0 20px 10px; gap: 10px; overflow-x: auto; scrollbar-width: none; }
        .sub-nav-btn { flex: 0 0 auto; padding: 8px 18px; border: 1px solid transparent; background: white; border-radius: 30px; font-size: 0.9rem; color: var(--text-light); font-weight: 700; box-shadow: 0 2px 6px rgba(0,0,0,0.04); transition: 0.2s; display: flex; align-items: center; gap: 6px; }
        .sub-nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(127, 169, 190, 0.3); transform: translateY(-1px); }

        /* Shopping List Item Style (UPDATED) */
        .check-item { display: flex; flex-direction: column; padding: 16px; background: white; border-radius: var(--radius-M); margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); border: 1px solid #F0F0F0; transition: 0.2s; user-select: none; }
        .check-item:active { transform: scale(0.99); background: #FAFAFA;}
        .check-item-body { display: flex; align-items: stretch; width: 100%; } /* Wrapper for top part */
        .sortable-ghost { opacity: 0.4; background: #F2F9FD; }
        
        .check-left { flex: 1; display: flex; flex-direction: column; min-width: 0; gap: 8px; justify-content: center;}
        .check-name-row { display: flex; align-items: center; gap: 12px; }
        .check-box { width: 30px; height: 30px; border: 2px solid var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: white; transition: 0.2s; cursor: pointer; }
        .checked .check-box { background: var(--primary); }
        .checked .check-box::after { content: '✓'; color: white; font-size: 18px; font-weight: bold; }
        
        .check-text { font-weight: bold; font-size: 1.05rem; color: var(--text); transition: 0.2s; line-height: 1.3; }
        
        .check-separator { height: 1px; border-bottom: 2px dashed #E2E8F0; width: 100%; }
        
        .check-meta-row { display: flex; gap: 8px; align-items: center; padding-left: 42px; }
        .meta-pill { font-size: 0.75rem; padding: 3px 10px; border-radius: 12px; font-weight: bold; display: flex; align-items: center; gap: 4px; }
        .meta-price { background: #F0FFF4; color: #38A169; }
        .meta-loc { background: #EBF8FF; color: #3182CE; }
        .meta-time { background: #EDF2F7; color: #4A5568; }

        .meta-pill svg { width: 12px; height: 12px; }

        .check-right { display: flex; flex-direction: column; justify-content: space-between; align-items: flex-end; padding-left: 10px; flex-shrink: 0; min-width: 60px; }
        .member-badge-pill { font-size: 0.7rem; background: var(--text); color: white; padding: 4px 10px; border-radius: 10px; font-weight: bold; opacity: 0.8;}
        
        .btn-list-action-group { display: flex; gap: 8px; }
        .btn-list-del { width: 32px; height: 32px; color: #E53E3E; background: #FFF5F5; border-radius: 10px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s;}
        .btn-list-edit { width: 32px; height: 32px; color: var(--primary); background: var(--primary-light); border-radius: 10px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s;}
        .btn-list-del:active, .btn-list-edit:active { transform: scale(0.9); }

        .checked .check-text { text-decoration: line-through; color: var(--text-done); }
        .checked .meta-pill { opacity: 0.5; }
        
        /* Note Dropdown Styles */
        .check-note-panel { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #E2E8F0; font-size: 0.9rem; color: #666; white-space: pre-wrap; padding-left: 42px; line-height: 1.6;}
        .check-item.show-note .check-note-panel { display: block; }
        .note-toggle-btn { background: none; border: none; color: var(--primary); cursor: pointer; font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; transition: 0.2s; margin-left: 5px; }
        .note-toggle-btn:active { background: var(--primary-light); }
        .check-item.show-note .note-toggle-btn { transform: rotate(180deg); }

        /* Packing List Simplification */
        .pack-item-card { background: white; border-radius: 16px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 6px rgba(0,0,0,0.03); border: 1px solid #F5F5F5; user-select: none; }
        .pack-info { flex: 1; min-width: 0; display: flex; align-items: center; gap: 10px;}
        .pack-name { font-weight: bold; font-size: 1rem; color: var(--text); }
        .pack-members-row { display: flex; gap: 6px; }
        .pack-avatar { width: 32px; height: 32px; border-radius: 50%; background: #EDF2F7; color: #A0AEC0; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 800; cursor: pointer; transition: 0.2s; border: 2px solid transparent; }
        .pack-avatar.checked { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(127,169,190,0.4); transform: scale(1.05); }
        .pack-btn-del { margin-left: 12px; color: #E53E3E; background: transparent; border: none; cursor: pointer; padding: 5px; }

        /* Items (Common) */
        .info-card-item { background: #FFFFFF; border-radius: var(--radius-M); padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); border: 1px solid #F0F0F0; display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .info-card-content { flex: 1; min-width: 0; }
        .info-card-sub { font-size: 0.85rem; color: var(--text-light); margin-top: 4px; display: flex; align-items: center; gap: 5px; font-weight: 500;}
        .info-card-sub .icon-svg { width: 16px; height: 16px; }
        .item-icon-box { width: 42px; height: 42px; border-radius: 12px; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        
        .note-row { display: flex; align-items: center; gap: 5px; color: var(--text-light); font-size: 0.8rem; margin-top: 4px; }
        .note-row svg { width: 14px; height: 14px; flex-shrink: 0; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: 0.3s; }
        .modal:not(.hidden) { opacity: 1; visibility: visible; }
        .modal-content { background: white; width: 90%; max-width: 380px; padding: 25px; border-radius: 28px; max-height: 85vh; overflow-y: auto; transform: scale(0.95); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
        .modal:not(.hidden) .modal-content { transform: scale(1); }
        .modal h3 { margin: 0 0 20px; text-align: center; color: var(--primary); font-size: 1.3rem; }

        /* Boarding Pass */
        .bp-card { background: white; border-radius: var(--radius-M); margin-bottom: 12px; overflow: hidden; position: relative; box-shadow: var(--shadow-card); filter: drop-shadow(0 4px 10px rgba(0,0,0,0.05)); }
        .bp-header { background: var(--primary); color: white; padding: 10px; text-align: center; font-size: 0.9rem; font-weight: bold; letter-spacing: 2px; }
        .bp-body { padding: 20px 15px; display: flex; justify-content: space-between; align-items: center; }
        .bp-group { text-align: center; flex: 1; }
        .bp-code { font-size: 2rem; font-weight: 900; color: var(--text); display: block; line-height: 1; margin-bottom: 5px;}
        .bp-time { font-size: 0.9rem; color: var(--text); font-weight: bold; background: #F0F4F8; padding: 4px 8px; border-radius: 6px; display: inline-block;}
        /* 航廈顯示樣式 */
        .bp-term { font-size: 0.75rem; color: var(--primary-dark); background: var(--primary-light); padding: 2px 6px; border-radius: 4px; font-weight: bold; display: inline-block; margin-bottom: 4px; vertical-align: middle; }

        .bp-center { display: flex; flex-direction: column; align-items: center; width: 90px; }
        .bp-line { width: 100%; height: 2px; background: #E0E0E0; position: relative; margin: 10px 0; }
        .bp-line::after { content:''; position:absolute; top:-10px; left:50%; transform:translateX(-50%); width:20px; height:20px; background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%237FA9BE'%3E%3Cpath d='M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z'/%3E%3C/svg%3E") no-repeat center; background-size:contain; background-color:white; padding:0 2px;} 
        .bp-duration { font-size: 0.75rem; color: var(--text-light); font-weight: bold; margin-top: 4px; }
        .flight-row-item { border: 1px solid #E2E8F0; border-radius: 12px; padding: 12px; margin-bottom: 10px; background: #FAFAFA; position: relative;}
        .flight-del-btn { position: absolute; top: 8px; right: 8px; color: #E53E3E; background: transparent; border: none; font-weight: bold; cursor: pointer; }

        /* Weather (Update: Dusty Sky Blue - Less Gloomy, More Friendly) */
        .weather-card { 
            border-radius: var(--radius-L); 
            padding: 25px 20px; 
            margin-bottom: 25px; 
            background: linear-gradient(135deg, #74AED4 0%, #BBE3F7 100%); 
            box-shadow: 0 10px 30px rgba(116, 174, 212, 0.4); 
            border: none; position: relative; overflow: hidden; color: white;
        }
        .w-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.3); }
        .w-city { font-weight: 800; font-size: 1.2rem; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .w-desc { font-size: 0.95rem; color: rgba(255,255,255,0.9); display: flex; align-items: center; gap: 6px; margin-top: 4px; font-weight: bold;}
        .w-main-temp { font-size: 3.5rem; font-weight: 900; color: white; line-height: 1; text-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .w-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .w-stat { background: rgba(255,255,255,0.2); border-radius: 16px; padding: 10px 5px; text-align: center; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(5px); }
        .w-stat-label { font-size: 0.7rem; color: rgba(255,255,255,0.8); margin-bottom: 4px; font-weight: bold; }
        .w-stat-val { font-size: 0.9rem; color: white; font-weight: 800; }

        /* Timeline & Itinerary (Colorful) */
        .timeline-wrapper { position: relative; padding-left: 10px; margin-top: 20px; padding-bottom: 20px;}
        .timeline-line { position: absolute; left: 38px; top: 15px; bottom: 15px; width: 2px; background: #E2E8F0; z-index: 0; border-radius: 2px; }
        .timeline-item { display: flex; gap: 15px; margin-bottom: 24px; position: relative; z-index: 1; align-items: flex-start; }
        .time-bubble { flex-shrink: 0; width: 56px; text-align: center; background: white; color: var(--primary-dark); border-radius: 12px; padding: 10px 0; font-weight: 800; font-size: 0.95rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #EDF2F7; z-index: 2; display: flex; flex-direction: column; justify-content: center; min-height: 50px;}
        
        /* Full Colored Itinerary Cards */
        .it-card { flex: 1; border-radius: 20px; padding: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: flex; align-items: flex-start; gap: 14px; position: relative; overflow: hidden; transition: 0.1s; border: 1px solid rgba(0,0,0,0.03);}
        .it-card:active { transform: scale(0.99); filter: brightness(0.95); }
        .it-icon { width: 36px; height: 36px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); background: white !important;}
        .btn-map-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: white; color: #4299E1; border: 1px solid rgba(0,0,0,0.05); padding: 0; box-shadow: 0 2px 6px rgba(0,0,0,0.05); transition: 0.2s; }
        /* Itinerary Note with Line Break */
        .it-note { font-size: 0.85rem; color: var(--text); opacity: 0.8; margin-top: 4px; white-space: pre-wrap; }
        
        /* Macaron Color Backgrounds */
        .type-spot { background: var(--c-spot-bg); border-left: 4px solid var(--c-spot-line); } .type-spot .it-icon { color: var(--c-spot-icon); }
        .type-food { background: var(--c-food-bg); border-left: 4px solid var(--c-food-line); } .type-food .it-icon { color: var(--c-food-icon); }
        .type-shop { background: var(--c-shop-bg); border-left: 4px solid var(--c-shop-line); } .type-shop .it-icon { color: var(--c-shop-icon); }
        .type-transport { background: var(--c-trans-bg); border-left: 4px solid var(--c-trans-line); } .type-transport .it-icon { color: var(--c-trans-icon); }
        .type-other { background: var(--c-other-bg); border-left: 4px solid var(--c-other-line); } .type-other .it-icon { color: var(--c-other-icon); }

        /* Transport Time Styling */
        .trans-time-group { display: flex; flex-direction: column; align-items: center; width: 100%; gap: 2px; }
        .trans-t-val { font-size: 0.8rem; font-weight: 800; color: var(--text); }
        .trans-arrow { font-size: 0.7rem; color: #CBD5E0; line-height: 0.8; }

        /* Opening Hours Badge */
        .open-badge { display: inline-flex; align-items: center; gap: 4px; background: rgba(255,255,255,0.6); color: var(--text-light); padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; margin-top: 6px; backdrop-filter: blur(4px); }
        .open-badge svg { width: 12px; height: 12px; }

        /* Night Stay */
        .night-stay-box { margin-top: 30px; background: #2D3748; color: white; border-radius: var(--radius-M); padding: 18px; display: flex; align-items: center; gap: 15px; box-shadow: 0 10px 20px rgba(45, 55, 72, 0.3); }

        /* Countdown */
        .countdown-banner { background: linear-gradient(120deg, var(--primary-dark), var(--primary)); color: white; border-radius: var(--radius-L); padding: 20px; text-align: center; margin-bottom: 25px; box-shadow: 0 10px 25px rgba(127, 169, 190, 0.4); position: relative; overflow: hidden; }
        .countdown-banner.ended { background: linear-gradient(120deg, #A0AEC0, #718096); box-shadow: none; }
        .countdown-num { font-size: 2.2rem; font-weight: 900; line-height: 1.2; text-shadow: 0 2px 5px rgba(0,0,0,0.1); margin: 5px 0;}
        .countdown-label { font-size: 0.95rem; opacity: 0.9; }

        /* Chips & Tags */
        .chip-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 0; }
        .chip-btn { padding: 0 16px; height: 40px; border-radius: 20px; background: #F1F5F9; color: var(--text-light); border: 1px solid transparent; font-weight: bold; font-size: 0.85rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center;}
        .chip-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(127,169,190,0.3); }
        
        .day-scroller { display: flex; overflow-x: auto; padding: 10px 20px; gap: 10px; scrollbar-width: none; min-height: 85px; }
        
        /* Day Chip Glassmorphism Update */
        .day-chip { 
            flex: 0 0 auto; padding: 10px 5px; border-radius: 20px; min-width: 65px; 
            background: rgba(255, 255, 255, 0.45); 
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            color: var(--text-light); text-align: center; transition: 0.2s; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; 
        }
        .day-chip.active { 
            background: rgba(127, 169, 190, 0.85); /* Primary with opacity */
            color: white; border-color: transparent; 
            box-shadow: 0 4px 10px rgba(127, 169, 190, 0.4); 
            transform: scale(1.05); 
        }

        .d-num { font-size: 0.7rem; font-weight: bold; opacity: 0.8; letter-spacing: 1px;}
        .d-date { font-size: 1.1rem; font-weight: 900; line-height: 1.2;}
        .d-week { font-size: 0.75rem; font-weight: bold; }

        /* Money List Redesign */
        .money-item-row { display: flex; align-items: center; justify-content: space-between; padding: 14px; background: white; border-radius: 16px; margin-bottom: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); border: 1px solid #F0F4F8; transition: transform 0.1s;}
        .money-item-row:active { transform: scale(0.99); }
        .money-info { display: flex; flex-direction: column; gap: 4px; }
        .money-title { font-weight: bold; font-size: 1rem; color: var(--text); }
        .money-meta { display: flex; gap: 6px; font-size: 0.75rem; color: var(--text-light); align-items: center;}
        .money-tag { background: #EDF2F7; padding: 2px 8px; border-radius: 6px; font-weight: bold; color: var(--text-light); }
        .money-amount { font-weight: 900; font-size: 1.1rem; color: var(--primary-dark); }
        
        .daily-total-box {
            background: #fff;
            padding: 10px 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            text-align: right;
            box-shadow: 0 2px 6px rgba(0,0,0,0.03);
            border: 1px solid #F0F4F8;
        }
        .dt-label { font-size: 0.85rem; color: var(--text-light); font-weight: bold; margin-right: 5px; }
        .dt-val { font-size: 1.1rem; color: var(--primary-dark); font-weight: 900; }

        /* Analysis Cards */
        .member-stat-wrapper { margin-bottom: 15px; }
        .member-stat-card { background: linear-gradient(135deg, #7FA9BE 0%, #5A8296 100%); color: white; border-radius: 16px; padding: 16px; cursor: pointer; transition: transform 0.1s; box-shadow: 0 5px 15px rgba(90,130,150,0.3); display: flex; flex-direction: column; gap: 5px; position: relative; z-index: 2;}
        .member-stat-card:active { transform: scale(0.98); }
        .m-stat-header { display: flex; justify-content: space-between; align-items: center; font-weight: 900; font-size: 1.1rem; }
        .m-stat-total { font-size: 0.95rem; opacity: 0.95; font-weight: 700; }
        
        .analysis-detail-box { background: white; border-radius: 0 0 16px 16px; padding: 15px 15px 10px 15px; color: var(--text); box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-top: -10px; padding-top: 25px; border: 1px solid #EDF2F7; position: relative; z-index: 1;}

        /* Split Bill Styles */
        .split-card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid #F0F4F8; position: relative; }
        .split-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 8px;}
        .split-title { font-weight: 900; font-size: 1.05rem; color: var(--text); }
        .split-date { font-size: 0.75rem; color: #999; margin-top: 2px;}
        .split-payer-badge { background: var(--primary); color: white; font-size: 0.75rem; padding: 3px 8px; border-radius: 6px; font-weight: bold; display: inline-flex; align-items: center; gap: 4px;}
        
        .split-member-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; padding: 6px 0; border-bottom: 1px solid #f9f9f9; }
        .split-member-name { font-weight: bold; width: 60px; color: var(--text-light); }
        .split-val-group { text-align: right; flex: 1; display: flex; justify-content: flex-end; gap: 10px; font-size: 0.85rem;}
        .split-label { font-size: 0.7rem; color: #BBB; margin-right: 2px; }
        .split-owe { color: #E53E3E; font-weight: bold; } /* 欠款紅字 */
        .split-clean { color: #38A169; font-weight: bold; opacity: 0.6;} /* 結清綠字 */
        
        /* Modal Table Look */
        .split-input-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; background: #F7FAFC; padding: 8px; border-radius: 10px;}
        .split-input-name { font-weight: bold; width: 60px; font-size: 0.9rem; flex-shrink: 0;}
        .split-input-sm { flex: 1; padding: 0 8px; height: 36px; min-height: 36px; font-size: 0.9rem; background: white; border: 1px solid #E2E8F0; border-radius: 6px;}
        .split-check { width: 24px; height: 24px; border: 1px solid #CBD5E0; border-radius: 6px; display: flex; align-items: center; justify-content: center; background: white; cursor: pointer; color: white;}
        .split-check.active { background: var(--primary); border-color: var(--primary); }

        /* Journal Redesign */
        .journal-card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 25px; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.03); overflow: hidden; }
        .journal-header { display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 12px; border-bottom: 2px dashed #f0f0f0; margin-bottom: 12px; }
        .j-date-box { display: flex; align-items: baseline; gap: 6px; color: var(--primary); }
        .j-day { font-size: 2rem; font-weight: 900; line-height: 1; }
        .j-ym { font-size: 0.9rem; font-weight: bold; color: var(--text-light); }
        .j-writer-badge { font-size: 0.8rem; padding: 4px 12px; border-radius: 12px; font-weight: bold; color: var(--text); opacity: 0.8; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .journal-content { line-height: 1.7; color: var(--text); white-space: pre-wrap; font-size: 1rem; font-weight: 500;}
        
        .j-footer { margin-top: 15px; border-top: 1px solid #f0f0f0; padding-top: 10px; display: flex; justify-content: space-between; align-items: center;}
        .j-last-edit { font-size: 0.75rem; color: #CCC; text-align: right; width: 100%; margin-top: 5px; margin-bottom: 10px;}

        /* Journal Comments */
        .j-comments-section { background: #F9FAFB; margin: 15px -20px -20px -20px; padding: 15px 20px; border-top: 1px solid #F0F0F0; }
        .j-comment-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-start; }
        .j-comment-avatar { width: 30px; height: 30px; border-radius: 50%; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; flex-shrink: 0; }
        .j-comment-bubble { background: white; padding: 8px 12px; border-radius: 12px; border: 1px solid #E2E8F0; flex: 1; font-size: 0.9rem; position: relative;}
        .j-comment-meta { font-size: 0.7rem; color: #A0AEC0; margin-top: 4px; display: flex; justify-content: space-between; align-items: center; }
        .j-del-comment { color: #E53E3E; cursor: pointer; padding: 2px 5px; }

        .j-input-area { display: flex; gap: 8px; margin-top: 10px; }
        .j-input-select { width: 70px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 0.8rem; padding: 0 5px; background: white;}
        .j-input-text { flex: 1; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 0.9rem; padding: 8px 12px; background: white; }
        .j-send-btn { background: var(--primary); color: white; border: none; border-radius: 8px; padding: 0 12px; font-weight: bold; font-size: 0.85rem; cursor: pointer; }

        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; display:flex; justify-content:center; align-items:center; color:var(--primary); font-weight:bold; backdrop-filter: blur(5px); }
        
        .flight-edit-block .row { align-items: center; }
        .tz-select { padding: 0 10px; border: none; background: #E2E8F0; border-radius: var(--radius-S); font-weight: bold; color: var(--text); flex-shrink: 0; width: auto; height: 48px;}
    </style>
</head>
<body>

    <!-- SVG Sprites -->
    <svg style="display:none;">
        <symbol id="icon-plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></symbol>
        <symbol id="icon-book" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></symbol>
        <symbol id="icon-nav-info" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></symbol>
        <symbol id="icon-nav-cal" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></symbol>
        <symbol id="icon-nav-money" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></symbol>
        <symbol id="icon-nav-shop" viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></symbol>
        <symbol id="icon-share" viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></symbol>
        <symbol id="icon-pin" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></symbol>
        <symbol id="icon-phone" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></symbol>
        <symbol id="icon-note" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></symbol>
        <symbol id="icon-clock" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></symbol>
        <symbol id="icon-map-pin" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></symbol>
        <symbol id="icon-plane-real" viewBox="0 0 24 24"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"></path></symbol>
        <symbol id="icon-house" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></symbol>
        <symbol id="icon-ticket" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2"></rect><circle cx="12" cy="12" r="2"></circle><path d="M6 12h.01M18 12h.01"></path></symbol>
        <symbol id="icon-car" viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"></path></symbol>
        <symbol id="icon-spot" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></symbol>
        <symbol id="icon-food" viewBox="0 0 24 24"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></symbol>
        <symbol id="icon-transport" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="8" y1="21" x2="8" y2="21.01"></line><line x1="16" y1="21" x2="16" y2="21.01"></line><line x1="3" y1="10" x2="21" y2="10"></line><path d="M8 15h.01"></path><path d="M16 15h.01"></path></symbol>
        <symbol id="icon-star" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></symbol>
        <symbol id="icon-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></symbol>
        <symbol id="icon-rain" viewBox="0 0 24 24"><line x1="16" y1="13" x2="16" y2="21"></line><line x1="8" y1="13" x2="8" y2="21"></line><line x1="12" y1="15" x2="12" y2="23"></line><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path></symbol>
        <symbol id="icon-cloud" viewBox="0 0 24 24"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></symbol>
        <symbol id="icon-user" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></symbol>
        <symbol id="icon-camera" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></symbol>
        <symbol id="icon-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></symbol>
        <symbol id="icon-chart-bar" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></symbol>
    </svg>

    <div id="loading-overlay" class="hidden">同步中...</div>

    <!-- 1. Home -->
    <div id="view-home">
        <div style="text-align:center; padding-top:80px; padding-bottom:30px;">
            <div style="font-size:3rem; margin-bottom:10px;">☁️</div>
            <h1 style="color:var(--primary-dark); margin:0; font-size:2rem; letter-spacing:1px;">旅遊手帳</h1>
            <p style="color:var(--text-light); font-size:0.9rem; margin-top:5px;">Version 10.2</p>
        </div>
        <div class="container" style="padding-bottom:20px;">
            <div class="card" style="padding:15px; display:flex; gap:10px;">
                <input type="text" id="join-trip-id" placeholder="輸入旅程 ID 加入..." style="margin:0;">
                <button class="btn btn-primary" onclick="window.joinTrip()" style="width:auto; padding:0 15px;">加入</button>
            </div>
        </div>
        <div id="trip-list-container" class="container"></div>
        <button class="fab" onclick="window.openCreateTripModal()"><svg class="icon-svg"><use href="#icon-plus"/></svg></button>
    </div>

    <!-- 2. Detail -->
    <div id="view-detail" class="hidden">
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="window.switchTab('info')"><svg class="icon-svg"><use href="#icon-nav-info"/></svg> 行前</button>
            <button class="nav-item" onclick="window.switchTab('itinerary')"><svg class="icon-svg"><use href="#icon-nav-cal"/></svg> 行程</button>
            <button class="nav-item" onclick="window.switchTab('money')"><svg class="icon-svg"><use href="#icon-nav-money"/></svg> 記帳</button>
            <button class="nav-item" onclick="window.switchTab('shopping')"><svg class="icon-svg"><use href="#icon-nav-shop"/></svg> 清單</button>
            <button class="nav-item" onclick="window.switchTab('journal')"><svg class="icon-svg"><use href="#icon-book"/></svg> 日誌</button>
        </nav>

        <!-- A. Info -->
        <div id="tab-info" class="tab-content">
            <div class="sticky-header">
                <div class="header-top">
                    <button class="back-btn btn-ghost" onclick="window.goHome()">◀ 列表</button>
                    <div class="header-title" id="header-trip-name-info"></div>
                    <button class="btn-ghost" onclick="window.shareTrip()"><svg class="icon-svg"><use href="#icon-share"/></svg></button>
                </div>
                <div class="sub-nav">
                    <button class="sub-nav-btn active" onclick="window.switchInfoSub('flight')">機票</button>
                    <button class="sub-nav-btn" onclick="window.switchInfoSub('hotel')">住宿</button>
                    <button class="sub-nav-btn" onclick="window.switchInfoSub('ticket')">門票</button>
                    <button class="sub-nav-btn" onclick="window.switchInfoSub('charter')">包車</button>
                    <button class="sub-nav-btn" onclick="window.switchInfoSub('packing')">行李</button>
                </div>
            </div>
            <div class="container">
                <div id="info-flight" class="info-sub-tab">
                    <div id="countdown-area" class="countdown-banner hidden">
                        <div class="countdown-label" id="countdown-txt"></div>
                        <div class="countdown-num" id="countdown-val"></div>
                    </div>
                    <!-- Flights: Dynamic Lists -->
                    <div class="card">
                        <div class="card-header"><svg class="icon-svg"><use href="#icon-plane-real"></use></svg> 去程 Outbound</div>
                        <div id="flight-out-list"></div>
                        <button class="btn btn-ghost" style="width:100%; margin-top:5px; border:1px dashed #E2E8F0;" onclick="window.addFlight('out')">＋ 轉機/新增航班</button>
                    </div>
                    <div class="card">
                        <div class="card-header"><svg class="icon-svg" style="transform: rotate(180deg);"><use href="#icon-plane-real"></use></svg> 回程 Inbound</div>
                        <div id="flight-in-list"></div>
                        <button class="btn btn-ghost" style="width:100%; margin-top:5px; border:1px dashed #E2E8F0;" onclick="window.addFlight('in')">＋ 轉機/新增航班</button>
                    </div>
                </div>
                <div id="info-hotel" class="info-sub-tab hidden"><div id="hotel-list"></div><button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="window.openHotelModal()"><svg class="icon-svg icon-sm"><use href="#icon-plus"></use></svg> 新增住宿</button></div>
                <div id="info-ticket" class="info-sub-tab hidden"><div id="ticket-list"></div><button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="window.openTicketModal()"><svg class="icon-svg icon-sm"><use href="#icon-plus"></use></svg> 新增票券</button></div>
                <div id="info-charter" class="info-sub-tab hidden"><div id="charter-list"></div><button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="window.openCharterModal()"><svg class="icon-svg icon-sm"><use href="#icon-plus"></use></svg> 新增包車/接送</button></div>
                <div id="info-packing" class="info-sub-tab hidden">
                    <div class="card">
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="pack-input" placeholder="新增共用物品..." style="margin:0;">
                            <button class="btn btn-primary" style="width:auto;" onclick="window.addPackItem()">＋</button>
                        </div>
                        <div id="list-packing" style="margin-top:20px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- B. Itinerary -->
        <div id="tab-itinerary" class="tab-content hidden">
            <div class="sticky-header">
                <div class="header-top"><button class="back-btn btn-ghost" onclick="window.goHome()">◀</button><div class="header-title" id="header-trip-name-itinerary"></div><div style="width:30px;"></div></div>
                <div class="day-scroller" id="day-tabs-itinerary"></div>
            </div>
            <div class="container">
                <div class="weather-card">
                    <div class="w-top-row">
                        <div class="w-loc-group"><div class="w-city" id="weather-loc">Loading...</div><div class="w-desc"><span id="weather-icon-box"></span><span id="weather-text">--</span></div></div>
                        <div class="w-main-temp"><span id="weather-temp">--</span>°</div>
                    </div>
                    <div class="w-grid">
                        <div class="w-stat"><div class="w-stat-label">最高/低</div><div class="w-stat-val"><span id="w-max">--</span>° / <span id="w-min">--</span>°</div></div>
                        <div class="w-stat"><div class="w-stat-label">降雨率</div><div class="w-stat-val" style="color:#4299E1;"><span id="w-rain">--</span>%</div></div>
                        <div class="w-stat"><div class="w-stat-label">日出/落</div><div class="w-stat-val" style="font-size:0.8rem;"><span id="w-rise">--</span> | <span id="w-set">--</span></div></div>
                    </div>
                </div>
                <div id="flight-card-container"></div>
                <div class="timeline-wrapper"><div class="timeline-line"></div><div id="list-itinerary"></div></div>
                <div id="night-stay-container"></div>
            </div>
            <button class="fab" onclick="window.openNewItinerary()"><svg class="icon-svg"><use href="#icon-plus"/></svg></button>
        </div>

        <!-- C. Money -->
        <div id="tab-money" class="tab-content hidden">
            <div style="background:var(--primary); padding:20px; border-radius:0 0 30px 30px; margin-top:-2px; color:white; box-shadow:0 10px 20px rgba(127,169,190,0.2);">
                <div style="text-align:center; font-size:0.9rem; opacity:0.8;">匯率換算 (NTD)</div>
                <div style="font-size:2rem; font-weight:900; text-align:center; margin:5px 0;" id="rate-display">0.0</div>
                <div class="row" style="justify-content:center; align-items:center; margin-bottom:0;">
                    <input type="number" id="rate-amount" placeholder="金額" style="width:100px; text-align:center; background:white; color:black; border:none; margin:0;" oninput="window.updateRateCalc()">
                    <select id="rate-currency" style="background:rgba(255,255,255,0.2); border:none; color:white; font-weight:bold; border-radius:12px; padding:8px; width:auto; margin:0;" onchange="window.fetchRate()">
                        <option value="JPY">JPY</option><option value="USD">USD</option><option value="KRW">KRW</option><option value="EUR">EUR</option><option value="THB">THB</option><option value="CNY">CNY</option>
                    </select>
                </div>
            </div>
            <div class="sticky-header" style="top:0; border-bottom:none; background:transparent;">
                <div class="sub-nav" style="justify-content:center; padding-top:15px;">
                    <button class="sub-nav-btn active" id="btn-money-list" onclick="window.switchMoneySub('list')">列表</button>
                    <button class="sub-nav-btn" id="btn-money-analysis" onclick="window.switchMoneySub('analysis')">統計</button>
                    <button class="sub-nav-btn" id="btn-money-split" onclick="window.switchMoneySub('split')">分帳</button>
                </div>
            </div>
            <div class="container">
                <div id="money-view-list">
                    <div class="day-scroller" id="day-tabs-money"></div>
                    <!-- 新增的成員篩選 Tab 區域 -->
                    <div class="sub-nav" id="money-list-member-tabs" style="justify-content:center; padding-top:5px; margin-bottom:10px;"></div>
                    <div id="list-money"></div>
                </div>
                <div id="money-view-analysis" class="hidden"><div id="analysis-content"></div></div>
                <!-- 3. (新增) 分帳頁 -->
                <div id="money-view-split" class="hidden">
                    <div id="split-list-container"></div>
                </div>
            </div>
            <button class="fab" onclick="window.handleMoneyFab()"><svg class="icon-svg"><use href="#icon-plus"/></svg></button>
        </div>

        <!-- D. Lists -->
        <div id="tab-shopping" class="tab-content hidden">
            <div class="sticky-header">
                <div class="header-top"><button class="back-btn btn-ghost" onclick="window.goHome()">◀</button><div class="header-title">清單</div><div style="width:30px;"></div></div>
                <div class="sub-nav" style="justify-content:center;">
                    <button class="sub-nav-btn active" onclick="window.switchListSub('food')">美食</button>
                    <button class="sub-nav-btn" onclick="window.switchListSub('shop')">購物</button>
                </div>
            </div>
            <div class="container">
                <div id="list-items-container" style="margin-top:10px;"></div>
            </div>
            <button class="fab" onclick="window.openShoppingModal()"><svg class="icon-svg"><use href="#icon-plus"/></svg></button>
        </div>

        <!-- E. Journal -->
        <div id="tab-journal" class="tab-content hidden">
            <div class="sticky-header">
                <div class="header-top"><button class="back-btn btn-ghost" onclick="window.goHome()">◀</button><div class="header-title">日誌</div><div style="width:30px;"></div></div>
            </div>
            <div class="container" id="journal-list"></div>
            <button class="fab" onclick="window.openJournalModal()"><svg class="icon-svg"><use href="#icon-plus"/></svg></button>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-create-trip" class="modal hidden">
        <div class="modal-content">
            <h3 id="modal-create-trip-title">✨ 建立新旅程</h3>
            <div class="input-group"><span class="card-label">名稱</span><input type="text" id="new-trip-name"></div>
            <div class="input-group"><span class="card-label">城市 (英文, 用於天氣)</span><input type="text" id="new-trip-city" placeholder="e.g. Tokyo"></div>
            <div class="row">
                <div class="col"><span class="card-label">日期</span><input type="date" id="new-trip-date"></div>
                <div class="col"><span class="card-label">天數</span><input type="number" id="new-trip-days" value="5"></div>
            </div>
            <div class="input-group"><span class="card-label">成員 (逗號隔開)</span><input type="text" id="new-trip-members" placeholder="我, Amy, Bob"></div>
            <div class="row" style="margin-top:20px; gap:10px;"><div class="col"><button class="btn" onclick="window.closeModal('create-trip')">取消</button></div><div class="col"><button class="btn btn-primary" onclick="window.saveTripMetadata()">儲存</button></div></div>
        </div>
    </div>

    <div id="modal-journal" class="modal hidden">
        <div class="modal-content">
            <h3>📝 寫日誌</h3>
            <div class="row">
                <div class="col"><span class="card-label">日期</span><input type="date" id="j-date"></div>
                <div class="col"><span class="card-label">撰寫人</span><select id="j-writer" style="padding:0 14px;"></select></div>
            </div>
            <div class="input-group"><span class="card-label">內容</span><textarea id="j-content" placeholder="今天發生了什麼有趣的事..." style="height:150px;"></textarea></div>
            <div class="row" style="margin-top:20px; gap:10px;"><div class="col"><button class="btn" onclick="window.closeModal('journal')">取消</button></div><div class="col"><button class="btn btn-primary" onclick="window.saveJournal()">儲存</button></div></div>
        </div>
    </div>

    <div id="modal-hotel" class="modal hidden">
        <div class="modal-content">
            <h3>住宿</h3>
            <div class="input-group"><span class="card-label">飯店名稱</span><input id="h-name"></div>
            <div class="input-group"><span class="card-label">地址</span><input id="h-address"></div>
            <div class="row">
                <div class="col"><span class="card-label">訂房網</span><input id="h-source" placeholder="Agoda"></div>
                <div class="col"><span class="card-label">訂單編號</span><input id="h-order"></div>
            </div>
            <div class="row">
                <div class="col"><span class="card-label">入住日期</span><input type="date" id="h-date"></div>
                <div class="col"><span class="card-label">幾晚</span><input type="number" id="h-days" value="1"></div>
            </div>
            <div class="row" style="margin-top:20px; gap:10px;"><div class="col"><button class="btn" onclick="window.closeModal('hotel')">取消</button></div><div class="col"><button class="btn btn-primary" onclick="window.saveHotel()">儲存</button></div></div>
        </div>
    </div>

    <div id="modal-ticket" class="modal hidden">
        <div class="modal-content">
            <h3>票券</h3>
            <div class="input-group"><span class="card-label">名稱</span><input id="t-name"></div>
            <div class="row">
                <div class="col"><span class="card-label">日期</span><input type="date" id="t-date"></div>
                <div class="col"><span class="card-label">訂單編號</span><input id="t-order"></div>
            </div>
            <div class="input-group"><span class="card-label">備註</span><textarea id="t-note" style="height:80px;"></textarea></div>
            <div class="row" style="margin-top:20px; gap:10px;"><div class="col"><button class="btn" onclick="window.closeModal('ticket')">取消</button></div><div class="col"><button class="btn btn-primary" onclick="window.saveTicket()">儲存</button></div></div>
        </div>
    </div>
    
    <div id="modal-charter" class="modal hidden">
        <div class="modal-content">
            <h3>包車 / 接送</h3>
            <div class="chip-group" style="margin-bottom:20px; justify-content:center;">
                <button class="chip-btn active" onclick="window.setCharterType(this, '接送')">接送</button>
                <button class="chip-btn" onclick="window.setCharterType(this, '包車')">包車</button>
            </div>
            <div class="row">
                <div class="col"><span class="card-label">日期</span><input type="date" id="c-date"></div>
                <div class="col"><span class="card-label">時間</span><input type="time" id="c-time"></div>
            </div>
            <div class="input-group"><span class="card-label">接送點</span><input id="c-from"></div>
            <div class="input-group"><span class="card-label">目的地</span><input id="c-to"></div>
            <div class="input-group"><span class="card-label">聯絡資訊</span><input id="c-contact"></div>
            <div class="input-group"><span class="card-label">備註</span><textarea id="c-note" style="height:60px;"></textarea></div>
            <div class="row" style="margin-top:20px; gap:10px;"><div class="col"><button class="btn" onclick="window.closeModal('charter')">取消</button></div><div class="col"><button class="btn btn-primary" onclick="window.saveCharter()">儲存</button></div></div>
        </div>
    </div>

    <div id="modal-money" class="modal hidden">
        <div class="modal-content">
            <h3>記帳</h3>
            <div class="row">
                <div class="col"><span class="card-label">日期</span><input type="date" id="m-date"></div>
            </div>

            <div class="input-group"><span class="card-label">項目名稱</span><input id="m-title" placeholder="例如：午餐、紀念品"></div>
            
            <div class="row">
                <div style="width:90px;"><span class="card-label">幣別</span><select id="m-curr" style="padding:0 14px;"><option value="NT$">NT$</option><option value="¥">¥</option><option value="₩">₩</option><option value="€">€</option><option value="$">$</option></select></div>
                <div class="col"><span class="card-label">金額</span><input type="number" id="m-cost" placeholder="0"></div>
            </div>

            <span class="card-label">付款人</span>
            <div id="m-payer-wrapper" class="chip-group" style="margin-bottom:15px;"></div>

            <!-- 修改：付款方式移到同一行比較省空間，或保持原樣 -->
            <span class="card-label">方式</span>
            <div class="chip-group" style="margin-bottom:15px;">
                <button class="chip-btn method-btn" onclick="window.setMoneyMethod('cash', this)">現金</button>
                <button class="chip-btn method-btn" onclick="window.setMoneyMethod('card', this)">信用卡</button>
            </div>

            <!-- 新增：備註 -->
            <div class="input-group">
                <span class="card-label">備註 (選填)</span>
                <textarea id="m-note" style="height:60px;" placeholder="寫點備註..."></textarea>
            </div>

            <div class="row" style="margin-top:20px; gap:10px;">
                <button class="btn" id="btn-delete-money" onclick="window.deleteMoneyItemInModal()" style="background:#FFF5F5; color:var(--accent); width:50px; flex:none; display:none;"><svg class="icon-svg icon-sm"><use href="#icon-trash"></use></svg></button>
                <div class="col"><button class="btn" onclick="window.closeModal('money')">取消</button></div>
                <div class="col"><button class="btn btn-primary" onclick="window.saveMoney()">儲存</button></div>
            </div>
        </div>
    </div>

    <!-- New Split Modal -->
    <div id="modal-split" class="modal hidden">
        <div class="modal-content" style="max-width:400px;">
            <h3>💰 新增分帳</h3>
            
            <div class="row">
                <div class="col"><span class="card-label">日期</span><input type="date" id="sp-date"></div>
            </div>
            
            <div class="row" style="align-items: flex-end;">
                <div class="col">
                    <span class="card-label">總金額</span>
                    <input type="number" id="sp-total" oninput="window.calcSplit()" placeholder="輸入總額自動計算">
                </div>
                <div style="display:flex; align-items:center; height:48px; padding-left: 5px; padding-bottom: 2px;">
                    <div class="split-check" id="sp-is-even-check" onclick="window.toggleSplitCheck(this); window.calcSplit();">✓</div>
                    <label style="margin-left:8px; font-weight:bold; cursor:pointer; font-size: 0.95rem; color:var(--text);" onclick="window.toggleSplitCheck(document.getElementById('sp-is-even-check')); window.calcSplit();">平分</label>
                </div>
            </div>

            <div class="input-group"><span class="card-label">項目名稱</span><input id="sp-title" placeholder="例如：包車費用、晚餐"></div>
            
            <div class="row" style="align-items:center;">
                <div class="col"><span class="card-label">先墊款人 (Payer)</span><select id="sp-payer" style="padding:0 10px;"></select></div>
                <div style="width:90px;"><span class="card-label">幣別</span><select id="sp-curr" style="padding:0 10px;"><option value="NT$">NT$</option><option value="¥">¥</option><option value="₩">₩</option></select></div>
            </div>

            <div style="border-top:1px dashed #eee; margin:15px 0;"></div>
            
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span class="card-label">成員分帳細節</span>
            </div>
            
            <!-- 動態生成成員輸入框 -->
            <div id="sp-members-container" style="margin-bottom:20px;"></div>

            <div class="row" style="margin-top:20px; gap:10px;">
                <button class="btn" id="btn-delete-split" onclick="window.deleteSplitItem()" style="background:#FFF5F5; color:var(--accent); width:50px; flex:none; display:none;"><svg class="icon-svg icon-sm"><use href="#icon-trash"></use></svg></button>
                <div class="col"><button class="btn" onclick="window.closeModal('split')">取消</button></div>
                <div class="col"><button class="btn btn-primary" onclick="window.saveSplitBill()">儲存</button></div>
            </div>
        </div>
    </div>
    
    <div id="modal-shopping" class="modal hidden">
        <div class="modal-content">
            <h3>新增清單項目</h3>
            <div class="input-group"><span class="card-label">名稱</span><input id="s-name" placeholder="想買/想吃的東西..."></div>
            <div class="input-group"><span class="card-label">誰的/推薦人</span><select id="s-owner" style="padding:0 14px;"></select></div>
            <div class="input-group"><span class="card-label">地點 / 店名</span><input id="s-loc" placeholder="在哪裡買?"></div>
            <div class="input-group"><span class="card-label">營業時間</span><input id="s-open" placeholder="e.g. 10:00 - 20:00"></div>
            <div class="input-group"><span class="card-label">備註</span><textarea id="s-note" style="height:60px;"></textarea></div>
            <div class="row" style="margin-top:20px; gap:10px;">
                <div class="col"><button class="btn" onclick="window.closeModal('shopping')">取消</button></div>
                <div class="col"><button class="btn btn-primary" onclick="window.saveShoppingItem()">儲存</button></div>
            </div>
        </div>
    </div>
    
    <div id="modal-itinerary" class="modal hidden">
        <div class="modal-content">
            <h3>行程</h3>
            <div class="input-group"><span class="card-label">類別</span>
                <select id="i-type" style="padding:0 14px;">
                    <option value="spot">📍 景點</option><option value="food">🍽️ 美食</option><option value="shop">🛍️ 購物</option><option value="transport">🚋 交通</option><option value="other">✨ 其他</option>
                </select>
            </div>
            <div class="row">
                <div class="col"><span class="card-label">日期</span><input type="date" id="i-date"></div>
                <div class="col"><span class="card-label" id="label-time-start">開始時間</span><input type="time" id="i-time"></div>
                <div class="col hidden" id="wrapper-end-time"><span class="card-label">抵達時間</span><input type="time" id="i-end-time"></div>
            </div>
            <div class="input-group" style="position:relative;">
                <span class="card-label">地點 / 名稱</span>
                <input type="text" id="i-loc" placeholder="Google Maps 地點">
                <div style="position:absolute; right:12px; bottom:12px; color:var(--primary);"><svg class="icon-svg icon-sm"><use href="#icon-pin"></use></svg></div>
            </div>
            <div class="input-group hidden" id="wrapper-dest" style="position:relative;">
                <span class="card-label">目的地</span>
                <input type="text" id="i-dest">
                <div style="position:absolute; right:12px; bottom:12px; color:var(--primary);"><svg class="icon-svg icon-sm"><use href="#icon-pin"></use></svg></div>
            </div>
            <div class="input-group hidden" id="wrapper-title"><span class="card-label">補充標題 (選填)</span><input type="text" id="i-title" placeholder="如: JR山手線"></div>
            <div class="input-group hidden" id="wrapper-open"><span class="card-label">營業時間 (選填)</span><input type="text" id="i-open"></div>
            <div class="input-group"><span class="card-label">備註</span><textarea id="i-note" style="height:80px;"></textarea></div>
            <div class="row" style="margin-top:20px; gap:10px;">
                <button class="btn" onclick="window.deleteItineraryItemInModal()" style="background:#FFF5F5; color:var(--accent); width:50px; flex:none;"><svg class="icon-svg icon-sm"><use href="#icon-trash"></use></svg></button>
                <div class="col"><button class="btn" onclick="window.closeModal('itinerary')">取消</button></div>
                <div class="col"><button class="btn btn-primary" onclick="window.saveItinerary()">儲存</button></div>
            </div>
        </div>
    </div>

    <script type="module">
        // ---------------------------------------------------------
        // 1. Firebase Config (Replace with your own keys)
        // ---------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
             apiKey: "AIzaSyCU3D_Grf3fN3uI3qt5hwWugieBke_Nq94",
             authDomain: "travel-4638f.firebaseapp.com",
             projectId: "travel-4638f",
             storageBucket: "travel-4638f.firebasestorage.app",
             messagingSenderId: "812351265932",
             appId: "1:812351265932:web:71b3ddc475501f571b2fa9",
             measurementId: "G-4M3N10PR26"
        };

        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (e) { console.error("FB Init Fail", e); }

        // ---------------------------------------------------------
        // 2. Logic
        // ---------------------------------------------------------
        let currentTrip = null;
        let unsubscribe = null;
        let appState = { dayIdx: 0, editId: null, editType: null, listType: 'food', charterType:'接送' };
        let moneyState = { payer: '', method: 'cash' };
        let moneyListMemberFilter = 'all'; // New: Filter state for money list
        let currentRate = 0.22;
        let currentInfoTab = 'flight';
        let sortableInstance = null;
        let sortablePacking = null;
        let editingTripId = null; // For editing trip metadata

        window.openCreateTripModal = function() {
            editingTripId = null;
            document.getElementById('modal-create-trip-title').innerText = '✨ 建立新旅程';
            document.getElementById('new-trip-name').value = '';
            document.getElementById('new-trip-city').value = '';
            document.getElementById('new-trip-date').value = '';
            document.getElementById('new-trip-members').value = '';
            document.getElementById('new-trip-days').value = '5';
            window.openModal('create-trip');
        };

        window.openEditTripModal = async function(id) {
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                // We can try to load from local storage first for speed, but firestore is source of truth
                const snap = await getDoc(doc(db, "trips", id));
                if(snap.exists()) {
                    const data = snap.data();
                    editingTripId = id;
                    document.getElementById('modal-create-trip-title').innerText = '✎ 編輯旅程';
                    document.getElementById('new-trip-name').value = data.name;
                    document.getElementById('new-trip-city').value = data.city;
                    document.getElementById('new-trip-date').value = data.startDate;
                    document.getElementById('new-trip-days').value = data.days;
                    document.getElementById('new-trip-members').value = data.members.join(', ');
                    window.openModal('create-trip');
                }
            } catch(e) { alert("讀取失敗"); }
            document.getElementById('loading-overlay').classList.add('hidden');
        };

        function fillMemberSelect(selectId) {
            const el = document.getElementById(selectId);
            if(!el || !currentTrip) return;
            el.innerHTML = '';
            currentTrip.members.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m; opt.innerText = m;
                el.appendChild(opt);
            });
        }

        window.renderHome = function() {
            document.getElementById('view-home').classList.remove('hidden');
            document.getElementById('view-detail').classList.add('hidden');
            const list = document.getElementById('trip-list-container');
            const savedIds = JSON.parse(localStorage.getItem('tl_ids') || '[]');
            const savedMetas = JSON.parse(localStorage.getItem('tl_metas') || '{}');
            list.innerHTML = savedIds.length ? '' : '<div style="text-align:center; color:#CCC; margin-top:20px;">無紀錄</div>';
            savedIds.forEach(id => {
                const meta = savedMetas[id] || {name:'Trip', date:'-'};
                list.innerHTML += `
                    <div class="card" onclick="window.openTrip('${id}')">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-weight:bold;">${meta.name}</div>
                                <div style="font-size:0.8rem; color:#999;">${meta.date}</div>
                            </div>
                            <div>
                                <button class="btn-edit" onclick="event.stopPropagation(); window.openEditTripModal('${id}')">✎</button>
                                <button class="btn-del" onclick="event.stopPropagation(); window.deleteTrip('${id}')"><svg class="icon-svg icon-sm"><use href="#icon-trash"></use></svg></button>
                            </div>
                        </div>
                    </div>`;
            });
        };

        window.deleteTrip = async function(id) {
            if(!confirm("確定要刪除此旅程嗎？此操作無法復原。")) return;
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                await deleteDoc(doc(db, "trips", id));
                let ids = JSON.parse(localStorage.getItem('tl_ids') || '[]');
                ids = ids.filter(x => x !== id);
                localStorage.setItem('tl_ids', JSON.stringify(ids));
                let metas = JSON.parse(localStorage.getItem('tl_metas') || '{}');
                delete metas[id];
                localStorage.setItem('tl_metas', JSON.stringify(metas));
                window.renderHome();
            } catch(e) { alert("刪除失敗: " + e.message); }
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        window.saveTripMetadata = async function() {
            const name = document.getElementById('new-trip-name').value;
            const city = document.getElementById('new-trip-city').value;
            const date = document.getElementById('new-trip-date').value;
            const days = parseInt(document.getElementById('new-trip-days').value) || 1;
            const members = document.getElementById('new-trip-members').value.split(/[,，\s]+/).filter(Boolean);
            
            if(!name || !date) return alert('請填寫完整');
            if(members.length===0) members.push('我');

            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                if(editingTripId) {
                    // Update existing
                    await updateDoc(doc(db, "trips", editingTripId), {
                        name, city, startDate: date, days, members
                    });
                    saveLocal(editingTripId, name, date);
                    window.closeModal('create-trip');
                    window.renderHome(); // Refresh list to show new name/date
                } else {
                    // Create new
                    const id = Date.now().toString();
                    const newTrip = {
                        id, name, city, startDate: date,
                        days, members,
                        itinerary: [], money: [], shopping: [], foodList: [], packing: [], journals: [], splitBills: [],
                        flights: { out:[], in:[] }, hotels: [], tickets: [], charters: []
                    };
                    await setDoc(doc(db, "trips", id), newTrip);
                    saveLocal(id, name, date);
                    window.closeModal('create-trip');
                    window.openTrip(id);
                }
            } catch (e) {
                alert("操作失敗: " + e.message);
            }
            document.getElementById('loading-overlay').classList.add('hidden');
        };
        // Kept for legacy binding in HTML if any
        window.createNewTrip = window.saveTripMetadata; 

        window.joinTrip = async function() {
            const id = document.getElementById('join-trip-id').value.trim();
            if(!id) return;
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                const snap = await getDoc(doc(db, "trips", id));
                if(snap.exists()) {
                    const d = snap.data();
                    saveLocal(id, d.name, d.startDate);
                    window.openTrip(id);
                } else alert('找不到此 ID');
            } catch(e) { alert("讀取失敗: "+e.message); }
            document.getElementById('loading-overlay').classList.add('hidden');
        };

        function saveLocal(id, name, date) {
            let ids = JSON.parse(localStorage.getItem('tl_ids') || '[]');
            if(!ids.includes(id)) ids.unshift(id);
            localStorage.setItem('tl_ids', JSON.stringify(ids));
            let metas = JSON.parse(localStorage.getItem('tl_metas') || '{}');
            metas[id] = {name, date};
            localStorage.setItem('tl_metas', JSON.stringify(metas));
        }

        window.openTrip = function(id) {
            if(unsubscribe) unsubscribe();
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-detail').classList.remove('hidden');
            unsubscribe = onSnapshot(doc(db, "trips", id), (doc) => {
                if(doc.exists()) {
                    currentTrip = doc.data();
                    // Initial Data Structure Migration
                    if(!currentTrip.journals) currentTrip.journals = [];
                    if(!currentTrip.foodList) currentTrip.foodList = [];
                    // Migration flight object to array if needed
                    if(!Array.isArray(currentTrip.flights.out)) {
                        currentTrip.flights.out = currentTrip.flights.out.code ? [currentTrip.flights.out] : [];
                    }
                    if(!Array.isArray(currentTrip.flights.in)) {
                        currentTrip.flights.in = currentTrip.flights.in.code ? [currentTrip.flights.in] : [];
                    }
                    
                    if(!currentTrip.itinerary) currentTrip.itinerary = [];
                    if(!currentTrip.splitBills) currentTrip.splitBills = [];
                    
                    // Migrate Itinerary: dayIdx -> date
                    let needUpdate = false;
                    currentTrip.itinerary.forEach(it => {
                        if(!it.date && typeof it.dayIdx !== 'undefined') {
                            it.date = window.getTargetDateStr(currentTrip.startDate, it.dayIdx);
                            needUpdate = true;
                        }
                    });
                    if(needUpdate) window.saveData();

                    document.getElementById('header-trip-name-info').innerText = currentTrip.name;
                    document.getElementById('header-trip-name-itinerary').innerText = currentTrip.name;
                    
                    const activeTabId = document.querySelector('.nav-item.active').getAttribute('onclick').match(/'([^']+)'/)[1];
                    if(activeTabId === 'itinerary') window.renderAllDetail();
                    else if(activeTabId === 'money') { 
                        window.renderAllDetail(); 
                        window.renderMoney(); 
                        window.renderMoneyAnalysis(); 
                        if(appState.moneyTab === 'split') window.renderSplitBills();
                    }
                    else if(activeTabId === 'info') { 
                        window.fillFlightInputs(); 
                        window.updateCountdown(); 
                        window.switchInfoSub(currentInfoTab); 
                    }
                    else if(activeTabId === 'shopping') window.renderLists();
                    else if(activeTabId === 'journal') window.renderJournal();
                }
            });
            appState.dayIdx = 0;
            window.switchTab('info');
            window.updateCountdown();
            window.fetchRate();
        };

        window.saveData = async function() {
            if(currentTrip) await updateDoc(doc(db, "trips", currentTrip.id), currentTrip);
        };

        window.switchTab = function(t) {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            const map = {info:0, itinerary:1, money:2, shopping:3, journal:4};
            document.querySelectorAll('.nav-item')[map[t]].classList.add('active');
            
            if(t==='journal') window.renderJournal();
            if(t==='shopping') { fillMemberSelect('s-owner'); window.renderLists(); }
            if(t==='itinerary') {
                setTimeout(() => window.renderAllDetail(), 50); 
            }
            if(t==='money') {
                setTimeout(() => {
                    window.renderAllDetail(); 
                    window.renderMoney();
                    window.renderMoneyAnalysis();
                }, 50);
            }
        };

        window.switchInfoSub = function(sub) {
            currentInfoTab = sub;
            document.querySelectorAll('.info-sub-tab').forEach(e=>e.classList.add('hidden'));
            document.getElementById('info-'+sub).classList.remove('hidden');
            document.querySelectorAll('#tab-info .sub-nav-btn').forEach(e=>e.classList.remove('active'));
            const map = {flight:0, hotel:1, ticket:2, charter:3, packing:4};
            if(document.querySelectorAll('#tab-info .sub-nav-btn')[map[sub]])
                document.querySelectorAll('#tab-info .sub-nav-btn')[map[sub]].classList.add('active');
            
            if(sub==='packing') { window.renderPacking(); fillMemberSelect('pack-owner'); }
            if(sub==='flight') { window.fillFlightInputs(); window.updateCountdown(); }
            if(sub==='hotel') window.renderHotels();
            if(sub==='ticket') window.renderTickets();
            if(sub==='charter') window.renderCharters();
        };

        // --- Modals & Saving Logic ---
        window.openModal = function(id) { document.getElementById('modal-'+id).classList.remove('hidden'); };
        window.closeModal = function(id) { document.getElementById('modal-'+id).classList.add('hidden'); };
        function v(id) { return document.getElementById(id).value; }
        
        function saveItem(arrName, data) {
            const id = appState.editId || Date.now();
            const newItem = { id, ...data };
            if(appState.editId) {
                const idx = currentTrip[arrName].findIndex(x=>x.id===appState.editId);
                if(idx!==-1) currentTrip[arrName][idx] = newItem;
            } else currentTrip[arrName].push(newItem);
            window.saveData(); window.closeModal(appState.editType);
        }
        function resetModal(type, id) {
            const map = { hotel: ['h-name','h-address','h-source','h-order','h-date','h-days'], ticket: ['t-name','t-date','t-order','t-note'], charter: ['c-date','c-time','c-from','c-to','c-contact','c-note'] };
            if(id) { const item = currentTrip[type+'s'].find(x=>x.id===id); map[type].forEach(k => document.getElementById(k).value = item[k.split('-')[1]] || ''); } 
            else { map[type].forEach(k => document.getElementById(k).value = ''); }
        }

        // --- Journal ---
        window.openJournalModal = function(id) {
            appState.editId = id;
            if (id) {
                // Edit mode
                const j = currentTrip.journals.find(x => x.id === id);
                document.getElementById('j-date').value = j.date;
                fillMemberSelect('j-writer');
                document.getElementById('j-writer').value = j.writer;
                document.getElementById('j-content').value = j.content;
            } else {
                // Create mode
                document.getElementById('j-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('j-content').value = '';
                fillMemberSelect('j-writer');
            }
            window.openModal('journal');
        };

        function getFormattedTime() {
            const now = new Date();
            const pad = (n) => String(n).padStart(2,'0');
            return `${now.getFullYear()}/${pad(now.getMonth()+1)}/${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
        }

        window.saveJournal = function() {
            const date = document.getElementById('j-date').value;
            const writer = document.getElementById('j-writer').value;
            const content = document.getElementById('j-content').value;
            if(!content) return;
            
            if (appState.editId) {
                // Update
                const idx = currentTrip.journals.findIndex(x => x.id === appState.editId);
                if (idx !== -1) {
                    const oldJ = currentTrip.journals[idx];
                    currentTrip.journals[idx] = { 
                        ...oldJ, 
                        date, 
                        writer, 
                        content, 
                        lastEdited: getFormattedTime() 
                    };
                }
            } else {
                // Create
                currentTrip.journals.unshift({ 
                    id: Date.now(), 
                    date, 
                    writer, 
                    content,
                    comments: []
                });
            }

            // Force sort just in case
            currentTrip.journals.sort((a,b) => {
                if(a.date !== b.date) return b.date.localeCompare(a.date);
                return b.id - a.id;
            });
            window.saveData(); window.closeModal('journal');
        };

        window.addJournalComment = function(jId) {
            const input = document.getElementById(`j-c-input-${jId}`);
            const select = document.getElementById(`j-c-writer-${jId}`);
            const text = input.value;
            const writer = select.value;
            
            if(!text) return;
            
            const jIdx = currentTrip.journals.findIndex(x => x.id === jId);
            if(jIdx !== -1) {
                if(!currentTrip.journals[jIdx].comments) currentTrip.journals[jIdx].comments = [];
                currentTrip.journals[jIdx].comments.push({
                    id: Date.now(),
                    text: text,
                    writer: writer,
                    time: getFormattedTime()
                });
                window.saveData();
                // input.value = ''; // Render will clear it
            }
        };

        window.delJournalComment = function(jId, cId) {
            if(!confirm('刪除留言?')) return;
            const jIdx = currentTrip.journals.findIndex(x => x.id === jId);
            if(jIdx !== -1 && currentTrip.journals[jIdx].comments) {
                currentTrip.journals[jIdx].comments = currentTrip.journals[jIdx].comments.filter(c => c.id !== cId);
                window.saveData();
            }
        };

        function getPastelColor(str) {
            const colors = ['#FCA5A5', '#FDBA74', '#FDE047', '#86EFAC', '#67E8F9', '#93C5FD', '#C4B5FD', '#F9A8D4'];
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        }
        
        window.renderJournal = function() {
            const list = document.getElementById('journal-list'); list.innerHTML = '';
            if(!currentTrip.journals || currentTrip.journals.length===0) { list.innerHTML='<div style="text-align:center; color:#CCC; margin-top:20px;">還沒有日誌，寫一篇吧！</div>'; return; }
            
            // Ensure sorted newest first
            currentTrip.journals.sort((a,b) => {
                if(a.date !== b.date) return b.date.localeCompare(a.date);
                return b.id - a.id;
            });

            currentTrip.journals.forEach(j => {
                const d = new Date(j.date);
                const day = d.getDate();
                const ym = `${d.getFullYear()} 年 ${d.getMonth()+1} 月`;
                const bg = getPastelColor(j.writer || 'A');
                const lastEdit = j.lastEdited ? `最後編輯於 ${j.lastEdited}` : '';
                
                // Comments HTML
                let commentsHtml = '';
                if(j.comments && j.comments.length > 0) {
                    j.comments.forEach(c => {
                        const cBg = getPastelColor(c.writer || 'U');
                        commentsHtml += `
                            <div class="j-comment-row">
                                <div class="j-comment-avatar" style="background:${cBg}">${(c.writer||'U')[0]}</div>
                                <div class="j-comment-bubble">
                                    <div>${c.text}</div>
                                    <div class="j-comment-meta">
                                        <span>${c.writer} • ${c.time.split(' ')[1]}</span>
                                        <span class="j-del-comment" onclick="window.delJournalComment(${j.id}, ${c.id})">✕</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                // Comment Writer Options
                let memberOpts = '';
                currentTrip.members.forEach(m => {
                    memberOpts += `<option value="${m}">${m}</option>`;
                });

                list.innerHTML += `
                <div class="journal-card">
                    <div class="journal-header">
                        <div class="j-date-box">
                            <span class="j-day">${day}</span>
                            <span class="j-ym">日 / ${ym}</span>
                        </div>
                        <div class="j-writer-badge" style="background:${bg}">${j.writer}</div>
                    </div>
                    <div class="journal-content">${j.content}</div>
                    
                    <div class="j-last-edit">${lastEdit}</div>

                    <div class="j-footer">
                        <div class="btn-list-action-group">
                            <button class="btn-list-edit" onclick="window.openJournalModal(${j.id})">✎</button>
                            <button class="btn-list-del" onclick="window.delItem('journals', ${j.id})"><svg class="icon-svg icon-sm"><use href="#icon-trash"></use></svg></button>
                        </div>
                    </div>

                    <div class="j-comments-section">
                        ${commentsHtml}
                        <div class="j-input-area">
                            <select id="j-c-writer-${j.id}" class="j-input-select">${memberOpts}</select>
                            <input type="text" id="j-c-input-${j.id}" class="j-input-text" placeholder="留言...">
                            <button class="j-send-btn" onclick="window.addJournalComment(${j.id})">➤</button>
                        </div>
                    </div>
                </div>`;
            });
        };

        // --- Packing (Optimized) ---
        window.addPackItem = function() {
            const val = document.getElementById('pack-input').value;
            if(!val) return;
            let checks = {};
            currentTrip.members.forEach(m => checks[m] = false);
            currentTrip.packing.push({ id:Date.now(), text:val, checks: checks });
            document.getElementById('pack-input').value = '';
            window.saveData();
        };
        window.toggleMemberCheck = function(itemId, member) {
            const item = currentTrip.packing.find(x => x.id === itemId);
            if(item) {
                if(!item.checks) item.checks = {};
                item.checks[member] = !item.checks[member];
                window.saveData();
            }
        };
        window.renderPacking = function() {
            const list = document.getElementById('list-packing'); 
            list.innerHTML = '';
            
            (currentTrip.packing || []).forEach(i => {
                let membersHtml = '<div class="pack-members-row">';
                currentTrip.members.forEach(m => {
                    const isChecked = i.checks && i.checks[m];
                    const firstChar = m.charAt(0);
                    membersHtml += `<div class="pack-avatar ${isChecked?'checked':''}" onclick="window.toggleMemberCheck(${i.id}, '${m}')">${firstChar}</div>`;
                });
                membersHtml += '</div>';
                
                list.innerHTML += `
                    <div class="pack-item-card" data-id="${i.id}">
                        <div class="pack-info">
                            <span class="pack-name">${i.text}</span>
                        </div>
                        <div style="display:flex; align-items:center;">
                            ${membersHtml}
                            <button class="pack-btn-del" onclick="window.delItem('packing', ${i.id})">✕</button>
                        </div>
                    </div>`;
            });

            // Initialize Sortable for Packing List
            if (sortablePacking) { sortablePacking.destroy(); }
            sortablePacking = new Sortable(list, {
                animation: 150,
                delay: 300, 
                delayOnTouchOnly: true,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    const newIndex = evt.newIndex;
                    const oldIndex = evt.oldIndex;
                    if (newIndex === oldIndex) return;
                    const movedItem = currentTrip.packing.splice(oldIndex, 1)[0];
                    currentTrip.packing.splice(newIndex, 0, movedItem);
                    window.saveData();
                }
            });
        };

        // --- Lists (Shop/Food) ---
        window.switchListSub = function(t) { 
            appState.listType=t; 
            document.querySelectorAll('#tab-shopping .sub-nav-btn').forEach(b=>b.classList.toggle('active', (t==='shop'&&b.innerText.includes('購物'))||(t==='food'&&b.innerText.includes('美食')))); 
            window.renderLists(); 
        };
        
        window.openShoppingModal = function(id) {
            appState.editId = id; 
            const arr = appState.listType === 'shop' ? 'shopping' : 'foodList';
            if (id) {
                const item = currentTrip[arr].find(i => i.id === id);
                if (item) {
                    document.getElementById('s-name').value = item.text || '';
                    document.getElementById('s-loc').value = item.location || '';
                    document.getElementById('s-open').value = item.open || item.price || '';
                    document.getElementById('s-note').value = item.note || ''; // Load note
                    fillMemberSelect('s-owner');
                    document.getElementById('s-owner').value = item.owner || '';
                }
            } else {
                document.getElementById('s-name').value = '';
                document.getElementById('s-loc').value = '';
                document.getElementById('s-open').value = '';
                document.getElementById('s-note').value = '';
                fillMemberSelect('s-owner');
            }
            window.openModal('shopping');
        };

        window.saveShoppingItem = function() {
            const name = document.getElementById('s-name').value;
            const loc = document.getElementById('s-loc').value;
            const open = document.getElementById('s-open').value;
            const owner = document.getElementById('s-owner').value;
            const note = document.getElementById('s-note').value;
            
            if(!name) return;
            
            const arr = appState.listType==='shop'?'shopping':'foodList';
            
            if (appState.editId) {
                const idx = currentTrip[arr].findIndex(i => i.id === appState.editId);
                if (idx !== -1) {
                    currentTrip[arr][idx] = { ...currentTrip[arr][idx], text: name, location: loc, open: open, owner: owner, note: note };
                }
            } else {
                currentTrip[arr].push({
                    id: Date.now(), 
                    text: name, 
                    open: open,     
                    location: loc, 
                    owner: owner, 
                    note: note,
                    checked: false
                });
            }
            window.saveData();
            window.closeModal('shopping');
            window.renderLists();
        };

        window.toggleShopNote = function(btn) {
            const card = btn.closest('.check-item');
            card.classList.toggle('show-note');
        };

        window.renderLists = function() {
            const listContainer = document.getElementById('list-items-container'); 
            listContainer.innerHTML = '';
            const arr = appState.listType==='shop'?'shopping':'foodList';
            
            (currentTrip[arr]||[]).forEach(i => {
                const displayTime = i.open || i.price;
                let pillTime = displayTime ? `<span class="meta-pill meta-time"><svg class="icon-svg"><use href="#icon-clock"/></svg>${displayTime}</span>` : '';
                let pillLoc = i.location ? `<span class="meta-pill meta-loc"><svg class="icon-svg"><use href="#icon-map-pin"/></svg>${i.location}</span>` : '';
                let ownerHtml = i.owner ? `<div class="member-badge-pill">${i.owner}</div>` : '';
                
                // Note Logic
                const hasNote = i.note && i.note.trim().length > 0;
                const noteToggleBtn = hasNote ? `<button class="note-toggle-btn" onclick="event.stopPropagation(); window.toggleShopNote(this)">▼</button>` : '';
                const notePanel = hasNote ? `<div class="check-note-panel">${i.note}</div>` : '';

                listContainer.innerHTML += `
                    <div class="card check-item ${i.checked?'checked':''}" data-id="${i.id}">
                        <div class="check-item-body">
                            <div class="check-left">
                                <div class="check-name-row">
                                    <div class="check-box" onclick="event.stopPropagation(); window.toggleCheck('${arr}', ${i.id})"></div>
                                    <div class="check-text">${i.text}${noteToggleBtn}</div>
                                </div>
                                ${ (i.location || displayTime) ? '<div class="check-separator"></div>' : '' }
                                <div class="check-meta-row">
                                    ${pillLoc}
                                    ${pillTime}
                                </div>
                            </div>
                            <div class="check-right">
                                ${ownerHtml}
                                <div class="btn-list-action-group">
                                    <button class="btn-list-edit" onclick="event.stopPropagation(); window.openShoppingModal(${i.id})">✎</button>
                                    <button class="btn-list-del" onclick="event.stopPropagation(); window.delItem('${arr}', ${i.id})"><svg class="icon-svg icon-sm"><use href="#icon-trash"></use></svg></button>
                                </div>
                            </div>
                        </div>
                        ${notePanel}
                    </div>`;
            });

            if (sortableInstance) { sortableInstance.destroy(); }
            sortableInstance = new Sortable(listContainer, {
                animation: 150,
                delay: 300, 
                delayOnTouchOnly: true,
                touchStartThreshold: 5,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    const newIndex = evt.newIndex;
                    const oldIndex = evt.oldIndex;
                    if (newIndex === oldIndex) return;
                    const movedItem = currentTrip[arr].splice(oldIndex, 1)[0];
                    currentTrip[arr].splice(newIndex, 0, movedItem);
                    window.saveData();
                }
            });
        };

        window.toggleCheck = function(arr, id) { const i=currentTrip[arr].find(x=>x.id===id); if(i){i.checked=!i.checked; window.saveData();} };
        window.delItem = function(arr, id) { if(confirm('刪除？')){ currentTrip[arr]=currentTrip[arr].filter(x=>x.id!==id); window.saveData(); } };
        window.goHome = function() { 
            if(unsubscribe) unsubscribe();
            document.getElementById('view-home').classList.remove('hidden'); 
            document.getElementById('view-detail').classList.add('hidden'); 
            window.renderHome();
        };
        window.shareTrip = function() { navigator.clipboard.writeText(currentTrip.id).then(()=>alert("ID已複製: "+currentTrip.id)); };

        // --- Info: Flights/Hotels/Tickets/Charters ---
        function renderTimezoneOptions(selected) {
            let html = '';
            for(let i=-12; i<=14; i++) {
                const label = i >= 0 ? `UTC+${i}` : `UTC${i}`;
                html += `<option value="${i}" ${parseInt(selected)==i?'selected':''}>${label}</option>`;
            }
            return html;
        }

        window.fillFlightInputs = function() {
            if(!currentTrip) return;
            const f = currentTrip.flights;
            
            // Render Dynamic Lists
            renderFlightList('out', 'flight-out-list');
            renderFlightList('in', 'flight-in-list');
        };

        function renderFlightList(dir, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const flights = currentTrip.flights[dir];

            flights.forEach((fl, idx) => {
                const row = document.createElement('div');
                row.className = 'flight-row-item';
                row.innerHTML = `
                    <button class="flight-del-btn" onclick="window.removeFlight('${dir}', ${idx})">✕</button>
                    <div style="margin-bottom:8px; font-weight:bold; color:var(--text-light); font-size:0.85rem;">航班 ${idx+1}</div>
                    <div class="flight-edit-block">
                        <span class="card-label">日期 / 航班號 / 航空</span>
                        <div class="row" style="margin-bottom:8px;">
                            <div class="col" style="flex:1.5;"><input type="date" value="${fl.date||''}" onchange="window.updateFlightField('${dir}', ${idx}, 'date', this.value)"></div>
                            <div class="col"><input placeholder="航班號" value="${fl.code||''}" onchange="window.updateFlightField('${dir}', ${idx}, 'code', this.value)"></div>
                            <div class="col"><input placeholder="航空公司" value="${fl.airline||''}" onchange="window.updateFlightField('${dir}', ${idx}, 'airline', this.value)"></div>
                        </div>
                        
                        <span class="card-label">起飛 (時間 / 機場 / 航廈)</span>
                        <div class="row" style="margin-bottom:8px;">
                            <div class="col" style="flex:1.2;"><input type="time" value="${fl.depTime||''}" onchange="window.updateFlightField('${dir}', ${idx}, 'depTime', this.value)"></div>
                            <select class="tz-select" onchange="window.updateFlightField('${dir}', ${idx}, 'depTz', this.value)">${renderTimezoneOptions(fl.depTz || (dir==='out'?8:9))}</select>
                            <div class="col" style="flex:1.5;"><input placeholder="機場" value="${fl.depAir||''}" onchange="window.updateFlightField('${dir}', ${idx}, 'depAir', this.value)"></div>
                            <div class="col" style="flex:1;"><input placeholder="航廈" value="${fl.depTerm||''}" onchange="window.updateFlightField('${dir}', ${idx}, 'depTerm', this.value)"></div>
                        </div>

                        <span class="card-label">降落 (時間 / 機場 / 航廈)</span>
                        <div class="row" style="margin-bottom:0;">
                            <div class="col" style="flex:1.2;"><input type="time" value="${fl.arrTime||''}" onchange="window.updateFlightField('${dir}', ${idx}, 'arrTime', this.value)"></div>
                            <select class="tz-select" onchange="window.updateFlightField('${dir}', ${idx}, 'arrTz', this.value)">${renderTimezoneOptions(fl.arrTz || (dir==='out'?9:8))}</select>
                            <div class="col" style="flex:1.5;"><input placeholder="機場" value="${fl.arrAir||''}" onchange="window.updateFlightField('${dir}', ${idx}, 'arrAir', this.value)"></div>
                            <div class="col" style="flex:1;"><input placeholder="航廈" value="${fl.arrTerm||''}" onchange="window.updateFlightField('${dir}', ${idx}, 'arrTerm', this.value)"></div>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        window.addFlight = function(dir) {
            currentTrip.flights[dir].push({ depTz: (dir==='out'?8:9), arrTz: (dir==='out'?9:8) });
            window.saveData();
            // Re-render handled by onSnapshot
        };

        window.removeFlight = function(dir, idx) {
            if(confirm('刪除此航班？')) {
                currentTrip.flights[dir].splice(idx, 1);
                window.saveData();
            }
        };

        window.updateFlightField = function(dir, idx, field, val) {
            currentTrip.flights[dir][idx][field] = val;
            window.saveData();
        };
        
        window.updateCountdown = function() {
            if(!currentTrip) return;
            const today = new Date(); today.setHours(0,0,0,0);
            const start = new Date(currentTrip.startDate);
            const diff = Math.ceil((start - today) / (1000 * 60 * 60 * 24));
            
            const banner = document.getElementById('countdown-area');
            const txt = document.getElementById('countdown-txt');
            const num = document.getElementById('countdown-val');
            banner.classList.remove('hidden', 'ended');
            
            if(diff > 0) {
                txt.innerHTML = "距離出發還剩下";
                num.innerHTML = `${diff} <span style="font-size:1rem; font-weight:normal;">天</span>`;
            } else if (diff <= 0 && diff >= -currentTrip.days) {
                txt.innerHTML = "旅程進行中";
                num.innerHTML = "Have Fun!";
            } else {
                banner.classList.add('ended');
                txt.innerHTML = "旅程已結束";
                num.innerHTML = "See you next time!";
            }
        };

        function calcDuration(t1, tz1, t2, tz2) {
            if(!t1 || !t2) return '';
            const getUtcMin = (time, tz) => {
                const [h, m] = time.split(':').map(Number);
                return (h * 60 + m) - (parseInt(tz) * 60);
            };
            const m1 = getUtcMin(t1, tz1||8);
            const m2 = getUtcMin(t2, tz2||8);
            let diff = m2 - m1;
            if (diff < 0) diff += 24 * 60; 
            const h = Math.floor(diff/60);
            const m = diff % 60;
            return `${h}h ${m}m`;
        }

        window.openHotelModal = function(id) { appState.editId=id; appState.editType='hotel'; resetModal('hotel', id); window.openModal('hotel'); };
        window.saveHotel = function() { saveItem('hotels', { name:v('h-name'), address:v('h-address'), source:v('h-source'), order:v('h-order'), date:v('h-date'), days:v('h-days') }); };
        window.renderHotels = function() { 
            const list = document.getElementById('hotel-list'); list.innerHTML = '';
            (currentTrip.hotels||[]).sort((a,b)=>a.date.localeCompare(b.date)).forEach(h => {
                list.innerHTML += `<div class="info-card-item"><div class="item-icon-box"><svg class="icon-svg"><use href="#icon-house"></use></svg></div><div class="info-card-content"><div style="font-weight:bold;">${h.name}</div><div class="info-card-sub"><svg class="icon-svg icon-xs"><use href="#icon-nav-cal"></use></svg> ${h.date} (${h.days}晚)</div><div class="info-card-sub" style="color:var(--primary); font-weight:bold;">${h.source || ''} #${h.order || ''}</div></div><div style="flex-shrink:0;"><button class="btn-edit" onclick="window.openHotelModal(${h.id})">✎</button><button class="btn-del" onclick="window.delItem('hotels', ${h.id})">✕</button></div></div>`;
            });
        };

        window.openTicketModal = function(id) { appState.editId=id; appState.editType='ticket'; resetModal('ticket', id); window.openModal('ticket'); };
        window.saveTicket = function() { saveItem('tickets', { name:v('t-name'), date:v('t-date'), order:v('t-order'), note:v('t-note') }); };
        window.renderTickets = function() { 
            const list = document.getElementById('ticket-list'); list.innerHTML = '';
            (currentTrip.tickets||[]).sort((a,b)=>a.date.localeCompare(b.date)).forEach(t => {
                list.innerHTML += `<div class="info-card-item"><div class="item-icon-box" style="background:#FFF8E1; color:#FBC02D;"><svg class="icon-svg"><use href="#icon-ticket"></use></svg></div><div class="info-card-content"><div style="font-weight:bold;">${t.name}</div><div class="info-card-sub"><svg class="icon-svg icon-xs"><use href="#icon-nav-cal"></use></svg> ${t.date}</div><div class="info-card-sub" style="color:#666;">#${t.order||'無編號'}</div></div><div style="flex-shrink:0;"><button class="btn-edit" onclick="window.openTicketModal(${t.id})">✎</button><button class="btn-del" onclick="window.delItem('tickets', ${t.id})">✕</button></div></div>`;
            });
        };

        window.openCharterModal = function(id) { 
            appState.editId = id; appState.editType='charter'; resetModal('charter', id); 
            if(id) { const c = currentTrip.charters.find(x=>x.id===id); appState.charterType=c.type; } else appState.charterType='接送';
            updateCharterBtns(); window.openModal('charter'); 
        };
        window.setCharterType = function(el, t) { appState.charterType=t; updateCharterBtns(); };
        function updateCharterBtns() { document.querySelectorAll('#modal-charter .chip-btn').forEach(b => b.classList.toggle('active', b.innerText.includes(appState.charterType))); }
        window.saveCharter = function() { 
            saveItem('charters', { type:appState.charterType, date:v('c-date'), time:v('c-time'), from:v('c-from'), to:v('c-to'), contact:v('c-contact'), note:v('c-note') });
        };
        window.renderCharters = function() {
            const list = document.getElementById('charter-list'); list.innerHTML = '';
            (currentTrip.charters||[]).sort((a,b)=>a.date.localeCompare(b.date)).forEach(c => {
                let noteHtml = c.note ? `<div class="note-row"><svg class="icon-svg"><use href="#icon-note"></use></svg> ${c.note}</div>` : '';
                let contactHtml = c.contact ? `<div class="note-row"><svg class="icon-svg"><use href="#icon-phone"></use></svg> ${c.contact}</div>` : '';
                list.innerHTML += `<div class="info-card-item"><div class="item-icon-box" style="background:#F3F0FF; color:#9F7AEA;"><svg class="icon-svg"><use href="#icon-car"></use></svg></div><div class="info-card-content"><div class="info-card-title" style="color:var(--primary); font-size:0.9rem;">${c.date} ${c.time}</div><div style="font-weight:bold;">${c.type}</div><div class="info-card-sub" style="font-weight:bold; color:var(--text);">${c.from} ➝ ${c.to}</div>${contactHtml}${noteHtml}</div><div style="flex-shrink:0;"><button class="btn-edit" onclick="window.openCharterModal(${c.id})">✎</button><button class="btn-del" onclick="window.delItem('charters', ${c.id})">✕</button></div></div>`;
            });
        };

        // --- Money ---
        // 新增：設定列表篩選成員
        window.setMoneyListFilter = function(member) {
            moneyListMemberFilter = member;
            window.renderMoney();
        };

        // 修改：處理 FAB 按鈕邏輯 (根據分頁開啟不同 Modal)
        window.handleMoneyFab = function() {
            if (appState.moneyTab === 'split') {
                window.openSplitModal();
            } else {
                window.openMoneyModal();
            }
        };

        window.openMoneyModal = function(id) {
            appState.editId = id; appState.editType='money';
            
            // 重置按鈕樣式
            document.querySelectorAll('.method-btn').forEach(b => b.classList.remove('active'));

            if(id) {
                const m = currentTrip.money.find(x=>x.id===id);
                document.getElementById('m-title').value = m.title;
                document.getElementById('m-cost').value = m.cost;
                document.getElementById('m-date').value = m.date;
                document.getElementById('m-curr').value = m.curr || 'NT$';
                document.getElementById('m-note').value = m.note || ''; // 讀取備註
                
                moneyState.payer = m.payer; 
                moneyState.method = m.method;
            } else {
                ['m-title','m-cost','m-note'].forEach(k=>document.getElementById(k).value='');
                moneyState.payer = currentTrip.members[0]; 
                moneyState.method = 'cash';
                
                const d = new Date(currentTrip.startDate); 
                d.setDate(d.getDate() + appState.dayIdx);
                document.getElementById('m-date').value = d.toISOString().split('T')[0];
            }
            
            // 更新 UI 按鈕狀態
            renderPayerBtns(); 
            renderMethodBtns();
            
            const delBtn = document.getElementById('btn-delete-money');
            if(id) delBtn.style.display = 'flex'; else delBtn.style.display = 'none';
            
            window.openModal('money');
        };
        
        window.deleteMoneyItemInModal = function() {
            if(!appState.editId) return;
            if(confirm('確定刪除此筆帳務？')) {
                currentTrip.money = currentTrip.money.filter(x => x.id !== appState.editId);
                window.saveData();
                window.closeModal('money');
            }
        };

        function renderPayerBtns() {
            const c = document.getElementById('m-payer-wrapper'); c.innerHTML='';
            currentTrip.members.forEach(m => {
                const b = document.createElement('button'); b.className='chip-btn';
                b.innerText=m;
                if(moneyState.payer===m) b.classList.add('active');
                b.onclick = () => { moneyState.payer=m; renderPayerBtns(); };
                c.appendChild(b);
            });
        }
        function renderMethodBtns() {
            document.querySelectorAll('.method-btn').forEach(b => {
                b.classList.remove('active');
                const text = b.innerText;
                if((text==='現金' && moneyState.method==='cash') || (text==='信用卡' && moneyState.method==='card')) {
                   b.classList.add('active'); 
                }
            });
        }
        window.setMoneyMethod = function(m, el) { moneyState.method=m; renderMethodBtns(); };
        
        window.saveMoney = function() {
            const title = v('m-title');
            const cost = parseFloat(v('m-cost'));
            if(!title || isNaN(cost)) return alert('請輸入項目與金額');

            saveItem('money', { 
                dayIdx: appState.dayIdx, 
                date: v('m-date'), 
                title: title, 
                cost: cost, 
                curr: document.getElementById('m-curr').value, 
                payer: moneyState.payer, 
                method: moneyState.method,
                note: v('m-note') // 儲存備註
            });
        };

        window.renderMoney = function() {
            const list = document.getElementById('list-money'); 
            const tabs = document.getElementById('money-list-member-tabs');
            list.innerHTML='';
            tabs.innerHTML='';

            // 1. 渲染成員分頁按鈕 (Tabs)
            const allBtn = document.createElement('button');
            allBtn.className = `sub-nav-btn ${moneyListMemberFilter === 'all' ? 'active' : ''}`;
            allBtn.innerText = '全體';
            allBtn.onclick = () => window.setMoneyListFilter('all');
            tabs.appendChild(allBtn);

            currentTrip.members.forEach(m => {
                const btn = document.createElement('button');
                btn.className = `sub-nav-btn ${moneyListMemberFilter === m ? 'active' : ''}`;
                btn.innerText = m;
                btn.onclick = () => window.setMoneyListFilter(m);
                tabs.appendChild(btn);
            });
            
            // 2. 篩選當日
            const dailyItems = (currentTrip.money||[]).filter(i=>i.dayIdx===appState.dayIdx);
            const methodMap = { 'cash': '現金', 'card': '信用卡', 'other': '其他' };
            
            // 3. 準備顯示項目 (根據分頁)
            let displayItems = [];
            if(moneyListMemberFilter === 'all') {
                displayItems = dailyItems;
            } else {
                displayItems = dailyItems.filter(i => i.payer === moneyListMemberFilter);
            }

            // 4. 計算每日總金額 (根據當前篩選結果)
            let totals = {};
            displayItems.forEach(i => {
                const curr = i.curr || 'NT$';
                totals[curr] = (totals[curr] || 0) + parseFloat(i.cost);
            });

            // 5. 渲染總金額區塊
            const currencies = Object.keys(totals);
            if(currencies.length > 0) {
                const totalStr = currencies.map(c => `${c} ${totals[c].toLocaleString()}`).join('  +  ');
                const titleStr = moneyListMemberFilter === 'all' ? '當日合計' : `${moneyListMemberFilter} 合計`;
                list.innerHTML += `<div class="daily-total-box">
                                        <span class="dt-label">${titleStr}:</span> 
                                        <span class="dt-val">${totalStr}</span>
                                   </div>`;
            }

            // 6. 渲染列表
            if(displayItems.length === 0) {
                list.innerHTML += '<div style="text-align:center; padding:20px; color:#ccc;">無支出</div>';
            } else {
                // 反轉讓新的在上面
                displayItems.slice().reverse().forEach(i => {
                    const noteHtml = i.note ? `<span style="font-size:0.85rem; color:#999; font-weight:normal; margin-left:6px;">(${i.note})</span>` : '';
                    
                    list.innerHTML += `
                    <div class="money-item-row" onclick="window.openMoneyModal(${i.id})">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div class="money-info">
                                <div class="money-title">${i.title}${noteHtml}</div>
                                <div class="money-meta">
                                    <span class="money-tag">${i.payer}</span>
                                    <span>${methodMap[i.method]}</span>
                                </div>
                            </div>
                        </div>
                        <div class="money-amount">${i.curr} ${i.cost.toLocaleString()}</div>
                    </div>`;
                });
            }
        };

        window.switchMoneySub = function(sub) {
            appState.moneyTab = sub; // 記錄當前分頁以控制 FAB
            document.getElementById('money-view-list').classList.toggle('hidden', sub!=='list');
            document.getElementById('money-view-analysis').classList.toggle('hidden', sub!=='analysis');
            document.getElementById('money-view-split').classList.toggle('hidden', sub!=='split'); // 新增

            document.getElementById('btn-money-list').classList.toggle('active', sub==='list');
            document.getElementById('btn-money-analysis').classList.toggle('active', sub==='analysis');
            document.getElementById('btn-money-split').classList.toggle('active', sub==='split'); // 新增

            if(sub==='analysis') window.renderMoneyAnalysis();
            if(sub==='split') window.renderSplitBills(); // 新增
        };

        window.toggleAnalysisDetail = function(member) {
            const el = document.getElementById(`analysis-detail-${member}`);
            if(el) {
                const isHidden = el.classList.contains('hidden');
                // 關閉其他所有已打開的明細，確保不重疊且整潔
                document.querySelectorAll('.analysis-detail-box').forEach(e => e.classList.add('hidden'));
                
                if(isHidden) {
                    el.classList.remove('hidden');
                }
            }
        };

        window.renderMoneyAnalysis = function() {
            const container = document.getElementById('analysis-content'); 
            container.innerHTML = '';
            
            // 資料處理
            let memberTotals = {};
            let memberItems = {};
            
            currentTrip.members.forEach(m => { 
                memberTotals[m] = {}; 
                memberItems[m] = []; 
            });
            
            currentTrip.money.forEach(m => {
                const curr = m.curr || 'NT$';
                const cost = parseFloat(m.cost);
                const payer = m.payer || currentTrip.members[0];
                
                memberTotals[payer][curr] = (memberTotals[payer][curr] || 0) + cost;
                memberItems[payer].push(m);
            });

            // 產生各別成員總支出卡片
            currentTrip.members.forEach(member => {
                const totals = memberTotals[member];
                const hasSpending = Object.keys(totals).length > 0;
                
                let totalStr = '';
                if(hasSpending) {
                    totalStr = Object.keys(totals).map(c => `${c} ${totals[c].toLocaleString()}`).join('  /  ');
                } else {
                    totalStr = '無支出';
                }

                // 生成明細列表
                const items = memberItems[member];
                items.sort((a,b) => {
                     if(a.date !== b.date) return b.date.localeCompare(a.date);
                     return b.id - a.id;
                });

                let detailHtml = '';
                if(items.length > 0) {
                    items.forEach(i => {
                        const noteHtml = i.note ? `<span style="font-size:0.8rem; color:#999; margin-left:5px;">(${i.note})</span>` : '';
                        detailHtml += `
                            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; align-items:center;">
                                <div>
                                    <div style="font-size:0.75rem; color:#AAA;">${i.date.slice(5)}</div>
                                    <div style="font-weight:bold; font-size:0.95rem;">${i.title} ${noteHtml}</div>
                                </div>
                                <div style="font-weight:bold;">${i.curr} ${i.cost.toLocaleString()}</div>
                            </div>
                        `;
                    });
                } else {
                    detailHtml = '<div style="text-align:center; padding:10px; color:#ccc;">無紀錄</div>';
                }

                container.innerHTML += `
                    <div class="member-stat-wrapper">
                        <div class="member-stat-card" onclick="window.toggleAnalysisDetail('${member}')">
                            <div class="m-stat-header">
                                <span>${member}</span>
                                <svg class="icon-svg icon-sm"><use href="#icon-chart-bar"/></svg>
                            </div>
                            <div class="m-stat-total">${totalStr}</div>
                        </div>
                        <div id="analysis-detail-${member}" class="analysis-detail-box hidden">
                            ${detailHtml}
                        </div>
                    </div>
                `;
            });
        };

        // --- Split Bill Logic ---
        window.openSplitModal = function(id) {
            appState.editId = id; appState.editType = 'split';
            const container = document.getElementById('sp-members-container');
            container.innerHTML = '';

            // 填入付款人選單
            const payerSel = document.getElementById('sp-payer');
            payerSel.innerHTML = '';
            currentTrip.members.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m; opt.innerText = m;
                payerSel.appendChild(opt);
            });

            let data = null;
            if(id) {
                data = currentTrip.splitBills.find(x => x.id === id);
                document.getElementById('sp-date').value = data.date;
                document.getElementById('sp-title').value = data.title;
                document.getElementById('sp-curr').value = data.curr;
                // 新增：回填總金額，不自動開啟平分以免覆蓋手動輸入
                document.getElementById('sp-total').value = data.total || 0; 
                // Reset check state
                document.getElementById('sp-is-even-check').classList.remove('active'); 
                payerSel.value = data.payer;
                document.getElementById('btn-delete-split').style.display = 'flex';
            } else {
                document.getElementById('sp-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('sp-title').value = '';
                document.getElementById('sp-total').value = '';
                document.getElementById('sp-is-even-check').classList.remove('active'); 
                payerSel.value = currentTrip.members[0];
                document.getElementById('btn-delete-split').style.display = 'none';
            }

            // 生成成員輸入列
            currentTrip.members.forEach(m => {
                let should = '';
                let paid = '';
                let isChecked = true; // 預設都參與分攤

                if (data && data.details && data.details[m]) {
                    should = data.details[m].should || '';
                    paid = data.details[m].paid || '';
                    // 如果有編輯，且該成員需付金額為0，可能當時沒參與（這裡簡單判斷）
                    if(id && parseFloat(should) === 0) isChecked = false;
                }

                container.innerHTML += `
                    <div class="split-input-row">
                        <div class="split-check ${isChecked?'active':''}" onclick="window.toggleSplitCheck(this); window.calcSplit();" data-member="${m}">✓</div>
                        <div class="split-input-name">${m}</div>
                        <input type="number" class="split-input-sm sp-should" data-member="${m}" placeholder="需付" value="${should}" oninput="window.uncheckEven()">
                        <input type="number" class="split-input-sm sp-paid" data-member="${m}" placeholder="已還" value="${paid}">
                    </div>
                `;
            });

            window.openModal('split');
        };

        // UI Helper: Toggle Checkbox
        window.toggleSplitCheck = function(el) {
            el.classList.toggle('active');
        };

        // Logic: Uncheck 'Even' box if manual edit
        window.uncheckEven = function() {
            document.getElementById('sp-is-even-check').classList.remove('active');
        };

        // Logic: Auto Calculate Split
        window.calcSplit = function() {
            const isEven = document.getElementById('sp-is-even-check').classList.contains('active');
            if(!isEven) return; // If not even split mode, do nothing

            const total = parseFloat(document.getElementById('sp-total').value) || 0;
            // Select member checkboxes
            const container = document.getElementById('sp-members-container');
            const checks = container.querySelectorAll('.split-check.active');
            const count = checks.length;

            if(count === 0) return;

            const share = Math.floor(total / count); // Simple floor, last one adjustment maybe? Keep simple for now
            
            // First clear all
            document.querySelectorAll('.sp-should').forEach(inp => inp.value = 0);

            // Fill selected
            checks.forEach(c => {
                const m = c.getAttribute('data-member');
                const input = document.querySelector(`.sp-should[data-member="${m}"]`);
                if(input) {
                    input.value = share;
                    // input.disabled = true; // Optional: Disable manual edit while in Even mode
                }
            });
        };

        window.saveSplitBill = function() {
            const date = v('sp-date');
            const title = v('sp-title');
            const payer = document.getElementById('sp-payer').value;
            const curr = document.getElementById('sp-curr').value;
            const totalInput = parseFloat(document.getElementById('sp-total').value) || 0;
            
            if(!title) return alert('請輸入項目名稱');

            let details = {};
            let calculatedTotal = 0;
            
            document.querySelectorAll('.sp-should').forEach(el => {
                const m = el.getAttribute('data-member');
                const row = el.parentElement;
                const shouldVal = parseFloat(el.value) || 0;
                const paidVal = parseFloat(row.querySelector('.sp-paid').value) || 0;
                
                details[m] = {
                    should: shouldVal,
                    paid: paidVal
                };
                calculatedTotal += shouldVal;
            });

            // Use the calculated total from members sum to be precise, or input total?
            // Usually the sum of splits is the truth.
            const finalTotal = calculatedTotal > 0 ? calculatedTotal : totalInput;

            const newItem = {
                id: appState.editId || Date.now(),
                date, title, payer, curr, 
                total: finalTotal, 
                details
            };

            if(appState.editId) {
                const idx = currentTrip.splitBills.findIndex(x=>x.id===appState.editId);
                if(idx!==-1) currentTrip.splitBills[idx] = newItem;
            } else {
                currentTrip.splitBills.push(newItem);
            }

            window.saveData();
            window.closeModal('split');
            window.renderSplitBills();
        };

        window.deleteSplitItem = function() {
            if(confirm('確定刪除此分帳紀錄？')) {
                currentTrip.splitBills = currentTrip.splitBills.filter(x=>x.id!==appState.editId);
                window.saveData();
                window.closeModal('split');
                window.renderSplitBills();
            }
        };

        window.renderSplitBills = function() {
            const list = document.getElementById('split-list-container');
            list.innerHTML = '';

            if(!currentTrip.splitBills || currentTrip.splitBills.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:30px; color:#ccc;">尚無分帳紀錄<br><span style="font-size:0.8rem;">點擊 + 新增</span></div>';
                return;
            }

            const sorted = [...currentTrip.splitBills].sort((a,b) => b.date.localeCompare(a.date));

            sorted.forEach(item => {
                let membersHtml = '';
                
                currentTrip.members.forEach(m => {
                    const d = item.details[m] || {should:0, paid:0};
                    const owe = d.should - d.paid;
                    
                    if (d.should > 0 || owe !== 0) {
                        let statusHtml = '';
                        if (owe > 0) statusHtml = `<span class="split-owe">欠 ${owe}</span>`;
                        else if (owe < 0) statusHtml = `<span class="split-clean">找 ${Math.abs(owe)}</span>`;
                        else statusHtml = `<span class="split-clean">✔ 結清</span>`;

                        membersHtml += `
                            <div class="split-member-row">
                                <div class="split-member-name">${m}</div>
                                <div class="split-val-group">
                                    <span><span class="split-label">需付</span>${d.should}</span>
                                    <span><span class="split-label">已付</span>${d.paid}</span>
                                    ${statusHtml}
                                </div>
                            </div>
                        `;
                    }
                });

                list.innerHTML += `
                    <div class="split-card" onclick="window.openSplitModal(${item.id})">
                        <div class="split-header">
                            <div>
                                <div class="split-title">${item.title} <span style="font-weight:normal; font-size:0.9rem;">(${item.curr} ${item.total})</span></div>
                                <div class="split-date">${item.date}</div>
                            </div>
                            <div class="split-payer-badge">墊: ${item.payer}</div>
                        </div>
                        <div>${membersHtml}</div>
                    </div>
                `;
            });
        };

        window.openMap = function(e, loc) { e.stopPropagation(); window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`); };
        window.fetchRate = async function() {
            const curr = document.getElementById('rate-currency').value;
            try { const res = await fetch(`https://api.exchangerate-api.com/v4/latest/TWD`); const data = await res.json(); if(data.rates[curr]) { currentRate = 1/data.rates[curr]; window.updateRateCalc(); } } catch(e){}
        };
        window.updateRateCalc = function() {
            const amt = parseFloat(document.getElementById('rate-amount').value) || 0;
            document.getElementById('rate-display').innerText = amt===0 ? `1 : ${currentRate.toFixed(2)}` : `$${(amt*currentRate).toFixed(0)}`;
        };
        window.fetchWeatherForDay = async function() {
            if(!currentTrip.city) return;
            const dateStr = window.getTargetDateStr(currentTrip.startDate, appState.dayIdx);
            try {
                const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(currentTrip.city)}&count=1&language=zh&format=json`);
                const geoData = await geoRes.json();
                
                if(!geoData.results || geoData.results.length === 0) {
                     document.getElementById('weather-loc').innerText = "找不到地點";
                     return;
                }
                
                const {latitude, longitude, name} = geoData.results[0];
                document.getElementById('weather-loc').innerText = name;
                
                const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=weathercode,temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_probability_max&timezone=auto&start_date=${dateStr}&end_date=${dateStr}`);
                const wData = await wRes.json();
                if(wData.daily) {
                    document.getElementById('weather-temp').innerText = Math.round(wData.daily.temperature_2m_max[0]);
                    document.getElementById('w-max').innerText = Math.round(wData.daily.temperature_2m_max[0]);
                    document.getElementById('w-min').innerText = Math.round(wData.daily.temperature_2m_min[0]);
                    document.getElementById('w-rise').innerText = wData.daily.sunrise[0].split('T')[1];
                    document.getElementById('w-set').innerText = wData.daily.sunset[0].split('T')[1];
                    document.getElementById('w-rain').innerText = wData.daily.precipitation_probability_max[0];
                    setWeatherIcon(wData.daily.weathercode[0]);
                }
            } catch(e) { console.error(e); }
        };
        function setWeatherIcon(code) {
            let icon='#icon-sun', t='晴';
            if(code>3) { icon='#icon-cloud'; t='雲'; }
            if(code>50) { icon='#icon-rain'; t='雨'; }
            document.getElementById('weather-icon-box').innerHTML = `<svg class="icon-svg"><use href="${icon}"></use></svg>`;
            document.getElementById('weather-text').innerText = t;
        }

        // --- Itinerary ---
        window.getTargetDateStr = function(startStr, dayOffset) {
            if(!startStr) return new Date().toISOString().split('T')[0]; // Safe Fallback
            const parts = startStr.split('-');
            if(parts.length !== 3) return new Date().toISOString().split('T')[0];
            const d = new Date(parts[0], parts[1]-1, parts[2]);
            d.setDate(d.getDate() + dayOffset);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        };

        window.renderAllDetail = function() {
            if (!currentTrip) return;
            const dc = document.getElementById('day-tabs-itinerary'); 
            const mc = document.getElementById('day-tabs-money'); 
            if(dc) dc.innerHTML = ''; 
            if(mc) mc.innerHTML = '';
            
            const daysCount = currentTrip.days || 1; 
            const dayNames = ["週日", "週一", "週二", "週三", "週四", "週五", "週六"];

            for(let i=0; i<daysCount; i++) {
                const dateStr = window.getTargetDateStr(currentTrip.startDate, i);
                const d = new Date(dateStr);
                const html = `
                    <div class="d-num">DAY ${i+1}</div>
                    <div class="d-date">${d.getMonth()+1}/${d.getDate()}</div>
                    <div class="d-week">${dayNames[d.getDay()]}</div>
                `;
                
                const div = document.createElement('div'); 
                div.className=`day-chip ${i===appState.dayIdx?'active':''}`; 
                div.innerHTML=html; 
                div.onclick=()=>{
                    appState.dayIdx=i; 
                    window.renderAllDetail();
                };
                
                if(dc) dc.appendChild(div);
                
                // For Money Tab
                if(mc) {
                    const divM = div.cloneNode(true); 
                    divM.onclick=()=>{
                        appState.dayIdx=i; 
                        window.renderAllDetail(); 
                        window.renderMoney();
                    };
                    mc.appendChild(divM);
                }
            }
            window.renderItinerary(); 
            window.fetchWeatherForDay();
        };

        window.renderItinerary = function() {
            const list = document.getElementById('list-itinerary'); 
            const flightC = document.getElementById('flight-card-container'); 
            const nightStayC = document.getElementById('night-stay-container'); 
            
            if(list) list.innerHTML = '';
            if(flightC) flightC.innerHTML = '';
            if(nightStayC) nightStayC.innerHTML = '';
            
            if(!currentTrip) return;
            if(!currentTrip.itinerary) currentTrip.itinerary = [];

            // Flight Logic (Using array structure)
            const currentDayDate = window.getTargetDateStr(currentTrip.startDate, appState.dayIdx);
            let fList = [];
            let title = '';

            // Combine outbound and inbound checking
            if (currentTrip.flights) {
                // Check Outbound
                if (currentTrip.flights.out) {
                    currentTrip.flights.out.forEach(f => {
                        if (f.date === currentDayDate) {
                            fList.push({ ...f, type: 'OUTBOUND' });
                        }
                    });
                }
                // Check Inbound
                if (currentTrip.flights.in) {
                    currentTrip.flights.in.forEach(f => {
                        if (f.date === currentDayDate) {
                            fList.push({ ...f, type: 'INBOUND' });
                        }
                    });
                }
            }
            
            if (fList.length > 0 && flightC) {
                let flightsHtml = '';
                fList.forEach(f => {
                    const depTermHtml = f.depTerm ? `<span class="bp-term">${f.depTerm}</span>` : '';
                    const arrTermHtml = f.arrTerm ? `<span class="bp-term">${f.arrTerm}</span>` : '';
                    
                    flightsHtml += `
                    <div class="bp-card">
                        <div class="bp-header">${f.type === 'OUTBOUND' ? '去程 OUTBOUND' : '回程 INBOUND'}</div>
                        <div class="bp-body">
                            <div class="bp-group">
                                <span class="bp-code">${f.depAir||'DEP'}</span>
                                ${depTermHtml}
                                <span class="bp-time">${f.depTime||'--:--'}</span>
                            </div>
                            <div class="bp-center">
                                <div style="font-size:0.8rem;">${f.airline}</div>
                                <div class="bp-line"></div>
                                <div style="color:var(--primary); font-weight:bold;">${f.code}</div>
                                <div class="bp-duration">${calcDuration(f.depTime,f.depTz,f.arrTime,f.arrTz)}</div>
                            </div>
                            <div class="bp-group">
                                <span class="bp-code">${f.arrAir||'ARR'}</span>
                                ${arrTermHtml}
                                <span class="bp-time">${f.arrTime||'--:--'}</span>
                            </div>
                        </div>
                    </div>`;
                });
                flightC.innerHTML = flightsHtml;
            } else if (flightC) {
                flightC.innerHTML = '';
            }

            // Itinerary Items: Match by DATE
            let mixed = (currentTrip.itinerary||[]).filter(x => {
                // If item has date, match date. If legacy item (no date), match dayIdx (fallback)
                if(x.date) return x.date === currentDayDate;
                return x.dayIdx === appState.dayIdx;
            }).map(x=>({...x, src:'it'}));

            // Charters also need date match
            (currentTrip.charters||[]).filter(x=>x.date===currentDayDate).forEach(x=>mixed.push({...x, src:'charter', loc:x.from, title:x.type}));
            
            mixed.sort((a,b) => (a.time||'').localeCompare(b.time||''));

            const icons = { spot:'icon-spot', food:'icon-food', shop:'icon-nav-shop', transport:'icon-transport', other:'icon-star', charter:'icon-car' };

            mixed.forEach(item => {
                let timeHTML = item.time;
                let title = item.loc || item.title;
                let sub = '';
                
                if(item.type === 'transport') {
                    timeHTML = `<div class="trans-time-group"><div class="trans-t-val">${item.time}</div><div class="trans-arrow">↓</div><div class="trans-t-val">${item.endTime || '--:--'}</div></div>`;
                    if(item.dest) { 
                        sub = `<div style="font-size:0.85rem; color:var(--text); margin-top:4px; display:flex; align-items:center; gap:5px;"><span>${item.loc}</span><span style="color:var(--primary);">➝</span><span>${item.dest}</span></div>`; 
                        title = item.title || "移動"; 
                    }
                } else { 
                    if(item.title && item.title!==item.loc) sub = `<div style="font-size:0.85rem; color:#999; margin-top:2px;">${item.title}</div>`; 
                }
                
                if(item.open) {
                     sub += `<div class="open-badge"><svg class="icon-svg"><use href="#icon-clock"></use></svg>${item.open}</div>`;
                }

                const clickAction = item.src==='charter' ? `window.openCharterModal(${item.id})` : `window.editItinerary(${item.id})`;
                const mapBtn = (item.loc || item.dest) ? `<button class="btn-map-icon" onclick="event.stopPropagation(); window.openMap(event, '${item.type==='transport'?item.dest:item.loc}')"><svg class="icon-svg icon-sm"><use href="#icon-map-pin"></use></svg></button>` : '';
                
                if(list) list.innerHTML += `<div class="timeline-item" onclick="${clickAction}"><div class="time-bubble">${timeHTML}</div><div class="it-card type-${item.type}"><div class="it-icon"><svg class="icon-svg icon-sm"><use href="#${icons[item.type]||'icon-star'}"></use></svg></div><div style="flex:1; min-width:0;"><div style="font-weight:bold; font-size:1.05rem;">${title}</div>${sub}<div class="it-note">${item.note||''}</div></div><div class="it-actions">${mapBtn}</div></div></div>`;
            });

            // Night Stay
            if(nightStayC) {
                const stay = (currentTrip.hotels||[]).find(h => {
                    const checkIn = new Date(h.date);
                    const checkOut = new Date(h.date);
                    checkOut.setDate(checkOut.getDate() + parseInt(h.days));
                    const currentD = new Date(currentDayDate);
                    return currentD >= checkIn && currentD < checkOut;
                });
                if(stay) {
                    nightStayC.innerHTML = `<div class="night-stay-box"><svg class="icon-svg"><use href="#icon-moon"></use></svg><div><div style="font-size:0.8rem; opacity:0.8;">Tonight's Stay</div><div style="font-weight:bold; font-size:1.1rem;">${stay.name}</div><div style="font-size:0.8rem;">${stay.address}</div></div></div>`;
                }
            }
        };

        window.openNewItinerary = function() {
            appState.editId = null;
            // 清空
            ['i-time','i-title','i-loc','i-note','i-open','i-end-time','i-dest'].forEach(id=>document.getElementById(id).value='');
            // 預設填入當前分頁的日期
            document.getElementById('i-date').value = window.getTargetDateStr(currentTrip.startDate, appState.dayIdx);
            
            const typeSelect = document.getElementById('i-type');
            typeSelect.value = 'spot';
            typeSelect.dispatchEvent(new Event('change')); // Trigger visibility logic
            window.openModal('itinerary');
        };
        window.editItinerary = function(id) {
            const item = currentTrip.itinerary.find(i=>i.id===id);
            if(!item) return;
            appState.editId = id;
            document.getElementById('i-time').value=item.time;
            // 如果舊資料沒有日期，就幫他算一個填進去
            document.getElementById('i-date').value = item.date || window.getTargetDateStr(currentTrip.startDate, item.dayIdx);
            
            const typeSelect = document.getElementById('i-type');
            typeSelect.value=item.type;
            typeSelect.dispatchEvent(new Event('change')); 
            
            document.getElementById('i-title').value=item.title;
            document.getElementById('i-loc').value=item.loc;
            document.getElementById('i-note').value=item.note;
            document.getElementById('i-open').value=item.open;
            document.getElementById('i-end-time').value=item.endTime;
            document.getElementById('i-dest').value=item.dest;
            window.openModal('itinerary');
        };
        window.saveItinerary = function() {
            const time = document.getElementById('i-time').value;
            const loc = document.getElementById('i-loc').value;
            const date = document.getElementById('i-date').value;
            
            if(!time || !loc || !date) return alert('請填寫日期、時間與地點');
            
            const newItem = { 
                id: appState.editId || Date.now(), 
                dayIdx: appState.dayIdx, // Kept for legacy reference but date is primary now
                date: date, // Save the specific date
                time, type: document.getElementById('i-type').value, title: document.getElementById('i-title').value, loc, note: document.getElementById('i-note').value, open: document.getElementById('i-open').value, endTime: document.getElementById('i-end-time').value, dest: document.getElementById('i-dest').value 
            };
            
            if(appState.editId) { const idx = currentTrip.itinerary.findIndex(x=>x.id===appState.editId); if(idx!==-1) currentTrip.itinerary[idx] = newItem; } 
            else currentTrip.itinerary.push(newItem);
            window.saveData(); window.closeModal('itinerary');
        };
        window.deleteItineraryItemInModal = function() {
            if(!appState.editId) return;
            if(confirm('確定刪除？')) { currentTrip.itinerary = currentTrip.itinerary.filter(x=>x.id!==appState.editId); window.saveData(); window.closeModal('itinerary'); }
        };

        document.getElementById('i-type').addEventListener('change', function() {
            const val = this.value;
            const openWrapper = document.getElementById('wrapper-open');
            const endTimeWrapper = document.getElementById('wrapper-end-time');
            const startTimeLabel = document.getElementById('label-time-start');
            const destWrapper = document.getElementById('wrapper-dest');
            const titleWrapper = document.getElementById('wrapper-title');
            const locInput = document.getElementById('i-loc');
            const destInput = document.getElementById('i-dest');
            const iTitle = document.getElementById('i-title');

            openWrapper.classList.add('hidden');
            endTimeWrapper.classList.add('hidden');
            destWrapper.classList.add('hidden');
            titleWrapper.classList.add('hidden');
            
            startTimeLabel.innerText = "開始時間";
            locInput.placeholder = "Google Maps 地點";

            if(val === 'food' || val === 'spot' || val === 'shop') {
                openWrapper.classList.remove('hidden');
            } else if (val === 'transport') {
                startTimeLabel.innerText = "出發時間";
                endTimeWrapper.classList.remove('hidden');
                destWrapper.classList.remove('hidden');
                locInput.placeholder = "出發地";
                destInput.placeholder = "抵達地";
                titleWrapper.classList.remove('hidden');
                iTitle.placeholder = "班次/車種 (如: JR山手線)";
            }
        });

        window.renderHome();

    </script>
</body>
</html>
