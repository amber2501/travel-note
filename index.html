<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…éŠæ‰‹å¸³ Pro Max+ â˜ï¸</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <!-- å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* è«è˜­è¿ªé…è‰²ç³»çµ± */
            --primary: #759CB0;        /* ä¸»è‰²ï¼šç°è— */
            --primary-light: #E6EEF2;  /* æ·ºèƒŒæ™¯ */
            --primary-dark: #4F7082;   /* æ·±è‰²æ–‡å­— */
            --secondary: #E0C8B0;      /* è¼”åŠ©è‰²ï¼šæš–æ */
            --accent: #DFA7A2;         /* å¼·èª¿è‰²ï¼šä¹¾ç‡¥ç²‰ */
            --text: #595959;           /* å…§æ–‡æ·±ç° */
            --text-light: #999999;     /* è¼”åŠ©æ–‡å­— */
            --bg-body: #F7F9FA;        /* å…¨å±€èƒŒæ™¯ */
            --card-bg: #FFFFFF;
            
            --nav-height: 70px;
            --radius: 16px;
            --shadow: 0 4px 12px rgba(117, 156, 176, 0.15);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--bg-body);
            color: var(--text);
            padding-bottom: calc(var(--nav-height) + 50px);
            -webkit-overflow-scrolling: touch;
        }

        .hidden { display: none !important; }

        /* --- SVG --- */
        .icon-svg { width: 22px; height: 22px; stroke: currentColor; stroke-width: 1.8; fill: none; stroke-linecap: round; stroke-linejoin: round; transition: 0.3s; }
        .icon-sm { width: 18px; height: 18px; stroke-width: 2; }
        .icon-nav { width: 24px; height: 24px; stroke-width: 1.8; margin-bottom: 4px; }

        /* --- UI å…ƒä»¶ --- */
        .btn {
            border: none; border-radius: var(--radius);
            padding: 10px 16px; font-size: 0.95rem; font-weight: 700;
            cursor: pointer; background: white; color: var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            font-family: inherit;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(117, 156, 176, 0.3); }
        .btn-del { background: #FFF0F0; color: #E57373; font-size: 0.8rem; padding: 6px 12px; border-radius: 10px; }
        .btn-edit { background: #F0F4F8; color: var(--primary); font-size: 0.8rem; padding: 6px 12px; border-radius: 10px; margin-right: 5px; }

        input, select, textarea {
            width: 100%; padding: 12px; border: 1px solid #EEE; border-radius: 12px;
            background: #F9F9F9; font-size: 15px; outline: none; margin-bottom: 10px; font-family: inherit; color: var(--text);
        }
        input:focus, textarea:focus { background: white; border-color: var(--primary); }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }

        /* --- Header --- */
        .sticky-header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(247, 249, 250, 0.95); backdrop-filter: blur(8px);
            padding-top: env(safe-area-inset-top); border-bottom: 1px solid rgba(0,0,0,0.03);
        }
        .header-top { padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; }
        .header-title { font-size: 1.2rem; color: var(--primary-dark); font-weight: 900; }
        .back-btn { background: transparent; color: var(--text-light); border: none; font-weight: bold; font-size: 0.9rem;}

        .sub-nav { display: flex; padding: 0 20px 10px; gap: 10px; overflow-x: auto; scrollbar-width: none; }
        .sub-nav-btn {
            flex: 0 0 auto; padding: 8px 16px; min-width: 80px;
            border: 1px solid #EEE; background: white; border-radius: 20px;
            font-size: 0.9rem; color: var(--text-light); font-weight: 700;
        }
        .sub-nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(117, 156, 176, 0.3); }

        /* --- å¡ç‰‡ --- */
        .container { padding: 20px; padding-bottom: 100px; max-width: 600px; margin: 0 auto; }
        .card {
            background: var(--card-bg); border-radius: var(--radius);
            padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); position: relative;
        }
        .card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; color: var(--primary-dark); font-weight: 800; font-size: 1rem; }
        .card-label { font-size: 0.8rem; color: var(--text-light); font-weight: 700; margin-bottom: 4px; display: block; }

        /* è¡Œå‰å€å¡Š */
        .flight-block { background: #F4F8FA; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px dashed #D0DEE5; }
        
        .item-row { display: flex; align-items: flex-start; padding: 15px 0; border-bottom: 1px dashed #EEE; gap: 12px; }
        .item-row:last-child { border-bottom: none; }
        .item-icon { width: 42px; height: 42px; border-radius: 12px; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .item-content { flex: 1; }
        .item-title { font-weight: bold; color: var(--text); margin-bottom: 4px; font-size: 1rem; }
        .item-desc { font-size: 0.85rem; color: var(--text-light); line-height: 1.4; }

        /* æ¸…å–® */
        .check-row { display: flex; align-items: center; padding: 12px 15px; background: white; margin-bottom: 8px; border-radius: 12px; border: 1px solid #F0F0F0; transition:0.2s; }
        .check-row.checked { background: #FAFAFA; }
        .check-row.checked .check-text { text-decoration: line-through; color: #CCC; }
        .check-input { width: 22px; height: 22px; accent-color: var(--primary); margin: 0 12px 0 0; cursor: pointer; }
        .check-text { flex: 1; font-weight: bold; font-size: 0.95rem; color: var(--text); transition:0.2s;}

        /* --- è¡Œç¨‹é é¢ --- */
        .day-scroller { display: flex; overflow-x: auto; padding: 10px 20px; gap: 8px; scrollbar-width: none; }
        .day-chip { 
            padding: 8px 16px; border-radius: 14px; background: white; border: 1px solid #EEE; color: var(--text-light); 
            text-align: center; font-size: 0.9rem; font-weight: bold; min-width: 70px;
        }
        .day-chip.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(117, 156, 176, 0.4); }

        .timeline-box { margin-top: 10px; padding-left: 10px; }
        .timeline-item { display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-start; }
        .time-badge {
            flex-shrink: 0; width: 55px; text-align: center; background: white; color: var(--primary);
            border-radius: 12px; padding: 6px 0; font-weight: 800; font-size: 0.9rem; border: 2px solid var(--primary-light);
        }
        .it-card {
            flex: 1; background: white; border-radius: 16px; padding: 12px 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid #F0F0F0;
            display: flex; align-items: center; gap: 12px; position: relative;
        }
        /* äº¤é€šé¡åˆ¥ç‰¹æ®Šæ¨£å¼ */
        .it-card.transport { background: #F4F8FB; border-color: #E8F0F5; }

        .it-icon-box { 
            width: 36px; height: 36px; border-radius: 10px; background: #F7F9FA; 
            color: #8899A6; display: flex; align-items: center; justify-content: center; flex-shrink: 0; 
        }

        /* åº•éƒ¨ä½å®¿é¡¯ç¤º */
        .hotel-footer {
            margin-top: 30px; background: white; border-radius: 16px; padding: 15px;
            border: 2px solid #E0C8B0; display: flex; align-items: center; gap: 12px;
            box-shadow: 0 4px 15px rgba(224, 200, 176, 0.15); color: #8D6E63;
        }

        /* æ–°ç‰ˆæ©Ÿç¥¨å¡ç‰‡ (Boarding Pass) */
        .bp-card {
            background: white; border-radius: 16px; margin-bottom: 25px; overflow: hidden;
            box-shadow: 0 8px 20px rgba(117, 156, 176, 0.15); border: 1px solid #E6EEF2;
            position: relative;
        }
        /* å·¦å³ç¼ºå£æ•ˆæœ */
        .bp-card::before, .bp-card::after {
            content:''; position: absolute; top: 60%; width: 20px; height: 20px; background: var(--bg-body); border-radius: 50%;
            border: 1px solid #E6EEF2; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); z-index: 2;
        }
        .bp-card::before { left: -12px; }
        .bp-card::after { right: -12px; }

        .bp-header { background: var(--primary); color: white; padding: 8px 15px; font-size: 0.85rem; letter-spacing: 2px; font-weight: bold; display: flex; justify-content: space-between; }
        .bp-body { padding: 20px 20px 25px; display: flex; justify-content: space-between; align-items: center; }
        .bp-col { text-align: center; flex: 1; }
        .bp-code { font-size: 2.2rem; font-weight: 900; color: var(--text); line-height: 1; letter-spacing: 1px; }
        .bp-time { font-size: 1.1rem; color: var(--primary); font-weight: 900; margin-top: 5px; }
        .bp-center { flex: 1.5; text-align: center; padding: 0 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.8; }
        .bp-line-icon { width: 100%; height: 2px; background: #DDD; position: relative; margin: 10px 0; border-radius: 2px;}
        .bp-plane-icon { position: absolute; top: -11px; left: 50%; transform: translateX(-50%); background: white; padding: 0 5px; color: var(--primary); }
        .bp-duration { font-size: 0.8rem; color: var(--text-light); font-weight: bold; background: #F4F8FA; padding: 2px 10px; border-radius: 12px; }

        /* å¤©æ°£å¡ */
        .weather-widget {
            background: linear-gradient(120deg, #A1C4FD 0%, #C2E9FB 100%);
            color: white; padding: 15px 20px; border-radius: 20px;
            margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 8px 20px rgba(161, 196, 253, 0.3);
        }
        .w-temp { font-size: 1.8rem; font-weight: 900; }
        .w-info { font-size: 0.9rem; opacity: 0.9; }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; height: 70px; background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px); display: flex; justify-content: space-around; align-items: center;
            border-radius: 35px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); z-index: 1000;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .nav-item { border: none; background: none; color: #C4C8D0; font-size: 0.7rem; font-weight: 700; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 10px; }
        .nav-item.active { color: var(--primary); }
        
        .fab { 
            position: fixed; bottom: 105px; right: 25px; 
            width: 56px; height: 56px; border-radius: 50%; 
            background: var(--primary); color: white; border: none;
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 8px 20px rgba(117, 156, 176, 0.4); z-index: 900; 
        }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(3px); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 85%; max-width: 360px; padding: 25px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.15); animation: popUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* è¨˜å¸³åŒ¯ç‡ */
        .rate-calc { background: white; padding: 15px; border-radius: 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; box-shadow: var(--shadow); }
        .rate-res { font-size: 1.1rem; font-weight: 900; color: var(--primary); margin-left: auto; }
    </style>
</head>
<body>

    <!-- SVG Icon Set (Line Style) -->
    <svg style="display:none;">
        <symbol id="icon-plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V6M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2"></path></symbol>
        <symbol id="icon-pin" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></symbol>
        
        <!-- Nav Icons -->
        <symbol id="icon-nav-info" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></symbol>
        <symbol id="icon-nav-cal" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></symbol>
        <symbol id="icon-nav-money" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path><path d="M12 18V6"></path></symbol>
        <symbol id="icon-nav-shop" viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></symbol>

        <!-- è¡Œå‰é¡åˆ¥ -->
        <symbol id="icon-flight-up" viewBox="0 0 24 24"><path d="M2 22h20"></path><path d="M2 12h.01"></path><path d="M15.5 10.5 8 13"></path><path d="M6 13a2.5 2.5 0 0 1-2-2.5V8.8c0-.6.4-1.1 1-1.3l12.5-4.2a2 2 0 0 1 2.6 1.9v.6a2 2 0 0 1-1.3 1.9l-3.3 1.1"></path><path d="m15.5 10.5 3.3 6.6a1 1 0 0 1-.9 1.4H15"></path></symbol>
        <symbol id="icon-flight-down" viewBox="0 0 24 24"><path d="M2 22h20"></path><path d="M14.5 12.5 7 15"></path><path d="m14.5 12.5 6.4 2.1a1 1 0 0 1 .6 1.3v.6a2 2 0 0 1-2.6 1.3l-12.5-4.2a2 2 0 0 1-1.3-2.5v-1.7a2.5 2.5 0 0 1 2-2.5"></path><path d="m14.5 12.5-4.4-4.4a1 1 0 0 1 .1-1.5l1.6-.5"></path></symbol>
        <symbol id="icon-home" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></symbol>
        <symbol id="icon-ticket" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"></rect><line x1="7" y1="8" x2="17" y2="8"></line><line x1="7" y1="12" x2="17" y2="12"></line><line x1="7" y1="16" x2="17" y2="16"></line></symbol>
        
        <!-- è¡Œç¨‹é¡åˆ¥ (å¹¾ä½•ç°¡ç´„ç‰ˆ) -->
        <symbol id="icon-spot" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></symbol>
        <symbol id="icon-food" viewBox="0 0 24 24"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path></symbol>
        <symbol id="icon-shop" viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><path d="M16 10a4 4 0 0 1-8 0"></path></symbol>
        <symbol id="icon-transport" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"></rect><path d="M3 11h18"></path><circle cx="7" cy="17" r="2"></circle><circle cx="17" cy="17" r="2"></circle></symbol>
        <symbol id="icon-other" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></symbol>

        <!-- ç·šæ¢é£›æ©Ÿ (Boarding Pass ç”¨) -->
        <symbol id="icon-plane-line" viewBox="0 0 24 24"><path d="M2 12h20"></path><path d="M13 5l7 7-7 7"></path></symbol>
    </svg>

    <!-- 1. ä¸»ç•«é¢ -->
    <div id="view-home">
        <div style="text-align:center; padding-top:60px; padding-bottom:40px;">
            <div style="font-size:3.5rem; margin-bottom:10px;">â˜ï¸</div>
            <h1 style="color:var(--primary-dark); margin:0; font-size:1.8rem;">æ—…éŠæ‰‹å¸³</h1>
            <p style="color:var(--text-light); font-size:0.9rem;">My Travel Journal</p>
        </div>
        <div id="trip-list-container" class="container"></div>
        <button class="fab" onclick="openCreateTripModal()">
            <svg class="icon-svg"><use href="#icon-plus"></use></svg>
        </button>
    </div>

    <!-- 2. å…§é  -->
    <div id="view-detail" class="hidden">
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('info')">
                <svg class="icon-nav"><use href="#icon-nav-info"></use></svg> è¡Œå‰
            </button>
            <button class="nav-item" onclick="switchTab('itinerary')">
                <svg class="icon-nav"><use href="#icon-nav-cal"></use></svg> è¡Œç¨‹
            </button>
            <button class="nav-item" onclick="switchTab('money')">
                <svg class="icon-nav"><use href="#icon-nav-money"></use></svg> è¨˜å¸³
            </button>
            <button class="nav-item" onclick="switchTab('shopping')">
                <svg class="icon-nav"><use href="#icon-nav-shop"></use></svg> è³¼ç‰©
            </button>
        </nav>

        <!-- A. è¡Œå‰æº–å‚™ -->
        <div id="tab-info" class="tab-content">
            <div class="sticky-header">
                <div class="header-top">
                    <button class="back-btn" onclick="goHome()">â—€ åˆ—è¡¨</button>
                    <div class="header-title">è¡Œå‰è¦åŠƒ</div>
                    <div style="width:50px;"></div>
                </div>
                <div class="sub-nav">
                    <button class="sub-nav-btn active" onclick="switchInfoSub('flight')">æ©Ÿç¥¨</button>
                    <button class="sub-nav-btn" onclick="switchInfoSub('hotel')">ä½å®¿</button>
                    <button class="sub-nav-btn" onclick="switchInfoSub('ticket')">é–€ç¥¨</button>
                    <button class="sub-nav-btn" onclick="switchInfoSub('packing')">æ¸…å–®</button>
                </div>
            </div>
            
            <div class="container">
                <!-- 1. æ©Ÿç¥¨ -->
                <div id="info-flight" class="info-sub-tab">
                    <div class="card">
                        <div class="card-header"><svg class="icon-svg"><use href="#icon-flight-up"></use></svg> å»ç¨‹ Outbound</div>
                        <div class="flight-block">
                            <span class="card-label">èˆªç­è™Ÿ / èˆªç©º</span>
                            <div class="row">
                                <input class="col" placeholder="JX800" oninput="saveFlight('out', 'code', this.value)" id="f-out-code">
                                <input class="col" placeholder="æ˜Ÿå®‡" oninput="saveFlight('out', 'airline', this.value)" id="f-out-airline">
                            </div>
                            <span class="card-label">æ™‚é–“ (èµ·é£› âœ é™è½)</span>
                            <div class="row">
                                <input type="time" class="col" oninput="saveFlight('out', 'depTime', this.value)" id="f-out-depTime">
                                <input type="time" class="col" oninput="saveFlight('out', 'arrTime', this.value)" id="f-out-arrTime">
                            </div>
                            <span class="card-label">æ©Ÿå ´ (èµ·é£› âœ é™è½)</span>
                            <div class="row">
                                <input class="col" placeholder="TPE" oninput="saveFlight('out', 'depAir', this.value)" id="f-out-depAir">
                                <input class="col" placeholder="NRT" oninput="saveFlight('out', 'arrAir', this.value)" id="f-out-arrAir">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><svg class="icon-svg"><use href="#icon-flight-down"></use></svg> å›ç¨‹ Inbound</div>
                        <div class="flight-block" style="background:#FFF9F9; border-color:#EED0D0;">
                            <span class="card-label">èˆªç­è™Ÿ / èˆªç©º</span>
                            <div class="row">
                                <input class="col" placeholder="JX801" oninput="saveFlight('in', 'code', this.value)" id="f-in-code">
                                <input class="col" placeholder="æ˜Ÿå®‡" oninput="saveFlight('in', 'airline', this.value)" id="f-in-airline">
                            </div>
                            <span class="card-label">æ™‚é–“ (èµ·é£› âœ é™è½)</span>
                            <div class="row">
                                <input type="time" class="col" oninput="saveFlight('in', 'depTime', this.value)" id="f-in-depTime">
                                <input type="time" class="col" oninput="saveFlight('in', 'arrTime', this.value)" id="f-in-arrTime">
                            </div>
                            <span class="card-label">æ©Ÿå ´ (èµ·é£› âœ é™è½)</span>
                            <div class="row">
                                <input class="col" placeholder="NRT" oninput="saveFlight('in', 'depAir', this.value)" id="f-in-depAir">
                                <input class="col" placeholder="TPE" oninput="saveFlight('in', 'arrAir', this.value)" id="f-in-arrAir">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. ä½å®¿ -->
                <div id="info-hotel" class="info-sub-tab hidden">
                    <div class="card">
                        <div id="hotel-list"></div>
                        <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="openEditHotelModal()">
                            <svg class="icon-svg icon-sm"><use href="#icon-plus"></use></svg> æ–°å¢ä½å®¿
                        </button>
                    </div>
                </div>

                <!-- 3. é–€ç¥¨ -->
                <div id="info-ticket" class="info-sub-tab hidden">
                    <div class="card">
                        <div id="ticket-list"></div>
                        <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="openEditTicketModal()">
                            <svg class="icon-svg icon-sm"><use href="#icon-plus"></use></svg> æ–°å¢ç¥¨åˆ¸
                        </button>
                    </div>
                </div>

                <!-- 4. æ¸…å–® -->
                <div id="info-packing" class="info-sub-tab hidden">
                    <div class="card">
                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <input type="text" id="pack-input" placeholder="è¼¸å…¥ç‰©å“åç¨±..." style="margin:0;">
                            <button class="btn btn-primary" onclick="addPackItem()" style="width:auto;">ï¼‹</button>
                        </div>
                        <div id="list-packing"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- B. è¡Œç¨‹ -->
        <div id="tab-itinerary" class="tab-content hidden">
            <div class="sticky-header">
                <div class="header-top">
                    <button class="back-btn" onclick="goHome()">â—€</button>
                    <div class="header-title" id="header-trip-name"></div>
                    <div style="width:30px;"></div>
                </div>
                <div class="day-scroller" id="day-tabs-itinerary"></div>
            </div>
            
            <div class="container">
                <!-- å¤©æ°£å€å¡Š -->
                <div class="weather-widget">
                    <div>
                        <div class="w-loading" id="w-status">æ­£åœ¨è¼‰å…¥å¤©æ°£...</div>
                        <div class="w-info" id="w-date-loc"></div>
                    </div>
                    <div class="w-temp" id="w-temp">--Â°C</div>
                </div>

                <!-- è¡Œç¨‹åˆ—è¡¨ -->
                <div class="timeline-box">
                    <div id="list-itinerary"></div>
                </div>
            </div>
            
            <button class="fab" onclick="openNewItinerary()">
                <svg class="icon-svg"><use href="#icon-plus"></use></svg>
            </button>
        </div>

        <!-- C. è¨˜å¸³ -->
        <div id="tab-money" class="tab-content hidden">
            <div class="sticky-header">
                <div class="header-top">
                    <button class="back-btn" onclick="goHome()">â—€</button>
                    <div class="header-title">è¨˜å¸³æœ¬</div>
                    <div style="width:30px;"></div>
                </div>
            </div>
            <div class="container">
                <div class="rate-calc">
                    <div style="font-size:0.9rem; color:var(--text-light); white-space:nowrap;">åŒ¯ç‡è¨ˆç®—</div>
                    <input type="number" id="rate-amt" placeholder="å¤–å¹£" style="margin:0; width:80px;" oninput="calcRate()">
                    <select id="rate-curr" style="margin:0; width:auto;" onchange="fetchRate()">
                        <option value="JPY">JPY</option>
                        <option value="USD">USD</option>
                        <option value="KRW">KRW</option>
                        <option value="EUR">EUR</option>
                        <option value="CNY">CNY</option>
                    </select>
                    <div class="rate-res" id="rate-res">TWD 0</div>
                </div>

                <div class="day-scroller" id="day-tabs-money"></div>
                <div style="margin-top:10px; text-align:right; font-weight:bold; color:var(--text-light);">
                    ç¸½è¨ˆ: <span style="color:var(--primary); font-size:1.2rem;">$<span id="day-total">0</span></span>
                </div>
                <div id="list-money" style="margin-top:15px;"></div>
            </div>
            <button class="fab" onclick="openMoneyModal()">
                <svg class="icon-svg"><use href="#icon-plus"></use></svg>
            </button>
        </div>

        <!-- D. è³¼ç‰© -->
        <div id="tab-shopping" class="tab-content hidden">
            <div class="sticky-header">
                <div class="header-top">
                    <button class="back-btn" onclick="goHome()">â—€</button>
                    <div class="header-title">è³¼ç‰©æ¸…å–®</div>
                    <div style="width:30px;"></div>
                </div>
            </div>
            <div class="container">
                <div class="card">
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="text" id="shop-input" placeholder="æƒ³è²·ä»€éº¼..." style="margin:0;">
                        <input type="text" id="shop-price" placeholder="åƒ¹æ ¼/å‚™è¨»" style="margin:0; width:30%;">
                    </div>
                    <button class="btn btn-primary" style="width:100%;" onclick="addShoppingItem()">ï¼‹ åŠ å…¥æ¸…å–®</button>
                </div>
                <div id="list-shopping"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-create-trip" class="modal hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary);">âœ¨ å»ºç«‹æ—…ç¨‹</h3>
            <span class="card-label">åç¨±</span>
            <input type="text" id="new-trip-name" placeholder="å¦‚: æ±äº¬äº”æ—¥éŠ">
            <span class="card-label">å‡ºç™¼æ—¥æœŸ</span>
            <input type="date" id="new-trip-date">
            <span class="card-label">åœ°å€ (è‡ªå‹•æŠ“å¤©æ°£ç”¨)</span>
            <select id="new-trip-loc">
                <option value="35.6895,139.6917">æ±äº¬ (Japan)</option>
                <option value="34.6937,135.5023">å¤§é˜ª (Japan)</option>
                <option value="37.5665,126.9780">é¦–çˆ¾ (Korea)</option>
                <option value="13.7563,100.5018">æ›¼è°· (Thailand)</option>
                <option value="25.0330,121.5654">å°åŒ— (Taiwan)</option>
                <option value="custom">å…¶ä»– (é è¨­ä¸æŠ“å–)</option>
            </select>
            <span class="card-label">å¤©æ•¸</span>
            <input type="number" id="new-trip-days" value="5">
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn col" onclick="closeModal('create-trip')" style="background:#EEE; color:#888;">å–æ¶ˆ</button>
                <button class="btn btn-primary col" onclick="createNewTrip()">å»ºç«‹</button>
            </div>
        </div>
    </div>

    <div id="modal-hotel" class="modal hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary);">ğŸ¨ ä½å®¿è³‡è¨Š</h3>
            <input type="text" id="h-name" placeholder="é£¯åº—åç¨±">
            <input type="text" id="h-address" placeholder="åœ°å€">
            <input type="text" id="h-phone" placeholder="é›»è©±">
            <input type="text" id="h-order" placeholder="è¨‚å–®ç·¨è™Ÿ">
            <div class="row">
                <input type="date" id="h-date" class="col">
                <input type="number" id="h-days" class="col" placeholder="å¹¾æ™š" value="1">
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn col" onclick="closeModal('hotel')" style="background:#EEE; color:#888;">å–æ¶ˆ</button>
                <button class="btn btn-primary col" onclick="saveHotel()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="modal-ticket" class="modal hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary);">ğŸŸï¸ é–€ç¥¨è³‡è¨Š</h3>
            <input type="text" id="t-name" placeholder="ç¥¨åˆ¸åç¨±">
            <input type="date" id="t-date">
            <input type="text" id="t-order" placeholder="è¨‚å–®ç·¨è™Ÿ">
            <textarea id="t-note" placeholder="å‚™è¨»..." style="height:60px;"></textarea>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn col" onclick="closeModal('ticket')" style="background:#EEE; color:#888;">å–æ¶ˆ</button>
                <button class="btn btn-primary col" onclick="saveTicket()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="modal-itinerary" class="modal hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary);">âœ¨ è¡Œç¨‹ç´°é …</h3>
            <div class="row">
                <input type="time" id="i-time" style="flex:1">
                <select id="i-type" style="flex:1">
                    <option value="spot">åœ“é» (æ™¯é»)</option>
                    <option value="food">å‰åŒ™ (ç¾é£Ÿ)</option>
                    <option value="shop">æè¢‹ (è³¼ç‰©)</option>
                    <option value="transport">è»Šå­ (äº¤é€š)</option>
                    <option value="other">æ˜Ÿè™Ÿ (å…¶ä»–)</option>
                </select>
            </div>
            <input type="text" id="i-title" placeholder="åç¨±">
            <input type="text" id="i-loc" placeholder="åœ°é» (Google Maps)">
            <textarea id="i-note" placeholder="å‚™è¨»..." style="height:60px;"></textarea>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn col" onclick="closeModal('itinerary')" style="background:#EEE; color:#888;">å–æ¶ˆ</button>
                <button class="btn btn-primary col" onclick="saveItinerary()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="modal-money" class="modal hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary);">ğŸ’° è¨˜ä¸€ç­†</h3>
            <input type="date" id="m-date">
            <input type="text" id="m-title" placeholder="é …ç›®">
            <div class="row">
                <select id="m-curr" style="width:80px;"><option value="NT">NT</option><option value="JP">JP</option><option value="KR">KR</option><option value="$">$</option></select>
                <input type="number" id="m-cost" placeholder="é‡‘é¡">
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn col" onclick="closeModal('money')" style="background:#EEE; color:#888;">å–æ¶ˆ</button>
                <button class="btn btn-primary col" onclick="saveMoney()">å„²å­˜</button>
            </div>
        </div>
    </div>

<script>
    const DB_KEY = 'trip_v17_final';
    let allTrips = [];
    let currentTrip = null;
    let appState = { dayIdx: 0, editId: null, editType: '' };
    let currentRate = 0;

    window.onload = function() {
        const saved = localStorage.getItem(DB_KEY);
        if (saved) { try { allTrips = JSON.parse(saved); } catch(e) {} }
        renderHome();
    };
    function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(allTrips)); }

    // --- ä¸»ç•«é¢ ---
    function renderHome() {
        document.getElementById('view-home').classList.remove('hidden');
        document.getElementById('view-detail').classList.add('hidden');
        const list = document.getElementById('trip-list-container');
        list.innerHTML = '';
        allTrips.forEach(t => {
            const div = document.createElement('div');
            div.className = 'card';
            div.onclick = () => openTrip(t.id);
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h3 style="margin:0; color:var(--primary-dark);">${t.name}</h3>
                        <div style="font-size:0.9rem; color:var(--text-light); margin-top:5px;">ğŸ“… ${t.startDate} (${t.days}å¤©)</div>
                    </div>
                    <button class="btn-del" onclick="deleteTrip(event, ${t.id})">åˆªé™¤</button>
                </div>`;
            list.appendChild(div);
        });
        if(allTrips.length === 0) list.innerHTML = '<div style="text-align:center; color:#CCC;">å°šæœªå»ºç«‹æ—…ç¨‹</div>';
    }

    function createNewTrip() {
        const name = document.getElementById('new-trip-name').value;
        const date = document.getElementById('new-trip-date').value;
        const days = parseInt(document.getElementById('new-trip-days').value);
        const loc = document.getElementById('new-trip-loc').value;
        if(!name || !date || !days) return alert('è«‹å¡«å¯«å®Œæ•´');
        allTrips.push({
            id: Date.now(), name, startDate: date, days, loc,
            itinerary: [], money: [], shopping: [], packing: [],
            flights: { out:{}, in:{} }, hotels: [], tickets: []
        });
        saveData(); closeModal('create-trip'); renderHome();
    }
    
    function deleteTrip(e, id) {
        e.stopPropagation();
        if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { allTrips = allTrips.filter(t => t.id !== id); saveData(); renderHome(); }
    }

    // --- é€²å…¥æ—…ç¨‹ ---
    function openTrip(id) {
        currentTrip = allTrips.find(t => t.id === id);
        // åˆå§‹åŒ–
        if(!currentTrip.flights) currentTrip.flights = { out:{}, in:{} };
        if(!currentTrip.hotels) currentTrip.hotels = [];
        if(!currentTrip.tickets) currentTrip.tickets = [];
        if(!currentTrip.loc) currentTrip.loc = 'custom';

        document.getElementById('view-home').classList.add('hidden');
        document.getElementById('view-detail').classList.remove('hidden');
        document.getElementById('header-trip-name').innerText = currentTrip.name;
        
        appState.dayIdx = 0;
        switchTab('info');
        switchInfoSub('flight');
        renderPacking();
        renderAllDetail();
        fillFlightInputs();
        fetchRate(); 
    }
    function goHome() { currentTrip = null; renderHome(); }
    function openCreateTripModal() { openModal('create-trip'); }

    // --- Tabs ---
    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById('tab-' + tab).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const idx = tab === 'info' ? 0 : tab === 'itinerary' ? 1 : tab === 'money' ? 2 : 3;
        document.querySelectorAll('.nav-item')[idx].classList.add('active');
    }

    function switchInfoSub(sub) {
        document.querySelectorAll('.info-sub-tab').forEach(el => el.classList.add('hidden'));
        document.getElementById('info-' + sub).classList.remove('hidden');
        document.querySelectorAll('.sub-nav-btn').forEach(el => el.classList.remove('active'));
        const btnIdx = sub === 'flight' ? 0 : sub === 'hotel' ? 1 : sub === 'ticket' ? 2 : 3;
        document.querySelectorAll('.sub-nav-btn')[btnIdx].classList.add('active');
        if(sub === 'hotel') renderHotels();
        if(sub === 'ticket') renderTickets();
    }

    // --- Weather ---
    async function fetchWeather() {
        if (!currentTrip.loc || currentTrip.loc === 'custom') {
            document.getElementById('w-status').innerText = "æœªè¨­å®šè‡ªå‹•å¤©æ°£åœ°å€";
            document.getElementById('w-temp').innerText = "--";
            return;
        }
        const [lat, lon] = currentTrip.loc.split(',');
        const targetDate = new Date(currentTrip.startDate);
        targetDate.setDate(targetDate.getDate() + appState.dayIdx);
        const dateStr = targetDate.toISOString().split('T')[0];
        document.getElementById('w-date-loc').innerText = `${dateStr}`;
        document.getElementById('w-status').innerText = "æ›´æ–°å¤©æ°£ä¸­...";

        try {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset,weathercode&timezone=auto&start_date=${dateStr}&end_date=${dateStr}`;
            const res = await fetch(url);
            const data = await res.json();
            if (data.daily && data.daily.time.length > 0) {
                const max = data.daily.temperature_2m_max[0];
                const min = data.daily.temperature_2m_min[0];
                const code = data.daily.weathercode[0];
                const sr = data.daily.sunrise[0].split('T')[1];
                const ss = data.daily.sunset[0].split('T')[1];
                let wText = "æ™´æœ—";
                if(code > 3) wText = "å¤šé›²"; if(code > 50) wText = "æœ‰é›¨"; if(code > 70) wText = "é›·é›¨";
                document.getElementById('w-status').innerText = `${wText} (æ—¥å‡º${sr} æ—¥è½${ss})`;
                document.getElementById('w-temp').innerText = `${Math.round((max+min)/2)}Â°C`;
            } else {
                document.getElementById('w-status').innerText = "ç„¡è³‡æ–™ (åƒ…æ”¯æ´è¿‘æœŸ)";
            }
        } catch(e) { document.getElementById('w-status').innerText = "å¤©æ°£è¼‰å…¥å¤±æ•—"; }
    }

    // --- Flight ---
    function calcDuration(start, end) {
        if(!start || !end) return "";
        let [h1, m1] = start.split(':').map(Number);
        let [h2, m2] = end.split(':').map(Number);
        let min1 = h1 * 60 + m1;
        let min2 = h2 * 60 + m2;
        if (min2 < min1) min2 += 24 * 60; // è·¨æ—¥
        let diff = min2 - min1;
        let h = Math.floor(diff / 60);
        let m = diff % 60;
        return `${h}h ${m}m`;
    }

    function fillFlightInputs() {
        const f = currentTrip.flights;
        ['code','airline','depTime','depAir','arrTime','arrAir'].forEach(k => {
            const elOut = document.getElementById('f-out-'+k); if(elOut) elOut.value = f.out[k] || '';
            const elIn = document.getElementById('f-in-'+k); if(elIn) elIn.value = f.in[k] || '';
        });
    }
    function saveFlight(dir, field, val) {
        if(!currentTrip.flights[dir]) currentTrip.flights[dir] = {};
        currentTrip.flights[dir][field] = val; saveData();
    }

    // --- Hotel ---
    function openEditHotelModal(id = null) {
        appState.editId = id; appState.editType = 'hotels';
        if (id) {
            const h = currentTrip.hotels.find(x => x.id === id);
            document.getElementById('h-name').value = h.name;
            document.getElementById('h-address').value = h.address;
            document.getElementById('h-phone').value = h.phone;
            document.getElementById('h-order').value = h.order;
            document.getElementById('h-date').value = h.date;
            document.getElementById('h-days').value = h.days;
        } else {
            ['h-name','h-address','h-phone','h-order','h-date'].forEach(k => document.getElementById(k).value='');
            document.getElementById('h-days').value = 1;
        }
        openModal('hotel');
    }
    function saveHotel() {
        const name = document.getElementById('h-name').value;
        if (!name) return;
        const data = {
            id: appState.editId || Date.now(), name,
            address: document.getElementById('h-address').value,
            phone: document.getElementById('h-phone').value,
            order: document.getElementById('h-order').value,
            date: document.getElementById('h-date').value,
            days: document.getElementById('h-days').value
        };
        if (appState.editId) {
            const idx = currentTrip.hotels.findIndex(x => x.id === appState.editId);
            if (idx !== -1) currentTrip.hotels[idx] = data;
        } else { currentTrip.hotels.push(data); }
        saveData(); closeModal('hotel'); renderHotels();
    }
    function renderHotels() {
        const list = document.getElementById('hotel-list'); list.innerHTML = '';
        currentTrip.hotels.forEach(h => {
            list.innerHTML += `
                <div class="item-row">
                    <div class="item-icon"><svg class="icon-svg"><use href="#icon-home"></use></svg></div>
                    <div class="item-content">
                        <div class="item-title">${h.name}</div>
                        <div class="item-desc">ğŸ“ ${h.address}<br>ğŸ“… ${h.date} (${h.days}æ™š)</div>
                    </div>
                    <div style="display:flex;">
                        <button class="btn-edit" onclick="openEditHotelModal(${h.id})">ç·¨è¼¯</button>
                        <button class="btn-del" onclick="delItem('hotels', ${h.id})">åˆª</button>
                    </div>
                </div>`;
        });
        if(currentTrip.hotels.length===0) list.innerHTML = '<div style="text-align:center; color:#CCC;">å°šç„¡ä½å®¿</div>';
    }

    // --- Ticket ---
    function openEditTicketModal(id = null) {
        appState.editId = id; appState.editType = 'tickets';
        if(id) {
            const t = currentTrip.tickets.find(x => x.id === id);
            document.getElementById('t-name').value = t.name;
            document.getElementById('t-date').value = t.date;
            document.getElementById('t-order').value = t.order;
            document.getElementById('t-note').value = t.note;
        } else {
            ['t-name','t-date','t-order','t-note'].forEach(k => document.getElementById(k).value='');
        }
        openModal('ticket');
    }
    function saveTicket() {
        const name = document.getElementById('t-name').value;
        if(!name) return;
        const data = {
            id: appState.editId || Date.now(), name,
            date: document.getElementById('t-date').value,
            order: document.getElementById('t-order').value,
            note: document.getElementById('t-note').value
        };
        if(appState.editId) {
            const idx = currentTrip.tickets.findIndex(x => x.id === appState.editId);
            if(idx!==-1) currentTrip.tickets[idx] = data;
        } else { currentTrip.tickets.push(data); }
        saveData(); closeModal('ticket'); renderTickets();
    }
    function renderTickets() {
        const list = document.getElementById('ticket-list'); list.innerHTML = '';
        currentTrip.tickets.forEach(t => {
            list.innerHTML += `
                <div class="item-row">
                    <div class="item-icon"><svg class="icon-svg"><use href="#icon-ticket"></use></svg></div>
                    <div class="item-content">
                        <div class="item-title">${t.name}</div>
                        <div class="item-desc">ğŸ“… ${t.date || 'æœªå®š'} Â· è¨‚å–®: ${t.order || 'ç„¡'}</div>
                    </div>
                    <div style="display:flex;">
                        <button class="btn-edit" onclick="openEditTicketModal(${t.id})">ç·¨è¼¯</button>
                        <button class="btn-del" onclick="delItem('tickets', ${t.id})">åˆª</button>
                    </div>
                </div>`;
        });
        if(currentTrip.tickets.length===0) list.innerHTML = '<div style="text-align:center; color:#CCC;">å°šç„¡é–€ç¥¨</div>';
    }

    // --- Packing ---
    function addPackItem() {
        const val = document.getElementById('pack-input').value;
        if(!val) return;
        currentTrip.packing.push({id:Date.now(), text:val, checked:false});
        saveData(); document.getElementById('pack-input').value = ''; renderPacking();
    }
    function renderPacking() {
        const list = document.getElementById('list-packing'); list.innerHTML = '';
        currentTrip.packing.forEach(item => {
            list.innerHTML += `
                <div class="check-row ${item.checked?'checked':''}">
                    <input type="checkbox" class="check-input" ${item.checked?'checked':''} onchange="toggleCheck('packing', ${item.id})">
                    <span class="check-text">${item.text}</span>
                    <button class="btn-del" style="background:transparent; border:none; color:#DDD;" onclick="delItem('packing', ${item.id})">âœ•</button>
                </div>`;
        });
    }

    // --- Itinerary ---
    function getDisplayDate(idx) {
        const d = new Date(currentTrip.startDate);
        d.setDate(d.getDate() + idx);
        const md = `${d.getMonth()+1}/${d.getDate()}`;
        const week = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
        return `${md} (${week})`;
    }

    function renderAllDetail() {
        const dayContainer = document.getElementById('day-tabs-itinerary');
        const moneyContainer = document.getElementById('day-tabs-money');
        dayContainer.innerHTML = ''; moneyContainer.innerHTML = '';
        
        for(let i=0; i<currentTrip.days; i++) {
            const txt = `D${i+1} ${getDisplayDate(i)}`;
            const btn = document.createElement('div');
            btn.className = `day-chip ${i===appState.dayIdx?'active':''}`;
            btn.innerText = txt;
            btn.onclick = () => { appState.dayIdx = i; renderAllDetail(); };
            
            const btnMoney = btn.cloneNode(true);
            btnMoney.onclick = () => { appState.dayIdx = i; renderAllDetail(); };

            dayContainer.appendChild(btn);
            moneyContainer.appendChild(btnMoney);
        }
        renderItinerary();
        renderMoney();
        fetchWeather();
    }

    function renderItinerary() {
        const list = document.getElementById('list-itinerary'); 
        list.innerHTML = '';

        // 1. æ©Ÿç¥¨å¡ç‰‡ (ç™»æ©Ÿè­‰æ¨£å¼ + é£›è¡Œæ™‚æ•¸)
        let flightData = null;
        let title = '';
        if (appState.dayIdx === 0 && currentTrip.flights.out && currentTrip.flights.out.code) {
            flightData = currentTrip.flights.out; title = 'OUTBOUND å»ç¨‹';
        } else if (appState.dayIdx === (currentTrip.days - 1) && currentTrip.flights.in && currentTrip.flights.in.code) {
            flightData = currentTrip.flights.in; title = 'INBOUND å›ç¨‹';
        }

        if (flightData) {
            const duration = calcDuration(flightData.depTime, flightData.arrTime);
            list.innerHTML += `
                <div class="bp-card">
                    <div class="bp-header"><span>${title}</span><span>${flightData.airline || ''}</span></div>
                    <div class="bp-body">
                        <div class="bp-col">
                            <span class="bp-code">${flightData.depAir || 'DEP'}</span>
                            <div class="bp-time">${flightData.depTime || '--:--'}</div>
                        </div>
                        <div class="bp-center">
                            <span class="bp-duration">${duration}</span>
                            <div class="bp-line-icon"><span class="bp-plane-icon"><svg class="icon-svg icon-sm"><use href="#icon-plane-line"></use></svg></span></div>
                            <span style="font-weight:bold; color:var(--primary); font-size:0.9rem;">${flightData.code || ''}</span>
                        </div>
                        <div class="bp-col">
                            <span class="bp-code">${flightData.arrAir || 'ARR'}</span>
                            <div class="bp-time">${flightData.arrTime || '--:--'}</div>
                        </div>
                    </div>
                </div>`;
        }

        // 2. è¡Œç¨‹æ™‚é–“è»¸
        const items = currentTrip.itinerary.filter(i => i.dayIdx === appState.dayIdx);
        const iconMap = { spot:'icon-spot', food:'icon-food', shop:'icon-shop', transport:'icon-transport', other:'icon-other' };
        
        items.forEach(item => {
            const mapBtn = item.loc ? `<button class="btn-edit" style="background:none;" onclick="openMap(event, '${item.loc}')"><svg class="icon-svg icon-sm"><use href="#icon-pin"></use></svg></button>` : '';
            const iconId = iconMap[item.type] || 'icon-other';
            // äº¤é€šé¡åˆ¥ç‰¹æ®Šæ¨£å¼
            const extraClass = item.type === 'transport' ? 'transport' : '';

            list.innerHTML += `
                <div class="timeline-item" onclick="editItinerary(${item.id})">
                    <div class="time-badge">${item.time}</div>
                    <div class="it-card ${extraClass}">
                        <div class="it-icon-box"><svg class="icon-svg icon-sm"><use href="#${iconId}"></use></svg></div>
                        <div style="flex:1;">
                            <div style="font-weight:bold; color:var(--text);">${item.title}</div>
                            <div style="font-size:0.85rem; color:var(--text-light); margin-top:2px;">${item.note || ''}</div>
                        </div>
                        ${mapBtn}
                    </div>
                </div>`;
        });
        if(!flightData && items.length===0) list.innerHTML += '<div style="color:#CCC; text-align:center; padding:20px;">å°šç„¡è¡Œç¨‹</div>';

        // 3. åº•éƒ¨ä½å®¿ (è‡ªå‹•æŠ“å–ç•¶æ—¥)
        const targetDate = new Date(currentTrip.startDate);
        targetDate.setDate(targetDate.getDate() + appState.dayIdx);
        const dateStr = targetDate.toISOString().split('T')[0];
        
        // æœå°‹ç•¶å¤©æ˜¯å¦æœ‰ä½å®¿ (ç°¡å–®é‚è¼¯ï¼šå…¥ä½æ—¥ <= ç•¶å¤© < å…¥ä½æ—¥+å¤©æ•¸)
        // ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œé€™è£¡å…ˆç”¨å®Œå…¨æ¯”å°æ—¥æœŸï¼Œæˆ–è€…ä½ å¯ä»¥æ“´å±•é‚è¼¯
        const hotel = currentTrip.hotels.find(h => h.date === dateStr);
        if(hotel) {
            list.innerHTML += `
                <div class="hotel-footer">
                    <svg class="icon-svg"><use href="#icon-home"></use></svg>
                    <div>
                        <div style="font-weight:bold; font-size:0.9rem;">ä»Šæ™šä½å®¿ï¼š${hotel.name}</div>
                        <div style="font-size:0.8rem; opacity:0.8;">${hotel.address || 'ç„¡åœ°å€'}</div>
                    </div>
                </div>`;
        }
    }

    function openNewItinerary() {
        appState.editId = null;
        document.getElementById('modal-title-itinerary').innerText = "âœ¨ æ–°å¢è¡Œç¨‹";
        ['i-time','i-title','i-loc','i-note'].forEach(id=>document.getElementById(id).value='');
        openModal('itinerary');
    }
    function editItinerary(id) {
        const item = currentTrip.itinerary.find(i => i.id === id);
        if(!item) return;
        appState.editId = id;
        document.getElementById('modal-title-itinerary').innerText = "âœï¸ ç·¨è¼¯è¡Œç¨‹";
        document.getElementById('i-time').value = item.time;
        document.getElementById('i-type').value = item.type;
        document.getElementById('i-title').value = item.title;
        document.getElementById('i-loc').value = item.loc;
        document.getElementById('i-note').value = item.note || '';
        openModal('itinerary');
    }
    function saveItinerary() {
        const time = document.getElementById('i-time').value;
        const title = document.getElementById('i-title').value;
        if(!time || !title) return;
        
        const newData = {
            id: appState.editId || Date.now(), dayIdx: appState.dayIdx, time,
            type: document.getElementById('i-type').value, title,
            loc: document.getElementById('i-loc').value, note: document.getElementById('i-note').value
        };

        if(appState.editId) {
            const idx = currentTrip.itinerary.findIndex(i => i.id === appState.editId);
            if(idx!==-1) currentTrip.itinerary[idx] = newData;
        } else { currentTrip.itinerary.push(newData); }
        currentTrip.itinerary.sort((a,b)=>a.time.localeCompare(b.time));
        saveData(); closeModal('itinerary'); renderItinerary();
    }

    // --- Money & Rate ---
    async function fetchRate() {
        const curr = document.getElementById('rate-curr').value;
        try {
            const res = await fetch(`https://api.exchangerate-api.com/v4/latest/TWD`);
            const data = await res.json();
            if (data.rates && data.rates[curr]) {
                currentRate = 1 / data.rates[curr]; 
                calcRate();
            }
        } catch(e) {}
    }
    function calcRate() {
        const amt = parseFloat(document.getElementById('rate-amt').value) || 0;
        document.getElementById('rate-res').innerText = `TWD ${(amt * currentRate).toFixed(0)}`;
    }

    function openMoneyModal() {
        document.getElementById('m-title').value = '';
        document.getElementById('m-cost').value = '';
        const d = new Date(currentTrip.startDate); d.setDate(d.getDate() + appState.dayIdx);
        document.getElementById('m-date').value = d.toISOString().split('T')[0];
        openModal('money');
    }
    function saveMoney() {
        const title = document.getElementById('m-title').value;
        const cost = document.getElementById('m-cost').value;
        if(!title || !cost) return;

        currentTrip.money.push({
            id: Date.now(), dayIdx: appState.dayIdx,
            date: document.getElementById('m-date').value,
            title, cost: parseFloat(cost), curr: document.getElementById('m-curr').value
        });
        saveData(); closeModal('money'); renderMoney();
    }
    function renderMoney() {
        const list = document.getElementById('list-money'); list.innerHTML = '';
        const items = currentTrip.money.filter(i => i.dayIdx === appState.dayIdx);
        let total = 0; items.forEach(i => total += i.cost);
        [...items].reverse().forEach(item => {
            list.innerHTML += `
                <div class="item-row" style="background:white; padding:15px; border-radius:12px; border:1px solid #EEE; margin-bottom:10px;">
                    <div style="flex:1;">
                        <div style="font-weight:bold; color:var(--text);">${item.title}</div>
                        <div style="font-size:0.8rem; color:var(--text-light);">${item.date}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:900; color:var(--primary);">${item.curr} ${item.cost}</div>
                        <button class="btn-del" style="background:transparent; color:#CCC; font-size:1.2rem; padding:0;" onclick="delItem('money', ${item.id})">Ã—</button>
                    </div>
                </div>`;
        });
        document.getElementById('day-total').innerText = total.toLocaleString();
    }

    // --- Shopping ---
    function addShoppingItem() {
        const input = document.getElementById('shop-input');
        const price = document.getElementById('shop-price');
        if(!input.value) return;
        currentTrip.shopping.push({ id:Date.now(), text:input.value, price:price.value, checked:false });
        saveData(); input.value = ''; price.value = ''; renderShopping();
    }
    function renderShopping() {
        const list = document.getElementById('list-shopping'); list.innerHTML = '';
        currentTrip.shopping.forEach(item => {
            list.innerHTML += `
                <div class="check-row" style="padding:15px;">
                    <div style="flex:1;">
                        <div style="font-weight:bold; color:var(--text);">${item.text}</div>
                        <div style="font-size:0.85rem; color:var(--text-light);">${item.price||''}</div>
                    </div>
                    <button class="btn-del" onclick="delItem('shopping', ${item.id})">ç§»é™¤</button>
                </div>`;
        });
    }

    // --- Utils ---
    function openMap(e, loc) { e.stopPropagation(); window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`, '_blank'); }
    function toggleCheck(type, id) { const i = currentTrip[type].find(x => x.id === id); if(i) { i.checked = !i.checked; saveData(); type==='packing'?renderPacking():renderShopping(); } }
    function delItem(type, id) { if(!confirm('åˆªé™¤ï¼Ÿ')) return; currentTrip[type] = currentTrip[type].filter(x => x.id !== id); saveData(); if(type==='hotels') renderHotels(); else if(type==='tickets') renderTickets(); else if(type==='packing') renderPacking(); else if(type==='money') renderMoney(); else if(type==='shopping') renderShopping(); }
    function closeModal(id) { document.getElementById('modal-'+id).classList.add('hidden'); }
    function openModal(id) { document.getElementById('modal-'+id).classList.remove('hidden'); }
</script>
</body>
</html>
